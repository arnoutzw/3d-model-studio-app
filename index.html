<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>3D Model Viewer</title>
  <meta name="description" content="View and inspect STL and 3MF 3D printing files in the browser">
  <meta name="theme-color" content="#09090b">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <link rel="apple-touch-icon" href="icon.svg">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          }
        }
      }
    }
  </script>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/"
    }
  }
  </script>

  <style>
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #18181b; }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }
    canvas { display: block; outline: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .anim-spin { animation: spin 1s linear infinite; }
    @keyframes toast-in {
      from { transform: translateX(120%); opacity: 0; }
      to   { transform: translateX(0); opacity: 1; }
    }
    .toast-enter { animation: toast-in 0.3s ease-out forwards; }
    @keyframes pulse-border {
      0%, 100% { border-color: rgba(245,158,11,0.3); }
      50%      { border-color: rgba(245,158,11,0.7); }
    }
    .drag-pulse { animation: pulse-border 1s ease-in-out infinite; }
    /* Toggle switch styles */
    .toggle-track { transition: background-color 0.2s; }
    .toggle-dot   { transition: left 0.2s; }
    input:checked ~ .toggle-track { background-color: #f59e0b; }
    input:checked ~ .toggle-dot   { left: 14px; }
  </style>
</head>

<body class="bg-zinc-950 text-zinc-100 font-sans overflow-hidden select-none">

  <!-- ===== HEADER ===== -->
  <header class="sticky top-0 z-40 bg-zinc-900/80 backdrop-blur-sm border-b border-zinc-800">
    <div class="px-4 py-2.5 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3 min-w-0">
        <div class="flex gap-1.5 flex-shrink-0">
          <div class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
          <div class="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
          <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
        </div>
        <h1 class="font-mono font-bold text-amber-500 text-sm truncate">3D Model Viewer</h1>
        <span id="file-badge" class="hidden text-xs px-2 py-0.5 bg-amber-500/10 text-amber-400 rounded font-mono truncate max-w-[200px]"></span>
      </div>
      <div class="flex items-center gap-1.5 flex-shrink-0">
        <button id="btn-open" class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Open
        </button>
        <input type="file" id="file-input" class="hidden" accept=".stl,.3mf">
        <button id="btn-screenshot" class="text-zinc-400 hover:text-amber-400 hover:bg-zinc-800 p-1.5 rounded-lg transition-colors" title="Screenshot (S)">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </button>
        <button id="btn-panel" class="text-zinc-400 hover:text-amber-400 hover:bg-zinc-800 p-1.5 rounded-lg transition-colors" title="Toggle panel (P)">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
        </button>
        <button id="btn-install" class="hidden bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors">Install</button>
      </div>
    </div>
  </header>

  <!-- ===== MAIN ===== -->
  <main class="flex" style="height:calc(100vh - 45px)">

    <!-- Viewport -->
    <div id="viewport" class="flex-1 relative bg-zinc-950 overflow-hidden">

      <!-- Empty state -->
      <div id="empty-state" class="absolute inset-0 flex items-center justify-center pointer-events-none z-[5]">
        <div class="text-center p-8">
          <svg class="w-16 h-16 mx-auto text-zinc-700 mb-4" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/>
          </svg>
          <p class="font-mono text-zinc-500 text-sm mb-1">Drop STL or 3MF file here</p>
          <p class="text-xs text-zinc-600">or click <span class="text-amber-500/70 font-mono">Open</span> to browse</p>
        </div>
      </div>

      <!-- Drag overlay -->
      <div id="drag-overlay" class="absolute inset-4 hidden items-center justify-center bg-zinc-950/90 backdrop-blur-sm border-2 border-dashed border-amber-500/50 rounded-xl z-20 drag-pulse">
        <div class="text-center">
          <svg class="w-10 h-10 mx-auto text-amber-500 mb-2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          <p class="font-mono text-amber-400 text-sm">Drop to load model</p>
        </div>
      </div>

      <!-- Loading overlay -->
      <div id="loading-overlay" class="absolute inset-0 hidden items-center justify-center bg-zinc-950/80 backdrop-blur-sm z-20">
        <div class="text-center">
          <svg class="w-8 h-8 mx-auto text-amber-500 anim-spin mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 2v4m0 12v4m-7.07-3.93l2.83-2.83m8.48-8.48l2.83-2.83M2 12h4m12 0h4m-3.93 7.07l-2.83-2.83M6.34 6.34L3.51 3.51"/>
          </svg>
          <p class="font-mono text-zinc-400 text-xs">Loading model…</p>
        </div>
      </div>

      <!-- FPS overlay -->
      <div id="fps-overlay" class="absolute bottom-2 left-3 text-[10px] font-mono text-zinc-700"></div>

      <!-- Controls hint -->
      <div id="controls-hint" class="absolute bottom-2 right-3 text-[10px] font-mono text-zinc-700 hidden">
        LMB Rotate · RMB Pan · Scroll Zoom
      </div>
    </div>

    <!-- ===== SIDE PANEL ===== -->
    <aside id="panel" class="w-[268px] border-l border-zinc-800 bg-zinc-900 overflow-y-auto flex-shrink-0">
      <div class="p-4 space-y-4">

        <!-- Model Info -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2.5">Model Info</h3>
          <div id="model-info" class="space-y-1.5 text-xs font-mono">
            <p class="text-zinc-600 italic">No model loaded</p>
          </div>
        </section>

        <hr class="border-zinc-800">

        <!-- View Controls -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2.5">View</h3>
          <div class="space-y-2">
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Grid</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-grid" class="sr-only" checked>
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Axes</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-axes" class="sr-only" checked>
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Wireframe</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-wire" class="sr-only">
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Auto-rotate</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-rotate" class="sr-only">
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Flat shading</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-flat" class="sr-only">
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
          </div>
        </section>

        <hr class="border-zinc-800">

        <!-- Material -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2.5">Material</h3>
          <div class="space-y-3">
            <div>
              <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Color</label>
              <div class="flex gap-1.5 flex-wrap">
                <button data-color="#a0a0a8" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#a0a0a8" title="Gray"></button>
                <button data-color="#f59e0b" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#f59e0b" title="Amber"></button>
                <button data-color="#3b82f6" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#3b82f6" title="Blue"></button>
                <button data-color="#22c55e" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#22c55e" title="Green"></button>
                <button data-color="#ef4444" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#ef4444" title="Red"></button>
                <button data-color="#ffffff" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#ffffff" title="White"></button>
                <button data-color="#1a1a2e" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#1a1a2e" title="Dark"></button>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-1"><label class="text-[10px] text-zinc-500 font-mono">Roughness</label><span id="val-rough" class="text-[10px] text-zinc-600 font-mono">0.50</span></div>
              <input type="range" id="sld-rough" min="0" max="100" value="50" class="w-full h-1 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-amber-500">
            </div>
            <div>
              <div class="flex justify-between mb-1"><label class="text-[10px] text-zinc-500 font-mono">Metalness</label><span id="val-metal" class="text-[10px] text-zinc-600 font-mono">0.15</span></div>
              <input type="range" id="sld-metal" min="0" max="100" value="15" class="w-full h-1 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-amber-500">
            </div>
          </div>
        </section>

        <hr class="border-zinc-800">

        <!-- Actions -->
        <section class="space-y-1.5">
          <button id="btn-reset" class="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-xs font-mono px-3 py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
            Reset View
          </button>
          <button id="btn-fit" class="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-xs font-mono px-3 py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
            Fit to View
          </button>
        </section>

        <hr class="border-zinc-800">

        <!-- Shortcuts -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2">Shortcuts</h3>
          <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-0.5 text-[11px] font-mono">
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">R</kbd><span class="text-zinc-500">Reset view</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">F</kbd><span class="text-zinc-500">Fit to view</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">W</kbd><span class="text-zinc-500">Wireframe</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">G</kbd><span class="text-zinc-500">Grid</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">A</kbd><span class="text-zinc-500">Axes</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">⎵</kbd><span class="text-zinc-500">Auto-rotate</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">S</kbd><span class="text-zinc-500">Screenshot</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">P</kbd><span class="text-zinc-500">Panel</span>
          </div>
        </section>

      </div>
    </aside>
  </main>

  <!-- Toast container -->
  <div id="toasts" class="fixed top-14 right-4 z-50 space-y-2 pointer-events-none"></div>

  <!-- ===== THREE.JS APP ===== -->
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { STLLoader }     from 'three/addons/loaders/STLLoader.js';
    import { ThreeMFLoader } from 'three/addons/loaders/3MFLoader.js';

    /* ── state ── */
    let scene, camera, renderer, controls;
    let gridHelper, axesHelper;
    let currentModel = null;
    let modelMeshes  = [];
    let defaultMat;
    let frameCount = 0, lastFps = 0, fpsTime = 0;

    /* ── DOM refs ── */
    const $  = id => document.getElementById(id);
    const viewport      = $('viewport');
    const emptyState     = $('empty-state');
    const dragOverlay    = $('drag-overlay');
    const loadingOverlay = $('loading-overlay');
    const fpsOverlay     = $('fps-overlay');
    const controlsHint   = $('controls-hint');
    const modelInfo      = $('model-info');
    const fileBadge      = $('file-badge');
    const panel          = $('panel');
    const toastsEl       = $('toasts');

    const fileInput  = $('file-input');
    const chkGrid    = $('chk-grid');
    const chkAxes    = $('chk-axes');
    const chkWire    = $('chk-wire');
    const chkRotate  = $('chk-rotate');
    const chkFlat    = $('chk-flat');
    const sldRough   = $('sld-rough');
    const sldMetal   = $('sld-metal');

    /* ── helpers ── */
    function toast(msg, type = 'info', ms = 3000) {
      const c = { info: 'border-amber-500/50', error: 'border-red-500/50', success: 'border-green-500/50' };
      const el = document.createElement('div');
      el.className = `toast-enter ${c[type]} border bg-zinc-900 rounded-lg px-4 py-2 text-xs font-mono text-zinc-300 shadow-lg max-w-xs`;
      el.textContent = msg;
      toastsEl.appendChild(el);
      setTimeout(() => { el.style.transition = 'opacity .3s'; el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, ms);
    }

    function fmtSize(b) {
      if (b < 1024) return b + ' B';
      if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
      return (b / 1048576).toFixed(1) + ' MB';
    }

    function showLoading(v) {
      loadingOverlay.classList.toggle('hidden', !v);
      loadingOverlay.classList.toggle('flex', v);
    }

    /* ── scene setup ── */
    function initScene() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x09090b);

      camera = new THREE.PerspectiveCamera(45, viewport.clientWidth / viewport.clientHeight, 0.01, 10000);
      camera.position.set(5, 4, 5);

      renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
      renderer.setSize(viewport.clientWidth, viewport.clientHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.0;
      viewport.insertBefore(renderer.domElement, viewport.firstChild);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;
      controls.minDistance = 0.01;
      controls.maxDistance = 5000;

      // lights
      scene.add(new THREE.AmbientLight(0xffffff, 0.5));
      const d1 = new THREE.DirectionalLight(0xffffff, 0.9);
      d1.position.set(5, 8, 5);
      d1.castShadow = true;
      d1.shadow.mapSize.set(2048, 2048);
      scene.add(d1);
      const d2 = new THREE.DirectionalLight(0xffffff, 0.35);
      d2.position.set(-4, 3, -6);
      scene.add(d2);
      scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 0.25));

      // grid
      gridHelper = new THREE.GridHelper(100, 100, 0x3f3f46, 0x222228);
      scene.add(gridHelper);

      // axes
      axesHelper = new THREE.AxesHelper(3);
      scene.add(axesHelper);

      // default material
      defaultMat = new THREE.MeshStandardMaterial({
        color: 0xa0a0a8,
        roughness: 0.5,
        metalness: 0.15,
        flatShading: false,
        side: THREE.DoubleSide
      });
    }

    /* ── file handling ── */
    function handleFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      if (!['stl', '3mf'].includes(ext)) { toast('Unsupported format — use .stl or .3mf', 'error'); return; }
      showLoading(true);
      const reader = new FileReader();
      reader.onload = e => {
        try {
          if (ext === 'stl') loadSTL(e.target.result, file);
          else load3MF(e.target.result, file);
        } catch (err) {
          console.error(err);
          toast('Parse error: ' + err.message, 'error', 5000);
          showLoading(false);
        }
      };
      reader.onerror = () => { toast('Failed to read file', 'error'); showLoading(false); };
      reader.readAsArrayBuffer(file);
    }

    function loadSTL(buf, file) {
      const geom = new STLLoader().parse(buf);
      if (!geom.attributes.normal) geom.computeVertexNormals();

      clearModel();
      const mesh = new THREE.Mesh(geom, defaultMat.clone());
      mesh.castShadow = true;
      mesh.receiveShadow = true;

      const group = new THREE.Group();
      group.add(mesh);
      currentModel = group;
      modelMeshes = [mesh];
      scene.add(currentModel);

      fitToView();
      updateInfoSTL(file, geom);
      onModelLoaded(file);
    }

    function load3MF(buf, file) {
      const loader = new ThreeMFLoader();
      let object;
      try { object = loader.parse(buf); }
      catch (err) {
        console.error('3MF parse error:', err);
        toast('Could not parse 3MF — ' + err.message, 'error', 5000);
        showLoading(false);
        return;
      }

      clearModel();
      currentModel = object;
      modelMeshes = [];
      let totalVerts = 0, totalTris = 0;

      object.traverse(child => {
        if (!child.isMesh) return;
        modelMeshes.push(child);
        child.castShadow = true;
        child.receiveShadow = true;

        // apply default material if the mesh has none or plain white
        const mat = child.material;
        const isPlain = mat && !Array.isArray(mat) && mat.isMeshPhongMaterial && mat.color.getHex() === 0xffffff;
        if (!mat || isPlain) child.material = defaultMat.clone();
        if (Array.isArray(mat)) mat.forEach(m => { m.side = THREE.DoubleSide; });
        else if (child.material) child.material.side = THREE.DoubleSide;

        const g = child.geometry;
        if (g) {
          if (!g.attributes.normal) g.computeVertexNormals();
          if (g.attributes.position) totalVerts += g.attributes.position.count;
          totalTris += g.index ? g.index.count / 3 : (g.attributes.position?.count || 0) / 3;
        }
      });

      scene.add(currentModel);
      fitToView();
      updateInfo3MF(file, totalVerts, totalTris, modelMeshes.length);
      onModelLoaded(file);
    }

    function onModelLoaded(file) {
      showLoading(false);
      emptyState.classList.add('hidden');
      controlsHint.classList.remove('hidden');
      fileBadge.textContent = file.name;
      fileBadge.classList.remove('hidden');
      // sync material UI state
      applyCurrentMaterialSettings();
      toast('Loaded ' + file.name, 'success');
    }

    function clearModel() {
      if (!currentModel) return;
      scene.remove(currentModel);
      currentModel.traverse(c => {
        if (c.geometry) c.geometry.dispose();
        if (c.material) {
          (Array.isArray(c.material) ? c.material : [c.material]).forEach(m => m.dispose());
        }
      });
      currentModel = null;
      modelMeshes = [];
    }

    /* ── model processing ── */
    function fitToView() {
      if (!currentModel) return;
      const box = new THREE.Box3().setFromObject(currentModel);
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z) || 1;

      // center & sit on grid
      currentModel.position.sub(center);
      currentModel.position.y += size.y / 2;

      const fov = camera.fov * Math.PI / 180;
      const dist = maxDim / (2 * Math.tan(fov / 2)) * 2.0;

      camera.position.set(dist * 0.7, dist * 0.5, dist * 0.7);
      controls.target.set(0, size.y * 0.3, 0);
      camera.near = dist * 0.0005;
      camera.far  = dist * 100;
      camera.updateProjectionMatrix();
      controls.update();

      // rebuild grid
      const gs = Math.max(maxDim * 4, 10);
      scene.remove(gridHelper);
      gridHelper = new THREE.GridHelper(gs, Math.min(Math.round(gs), 200), 0x3f3f46, 0x222228);
      gridHelper.visible = chkGrid.checked;
      scene.add(gridHelper);

      scene.remove(axesHelper);
      axesHelper = new THREE.AxesHelper(maxDim * 0.4);
      axesHelper.visible = chkAxes.checked;
      scene.add(axesHelper);
    }

    /* ── info panels ── */
    function infoRow(label, value) {
      return `<div class="flex justify-between gap-2"><span class="text-zinc-500 shrink-0">${label}</span><span class="text-zinc-300 text-right truncate">${value}</span></div>`;
    }

    function updateInfoSTL(file, geom) {
      const box = new THREE.Box3().setFromObject(currentModel);
      const s = box.getSize(new THREE.Vector3());
      const verts = geom.attributes.position.count;
      const tris = geom.index ? geom.index.count / 3 : verts / 3;
      const vol = calcVolume(geom);

      modelInfo.innerHTML = `<div class="space-y-1.5">
        ${infoRow('File', file.name)}
        ${infoRow('Size', fmtSize(file.size))}
        ${infoRow('Format', '<span class="text-xs px-1.5 py-0.5 bg-amber-500/10 text-amber-400 rounded">STL</span>')}
        <hr class="border-zinc-800 !my-2">
        ${infoRow('Dimensions', `${s.x.toFixed(2)} × ${s.y.toFixed(2)} × ${s.z.toFixed(2)}`)}
        ${infoRow('Vertices', verts.toLocaleString())}
        ${infoRow('Triangles', Math.round(tris).toLocaleString())}
        ${vol !== null ? infoRow('Volume', vol.toFixed(1) + ' u³') : ''}
      </div>`;
    }

    function updateInfo3MF(file, verts, tris, parts) {
      const box = new THREE.Box3().setFromObject(currentModel);
      const s = box.getSize(new THREE.Vector3());
      modelInfo.innerHTML = `<div class="space-y-1.5">
        ${infoRow('File', file.name)}
        ${infoRow('Size', fmtSize(file.size))}
        ${infoRow('Format', '<span class="text-xs px-1.5 py-0.5 bg-amber-500/10 text-amber-400 rounded">3MF</span>')}
        ${infoRow('Parts', parts.toString())}
        <hr class="border-zinc-800 !my-2">
        ${infoRow('Dimensions', `${s.x.toFixed(2)} × ${s.y.toFixed(2)} × ${s.z.toFixed(2)}`)}
        ${infoRow('Vertices', verts.toLocaleString())}
        ${infoRow('Triangles', Math.round(tris).toLocaleString())}
      </div>`;
    }

    function calcVolume(geom) {
      try {
        const pos = geom.attributes.position;
        const idx = geom.index;
        let vol = 0;
        const a = new THREE.Vector3(), b = new THREE.Vector3(), c = new THREE.Vector3(), cross = new THREE.Vector3();
        const count = idx ? idx.count : pos.count;
        for (let i = 0; i < count; i += 3) {
          const i0 = idx ? idx.getX(i) : i, i1 = idx ? idx.getX(i+1) : i+1, i2 = idx ? idx.getX(i+2) : i+2;
          a.fromBufferAttribute(pos, i0);
          b.fromBufferAttribute(pos, i1);
          c.fromBufferAttribute(pos, i2);
          cross.crossVectors(b, c);
          vol += a.dot(cross) / 6;
        }
        return Math.abs(vol);
      } catch { return null; }
    }

    /* ── material controls ── */
    function forEachMat(fn) {
      modelMeshes.forEach(m => {
        (Array.isArray(m.material) ? m.material : [m.material]).forEach(fn);
      });
    }

    function applyCurrentMaterialSettings() {
      forEachMat(m => {
        m.wireframe = chkWire.checked;
        m.flatShading = chkFlat.checked;
        m.needsUpdate = true;
      });
    }

    /* ── event wiring ── */
    // file open
    $('btn-open').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => { if (fileInput.files[0]) { handleFile(fileInput.files[0]); fileInput.value = ''; } });

    // drag & drop
    let dragN = 0;
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', e => e.preventDefault());
    viewport.addEventListener('dragenter', e => { e.preventDefault(); dragN++; dragOverlay.classList.remove('hidden'); dragOverlay.classList.add('flex'); });
    viewport.addEventListener('dragover',  e => e.preventDefault());
    viewport.addEventListener('dragleave', e => { e.preventDefault(); if (--dragN <= 0) { dragN = 0; dragOverlay.classList.add('hidden'); dragOverlay.classList.remove('flex'); } });
    viewport.addEventListener('drop', e => {
      e.preventDefault(); dragN = 0;
      dragOverlay.classList.add('hidden'); dragOverlay.classList.remove('flex');
      if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });

    // toggles
    chkGrid.addEventListener('change',   () => { gridHelper.visible = chkGrid.checked; });
    chkAxes.addEventListener('change',   () => { axesHelper.visible = chkAxes.checked; });
    chkWire.addEventListener('change',   () => forEachMat(m => { m.wireframe = chkWire.checked; }));
    chkRotate.addEventListener('change', () => { controls.autoRotate = chkRotate.checked; controls.autoRotateSpeed = 2; });
    chkFlat.addEventListener('change',   () => forEachMat(m => { m.flatShading = chkFlat.checked; m.needsUpdate = true; }));

    // color swatches
    document.querySelectorAll('.clr-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.clr-btn').forEach(b => b.classList.replace('border-amber-500', 'border-zinc-700'));
        btn.classList.replace('border-zinc-700', 'border-amber-500');
        const col = new THREE.Color(btn.dataset.color);
        forEachMat(m => { m.color.copy(col); });
      });
    });
    // select first swatch
    document.querySelector('.clr-btn')?.classList.replace('border-zinc-700', 'border-amber-500');

    // sliders
    sldRough.addEventListener('input', () => { const v = sldRough.value / 100; $('val-rough').textContent = v.toFixed(2); forEachMat(m => { if (m.roughness !== undefined) m.roughness = v; }); });
    sldMetal.addEventListener('input', () => { const v = sldMetal.value / 100; $('val-metal').textContent = v.toFixed(2); forEachMat(m => { if (m.metalness !== undefined) m.metalness = v; }); });

    // buttons
    $('btn-reset').addEventListener('click', () => { camera.position.set(5, 4, 5); controls.target.set(0, 0, 0); controls.update(); if (currentModel) fitToView(); });
    $('btn-fit').addEventListener('click', fitToView);

    $('btn-screenshot').addEventListener('click', () => {
      renderer.render(scene, camera);
      const a = document.createElement('a');
      a.href = renderer.domElement.toDataURL('image/png');
      a.download = `model-${Date.now()}.png`;
      a.click();
      toast('Screenshot saved', 'success');
    });

    $('btn-panel').addEventListener('click', togglePanel);
    function togglePanel() {
      const hidden = panel.style.display === 'none';
      panel.style.display = hidden ? '' : 'none';
      onResize();
    }

    // keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
      const k = e.key.toLowerCase();
      if (k === 'r') { $('btn-reset').click(); }
      else if (k === 'f') { fitToView(); }
      else if (k === 'w') { chkWire.checked = !chkWire.checked; chkWire.dispatchEvent(new Event('change')); }
      else if (k === 'g') { chkGrid.checked = !chkGrid.checked; chkGrid.dispatchEvent(new Event('change')); }
      else if (k === 'a') { chkAxes.checked = !chkAxes.checked; chkAxes.dispatchEvent(new Event('change')); }
      else if (k === ' ') { e.preventDefault(); chkRotate.checked = !chkRotate.checked; chkRotate.dispatchEvent(new Event('change')); }
      else if (k === 's' && !e.ctrlKey && !e.metaKey) { $('btn-screenshot').click(); }
      else if (k === 'p') { togglePanel(); }
    });

    // resize
    function onResize() {
      const w = viewport.clientWidth, h = viewport.clientHeight;
      if (w === 0 || h === 0) return;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    }
    window.addEventListener('resize', onResize);
    new ResizeObserver(onResize).observe(viewport);

    // PWA install
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault(); deferredPrompt = e;
      $('btn-install').classList.remove('hidden');
    });
    $('btn-install').addEventListener('click', () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(r => {
        if (r.outcome === 'accepted') toast('App installed!', 'success');
        deferredPrompt = null;
        $('btn-install').classList.add('hidden');
      });
    });

    /* ── animation loop ── */
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
      frameCount++;
      const now = performance.now();
      if (now - fpsTime >= 1000) {
        lastFps = Math.round(frameCount * 1000 / (now - fpsTime));
        fpsOverlay.textContent = lastFps + ' FPS';
        frameCount = 0;
        fpsTime = now;
      }
    }

    /* ── init ── */
    initScene();
    animate();
    if (window.innerWidth < 768) panel.style.display = 'none';

    // handle PWA file handler launch
    if ('launchQueue' in window) {
      window.launchQueue.setConsumer(async launchParams => {
        if (launchParams.files?.length) {
          const fh = launchParams.files[0];
          const file = await fh.getFile();
          handleFile(file);
        }
      });
    }
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
