<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>3D Model Viewer</title>
  <meta name="description" content="View and inspect STL and 3MF 3D printing files in the browser">
  <meta name="theme-color" content="#09090b">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <link rel="apple-touch-icon" href="icon.svg">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          }
        }
      }
    }
  </script>

  <!-- Firebase SDK (compat for no-build usage) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>

  <!-- Shared Firebase initialisation (runs before module scripts) -->
  <script>
    // --- SSO Auth State (from parent portfolio via postMessage) ---
    window._ssoUser = null;
    window._isAdmin = false;

    window._firebaseReady = (function() {
      const config = {
        apiKey: "AIzaSyAqRWVgti-CuXzr5AkhDKmPlu7iA2MQpUg",
        authDomain: "arnout-s-homelab.firebaseapp.com",
        projectId: "arnout-s-homelab",
        storageBucket: "arnout-s-homelab.firebasestorage.app",
        messagingSenderId: "258011834485",
        appId: "1:258011834485:web:5afb1efaa303b4dd93f03c",
        measurementId: "G-VXDKDLXP7L"
      };
      try {
        firebase.initializeApp(config);
        firebase.firestore().enablePersistence({ synchronizeTabs: true }).catch(() => {});
        return firebase.auth().signInAnonymously()
          .then(() => ({ db: firebase.firestore(), storage: firebase.storage(), ok: true }))
          .catch(() => ({ db: null, storage: null, ok: false }));
      } catch(e) {
        console.error('Firebase init error:', e);
        return Promise.resolve({ db: null, storage: null, ok: false });
      }
    })();

    // --- SSO Auth Receiver (listens for parent portfolio postMessage) ---
    window.addEventListener('message', async (event) => {
      const data = event.data;
      if (!data || data.type !== 'admin-auth') return;

      window._isAdmin = !!data.isAdmin;

      if (data.sso && data.sso.idToken) {
        window._ssoUser = {
          uid: data.sso.uid,
          email: data.sso.email,
          displayName: data.sso.displayName,
          photoURL: data.sso.photoURL,
          idToken: data.sso.idToken,
        };
        // Upgrade from anonymous auth to SSO credential
        try {
          const credential = firebase.auth.GoogleAuthProvider.credential(data.sso.idToken);
          await firebase.auth().signInWithCredential(credential);
          console.log('Signed in via parent SSO:', data.sso.displayName);
          // Re-resolve _firebaseReady with authenticated state
          window._firebaseReady = Promise.resolve({
            db: firebase.firestore(),
            storage: firebase.storage(),
            ok: true,
          });
        } catch (err) {
          console.warn('SSO sign-in failed, keeping anonymous auth:', err.message);
        }
        // Notify the app of SSO user change
        window.dispatchEvent(new CustomEvent('sso-user-changed', { detail: window._ssoUser }));
      } else {
        window._ssoUser = null;
        // Sign out and fall back to anonymous auth
        try {
          await firebase.auth().signOut();
          await firebase.auth().signInAnonymously();
          window._firebaseReady = Promise.resolve({
            db: firebase.firestore(),
            storage: firebase.storage(),
            ok: true,
          });
        } catch (err) {
          console.warn('Fallback to anonymous auth failed:', err.message);
        }
        window.dispatchEvent(new CustomEvent('sso-user-changed', { detail: null }));
      }
    });
  </script>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/"
    }
  }
  </script>

  <style>
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #18181b; }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }
    canvas { display: block; outline: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .anim-spin { animation: spin 1s linear infinite; }
    @keyframes toast-in {
      from { transform: translateX(120%); opacity: 0; }
      to   { transform: translateX(0); opacity: 1; }
    }
    .toast-enter { animation: toast-in 0.3s ease-out forwards; }
    @keyframes pulse-border {
      0%, 100% { border-color: rgba(245,158,11,0.3); }
      50%      { border-color: rgba(245,158,11,0.7); }
    }
    .drag-pulse { animation: pulse-border 1s ease-in-out infinite; }
    /* Toggle switch styles */
    .toggle-track { transition: background-color 0.2s; }
    .toggle-dot   { transition: left 0.2s; }
    input:checked ~ .toggle-track { background-color: #f59e0b; }
    input:checked ~ .toggle-dot   { left: 14px; }
    /* Tab styles */
    .tab-btn { position: relative; }
    .tab-btn.active::after { content: ''; position: absolute; bottom: -2.5px; left: 0; right: 0; height: 2px; background: #f59e0b; border-radius: 1px; }
    /* Spool card */
    .spool-card { transition: transform 0.15s, box-shadow 0.15s; }
    .spool-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    /* Spool ring visualization */
    .spool-ring { border-radius: 50%; position: relative; }
    .spool-ring::after { content: ''; position: absolute; top: 30%; left: 30%; width: 40%; height: 40%; border-radius: 50%; background: #18181b; }
    /* Material badge colors */
    .mat-pla  { background: rgba(34,197,94,0.12); color: #4ade80; }
    .mat-abs  { background: rgba(239,68,68,0.12); color: #f87171; }
    .mat-petg { background: rgba(59,130,246,0.12); color: #60a5fa; }
    .mat-tpu  { background: rgba(168,85,247,0.12); color: #c084fc; }
    .mat-nylon { background: rgba(251,191,36,0.12); color: #fbbf24; }
    .mat-asa  { background: rgba(251,146,60,0.12); color: #fb923c; }
    .mat-pc   { background: rgba(45,212,191,0.12); color: #2dd4bf; }
    .mat-hips { background: rgba(156,163,175,0.12); color: #9ca3af; }
    .mat-pva  { background: rgba(129,140,248,0.12); color: #818cf8; }
    .mat-pp   { background: rgba(253,224,71,0.12); color: #fde047; }
    .mat-cf   { background: rgba(161,161,170,0.12); color: #a1a1aa; }
    .mat-wood { background: rgba(180,83,9,0.12); color: #d97706; }
    .mat-metal { background: rgba(148,163,184,0.12); color: #94a3b8; }
    .mat-pla-plus { background: rgba(16,185,129,0.12); color: #34d399; }
    .mat-silk { background: rgba(244,114,182,0.12); color: #f472b6; }
    .mat-other { background: rgba(113,113,122,0.12); color: #71717a; }
    /* Modal */
    .modal-backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    /* Weight bar */
    .weight-bar { transition: width 0.4s ease-out; }
  </style>
</head>

<body class="bg-zinc-950 text-zinc-100 font-sans overflow-hidden select-none">

  <!-- ===== HEADER ===== -->
  <header class="sticky top-0 z-40 bg-zinc-900/80 backdrop-blur-sm border-b border-zinc-800">
    <div class="px-4 py-2.5 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3 min-w-0">
        <div class="flex gap-1.5 flex-shrink-0">
          <div class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
          <div class="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
          <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
        </div>
        <h1 class="font-mono font-bold text-amber-500 text-sm truncate">Model Studio</h1>
        <span id="file-badge" class="hidden text-xs px-2 py-0.5 bg-amber-500/10 text-amber-400 rounded font-mono truncate max-w-[200px]"></span>
      </div>
      <!-- Tab navigation -->
      <div class="flex items-center gap-1 bg-zinc-800/50 rounded-lg p-0.5">
        <button id="tab-viewer" class="tab-btn active font-mono text-xs px-3 py-1.5 rounded-md transition-colors text-amber-400">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
            3D Viewer
          </span>
        </button>
        <button id="tab-dxf" class="tab-btn font-mono text-xs px-3 py-1.5 rounded-md transition-colors text-zinc-500 hover:text-zinc-300">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
            2D DXF
          </span>
        </button>
        <button id="tab-filaments" class="tab-btn font-mono text-xs px-3 py-1.5 rounded-md transition-colors text-zinc-500 hover:text-zinc-300">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="12" y1="2" x2="12" y2="8"/><line x1="12" y1="16" x2="12" y2="22"/></svg>
            Filaments
          </span>
        </button>
      </div>

      <div class="flex items-center gap-1.5 flex-shrink-0">
        <button id="btn-open" class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Open
        </button>
        <button id="btn-save-cloud" class="hidden bg-zinc-700 hover:bg-zinc-600 text-zinc-300 font-mono font-bold px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5" title="Save to cloud">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Save
        </button>
        <input type="file" id="file-input" class="hidden" accept=".stl,.3mf">
        <button id="btn-open-dxf" class="hidden bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Open DXF
        </button>
        <input type="file" id="dxf-file-input" class="hidden" accept=".dxf">
        <button id="btn-dxf-screenshot" class="hidden text-zinc-400 hover:text-amber-400 hover:bg-zinc-800 p-1.5 rounded-lg transition-colors" title="Screenshot DXF (S)">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </button>
        <button id="btn-dxf-gcode" class="hidden bg-zinc-700 hover:bg-zinc-600 text-zinc-300 font-mono font-bold px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5" title="Export G-code">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          G-code
        </button>
        <button id="btn-screenshot" class="text-zinc-400 hover:text-amber-400 hover:bg-zinc-800 p-1.5 rounded-lg transition-colors" title="Screenshot (S)">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </button>
        <button id="btn-panel" class="text-zinc-400 hover:text-amber-400 hover:bg-zinc-800 p-1.5 rounded-lg transition-colors" title="Toggle panel (P)">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
        </button>
        <!-- SSO User Info -->
        <div id="sso-user-info" class="hidden items-center gap-1.5 px-2 py-1 rounded-lg bg-zinc-800/50 border border-zinc-700/50">
          <img id="sso-user-avatar" src="" alt="" class="w-5 h-5 rounded-full border border-amber-500/30">
          <span id="sso-user-name" class="text-[11px] font-mono text-zinc-400 truncate max-w-[100px]"></span>
        </div>
        <button id="btn-install" class="hidden bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors">Install</button>
      </div>
    </div>
  </header>

  <!-- ===== MAIN: VIEWER TAB ===== -->
  <main id="view-viewer" class="flex" style="height:calc(100vh - 45px)">

    <!-- Viewport -->
    <div id="viewport" class="flex-1 relative bg-zinc-950 overflow-hidden">

      <!-- Empty state -->
      <div id="empty-state" class="absolute inset-0 flex items-center justify-center pointer-events-none z-[5]">
        <div class="text-center p-8">
          <svg class="w-16 h-16 mx-auto text-zinc-700 mb-4" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/>
          </svg>
          <p class="font-mono text-zinc-500 text-sm mb-1">Drop STL or 3MF file here</p>
          <p class="text-xs text-zinc-600">or click <span class="text-amber-500/70 font-mono">Open</span> to browse</p>
        </div>
      </div>

      <!-- Drag overlay -->
      <div id="drag-overlay" class="absolute inset-4 hidden items-center justify-center bg-zinc-950/90 backdrop-blur-sm border-2 border-dashed border-amber-500/50 rounded-xl z-20 drag-pulse">
        <div class="text-center">
          <svg class="w-10 h-10 mx-auto text-amber-500 mb-2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          <p class="font-mono text-amber-400 text-sm">Drop to load model</p>
        </div>
      </div>

      <!-- Loading overlay -->
      <div id="loading-overlay" class="absolute inset-0 hidden items-center justify-center bg-zinc-950/80 backdrop-blur-sm z-20">
        <div class="text-center">
          <svg class="w-8 h-8 mx-auto text-amber-500 anim-spin mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 2v4m0 12v4m-7.07-3.93l2.83-2.83m8.48-8.48l2.83-2.83M2 12h4m12 0h4m-3.93 7.07l-2.83-2.83M6.34 6.34L3.51 3.51"/>
          </svg>
          <p class="font-mono text-zinc-400 text-xs">Loading model…</p>
        </div>
      </div>

      <!-- FPS overlay -->
      <div id="fps-overlay" class="absolute bottom-2 left-3 text-[10px] font-mono text-zinc-700"></div>

      <!-- Controls hint -->
      <div id="controls-hint" class="absolute bottom-2 right-3 text-[10px] font-mono text-zinc-700 hidden">
        LMB Rotate · RMB Pan · Scroll Zoom
      </div>
    </div>

    <!-- ===== SIDE PANEL ===== -->
    <aside id="panel" class="w-[268px] border-l border-zinc-800 bg-zinc-900 overflow-y-auto flex-shrink-0">
      <div class="p-4 space-y-4">

        <!-- Model Info -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2.5">Model Info</h3>
          <div id="model-info" class="space-y-1.5 text-xs font-mono">
            <p class="text-zinc-600 italic">No model loaded</p>
          </div>
        </section>

        <hr class="border-zinc-800">

        <!-- Saved Models (Cloud) -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2.5">Saved Models</h3>
          <div id="saved-models-list" class="space-y-1.5 text-xs font-mono max-h-[200px] overflow-y-auto">
            <p class="text-zinc-600 italic">Connecting...</p>
          </div>
        </section>

        <hr class="border-zinc-800">

        <!-- View Controls -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2.5">View</h3>
          <div class="space-y-2">
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Grid</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-grid" class="sr-only" checked>
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Axes</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-axes" class="sr-only" checked>
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Wireframe</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-wire" class="sr-only">
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Auto-rotate</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-rotate" class="sr-only">
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Flat shading</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-flat" class="sr-only">
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
          </div>
        </section>

        <hr class="border-zinc-800">

        <!-- Material -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2.5">Material</h3>
          <div class="space-y-3">
            <div>
              <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Color</label>
              <div class="flex gap-1.5 flex-wrap">
                <button data-color="#a0a0a8" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#a0a0a8" title="Gray"></button>
                <button data-color="#f59e0b" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#f59e0b" title="Amber"></button>
                <button data-color="#3b82f6" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#3b82f6" title="Blue"></button>
                <button data-color="#22c55e" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#22c55e" title="Green"></button>
                <button data-color="#ef4444" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#ef4444" title="Red"></button>
                <button data-color="#ffffff" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#ffffff" title="White"></button>
                <button data-color="#1a1a2e" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#1a1a2e" title="Dark"></button>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-1"><label class="text-[10px] text-zinc-500 font-mono">Roughness</label><span id="val-rough" class="text-[10px] text-zinc-600 font-mono">0.50</span></div>
              <input type="range" id="sld-rough" min="0" max="100" value="50" class="w-full h-1 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-amber-500">
            </div>
            <div>
              <div class="flex justify-between mb-1"><label class="text-[10px] text-zinc-500 font-mono">Metalness</label><span id="val-metal" class="text-[10px] text-zinc-600 font-mono">0.15</span></div>
              <input type="range" id="sld-metal" min="0" max="100" value="15" class="w-full h-1 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-amber-500">
            </div>
          </div>
        </section>

        <hr class="border-zinc-800">

        <!-- Actions -->
        <section class="space-y-1.5">
          <button id="btn-reset" class="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-xs font-mono px-3 py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
            Reset View
          </button>
          <button id="btn-fit" class="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-xs font-mono px-3 py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
            Fit to View
          </button>
        </section>

        <hr class="border-zinc-800">

        <!-- Shortcuts -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2">Shortcuts</h3>
          <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-0.5 text-[11px] font-mono">
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">1</kbd><span class="text-zinc-500">3D Viewer tab</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">2</kbd><span class="text-zinc-500">2D DXF tab</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">3</kbd><span class="text-zinc-500">Filaments tab</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">R</kbd><span class="text-zinc-500">Reset view</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">F</kbd><span class="text-zinc-500">Fit to view</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">W</kbd><span class="text-zinc-500">Wireframe</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">G</kbd><span class="text-zinc-500">Grid</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">A</kbd><span class="text-zinc-500">Axes</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">⎵</kbd><span class="text-zinc-500">Auto-rotate</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">S</kbd><span class="text-zinc-500">Screenshot</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">P</kbd><span class="text-zinc-500">Panel</span>
          </div>
        </section>

      </div>
    </aside>
  </main>

  <!-- ===== MAIN: 2D DXF VIEWER TAB ===== -->
  <main id="view-dxf" class="hidden" style="height:calc(100vh - 45px)">
    <div id="dxf-viewport" class="relative w-full h-full bg-zinc-950 overflow-hidden">

      <!-- Empty state -->
      <div id="dxf-empty-state" class="absolute inset-0 flex items-center justify-center pointer-events-none z-[5]">
        <div class="text-center p-8">
          <svg class="w-16 h-16 mx-auto text-zinc-700 mb-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="3" x2="9" y2="21"/>
          </svg>
          <p class="font-mono text-zinc-500 text-sm mb-1">Drop DXF file here</p>
          <p class="text-xs text-zinc-600">or click <span class="text-amber-500/70 font-mono">Open DXF</span> to browse</p>
        </div>
      </div>

      <!-- Drag overlay -->
      <div id="dxf-drag-overlay" class="absolute inset-4 hidden items-center justify-center bg-zinc-950/90 backdrop-blur-sm border-2 border-dashed border-amber-500/50 rounded-xl z-20 drag-pulse">
        <div class="text-center">
          <svg class="w-10 h-10 mx-auto text-amber-500 mb-2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          <p class="font-mono text-amber-400 text-sm">Drop DXF file</p>
        </div>
      </div>

      <!-- Loading overlay -->
      <div id="dxf-loading" class="absolute inset-0 hidden items-center justify-center bg-zinc-950/80 backdrop-blur-sm z-20">
        <div class="text-center">
          <svg class="w-8 h-8 mx-auto text-amber-500 anim-spin mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M21 12a9 9 0 11-6.219-8.56"/>
          </svg>
          <p class="font-mono text-zinc-400 text-xs">Parsing DXF...</p>
        </div>
      </div>

      <!-- Canvas -->
      <canvas id="dxf-canvas" class="absolute inset-0 w-full h-full"></canvas>

      <!-- Info overlay -->
      <div id="dxf-info" class="hidden absolute top-3 left-3 z-10 bg-zinc-900/90 backdrop-blur-sm border border-zinc-800 rounded-lg px-3 py-2 text-[11px] font-mono text-zinc-400 space-y-0.5">
        <div>Entities: <span id="dxf-entity-count" class="text-zinc-200">0</span></div>
        <div>Layers: <span id="dxf-layer-count" class="text-zinc-200">0</span></div>
        <div>Bounds: <span id="dxf-bounds" class="text-zinc-200">-</span></div>
      </div>

      <!-- Controls overlay -->
      <div class="absolute bottom-3 left-3 z-10 flex gap-1.5">
        <button id="btn-dxf-fit" class="bg-zinc-800/90 hover:bg-zinc-700 text-zinc-400 hover:text-amber-400 border border-zinc-700 rounded-lg px-2.5 py-1.5 text-[11px] font-mono transition-colors" title="Fit to view (F)">Fit</button>
        <button id="btn-dxf-reset" class="bg-zinc-800/90 hover:bg-zinc-700 text-zinc-400 hover:text-amber-400 border border-zinc-700 rounded-lg px-2.5 py-1.5 text-[11px] font-mono transition-colors" title="Reset view (R)">Reset</button>
        <button id="btn-dxf-grid" class="bg-zinc-800/90 hover:bg-zinc-700 text-zinc-400 hover:text-amber-400 border border-zinc-700 rounded-lg px-2.5 py-1.5 text-[11px] font-mono transition-colors" title="Toggle grid (G)">Grid</button>
      </div>

      <!-- Zoom display -->
      <div id="dxf-zoom" class="absolute bottom-3 right-3 z-10 bg-zinc-800/90 border border-zinc-700 rounded-lg px-2.5 py-1 text-[10px] font-mono text-zinc-500">100%</div>

      <!-- Controls hint -->
      <div id="dxf-controls-hint" class="hidden absolute top-3 right-3 z-10 bg-zinc-900/80 border border-zinc-800 rounded-lg px-3 py-2 text-[10px] font-mono text-zinc-600">
        Scroll to zoom · Drag to pan
      </div>
    </div>
  </main>

  <!-- ===== MAIN: FILAMENT INVENTORY TAB ===== -->
  <div id="view-filaments" class="hidden" style="height:calc(100vh - 45px)">
    <div class="h-full overflow-y-auto">
      <div class="max-w-6xl mx-auto p-6">

        <!-- Header row -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
          <div>
            <h2 class="font-mono font-bold text-lg text-zinc-100">Filament Inventory</h2>
            <div class="flex items-center gap-2 mt-0.5">
              <p class="text-xs text-zinc-500 font-mono">Track your 3D printing filament stock</p>
              <span id="sync-status" class="flex items-center gap-1 text-[10px] font-mono px-1.5 py-0.5 rounded">
                <!-- Filled by JS -->
              </span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="btn-add-filament" class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2 rounded-lg text-xs transition-colors flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Filament
            </button>
          </div>
        </div>

        <!-- Stats bar -->
        <div id="filament-stats" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
          <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-3">
            <p class="text-[10px] font-mono text-zinc-500 uppercase tracking-wider">Total Spools</p>
            <p id="stat-total" class="text-xl font-mono font-bold text-zinc-100 mt-1">0</p>
          </div>
          <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-3">
            <p class="text-[10px] font-mono text-zinc-500 uppercase tracking-wider">Materials</p>
            <p id="stat-materials" class="text-xl font-mono font-bold text-zinc-100 mt-1">0</p>
          </div>
          <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-3">
            <p class="text-[10px] font-mono text-zinc-500 uppercase tracking-wider">Total Weight</p>
            <p id="stat-weight" class="text-xl font-mono font-bold text-zinc-100 mt-1">0 kg</p>
          </div>
          <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-3">
            <p class="text-[10px] font-mono text-zinc-500 uppercase tracking-wider">Colors</p>
            <p id="stat-colors" class="text-xl font-mono font-bold text-zinc-100 mt-1">0</p>
          </div>
        </div>

        <!-- Color palette overview -->
        <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-4 mb-6">
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-3">Color Palette</h3>
          <div id="color-palette" class="flex flex-wrap gap-1.5 min-h-[32px]">
            <p class="text-xs text-zinc-600 font-mono italic">No filaments yet</p>
          </div>
        </div>

        <!-- Material breakdown -->
        <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-4 mb-6">
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-3">Material Breakdown</h3>
          <div id="material-breakdown" class="space-y-2">
            <p class="text-xs text-zinc-600 font-mono italic">No filaments yet</p>
          </div>
        </div>

        <!-- Filter & search bar -->
        <div class="flex flex-col sm:flex-row gap-3 mb-4">
          <div class="relative flex-1">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-zinc-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input id="filament-search" type="text" placeholder="Search filaments..." class="w-full bg-zinc-900 border border-zinc-800 rounded-lg pl-9 pr-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50">
          </div>
          <div class="flex gap-2 flex-wrap">
            <button data-filter="all" class="filter-btn active bg-amber-500/10 text-amber-400 text-[11px] font-mono px-3 py-1.5 rounded-lg border border-amber-500/20 transition-colors">All</button>
            <div id="filter-buttons" class="flex gap-2 flex-wrap"></div>
          </div>
        </div>

        <!-- Filament grid -->
        <div id="filament-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
          <!-- Cards rendered by JS -->
        </div>

        <!-- Empty state for filaments -->
        <div id="filament-empty" class="text-center py-16">
          <svg class="w-16 h-16 mx-auto text-zinc-700 mb-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="12" y1="2" x2="12" y2="8"/><line x1="12" y1="16" x2="12" y2="22"/></svg>
          <p class="font-mono text-zinc-500 text-sm mb-1">No filaments in inventory</p>
          <p class="text-xs text-zinc-600">Click <span class="text-amber-500/70 font-mono">Add Filament</span> to get started</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ADD/EDIT FILAMENT MODAL ===== -->
  <div id="filament-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-zinc-900 border border-zinc-800 rounded-xl shadow-2xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-5">
        <div class="flex items-center justify-between mb-5">
          <h3 id="modal-title" class="font-mono font-bold text-sm text-zinc-100">Add Filament</h3>
          <button id="btn-modal-close" class="text-zinc-500 hover:text-zinc-300 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <form id="filament-form" class="space-y-4">
          <input type="hidden" id="ff-id">

          <!-- Color preview + picker -->
          <div>
            <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Color</label>
            <div class="flex items-center gap-3">
              <div id="ff-color-preview" class="w-12 h-12 rounded-lg border-2 border-zinc-700 spool-ring" style="background:#a0a0a8"></div>
              <div class="flex-1 space-y-2">
                <input type="color" id="ff-color" value="#a0a0a8" class="w-full h-8 bg-zinc-800 border border-zinc-700 rounded cursor-pointer">
                <input type="text" id="ff-color-name" placeholder="Color name (e.g. Galaxy Blue)" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-1.5 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50">
              </div>
            </div>
          </div>

          <!-- Material type -->
          <div>
            <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Material</label>
            <select id="ff-material" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-amber-500/50 appearance-none cursor-pointer">
              <optgroup label="Standard">
                <option value="PLA">PLA</option>
                <option value="PLA+">PLA+</option>
                <option value="PLA Silk">PLA Silk</option>
                <option value="ABS">ABS</option>
                <option value="PETG">PETG</option>
                <option value="TPU">TPU (Flexible)</option>
              </optgroup>
              <optgroup label="Engineering">
                <option value="Nylon">Nylon (PA)</option>
                <option value="ASA">ASA</option>
                <option value="PC">Polycarbonate (PC)</option>
                <option value="HIPS">HIPS</option>
                <option value="PVA">PVA (Soluble)</option>
                <option value="PP">Polypropylene (PP)</option>
                <option value="PEI">PEI (ULTEM)</option>
                <option value="PEEK">PEEK</option>
                <option value="PEKK">PEKK</option>
              </optgroup>
              <optgroup label="Composite">
                <option value="CF-PLA">Carbon Fiber PLA</option>
                <option value="CF-PETG">Carbon Fiber PETG</option>
                <option value="CF-Nylon">Carbon Fiber Nylon</option>
                <option value="CF-ABS">Carbon Fiber ABS</option>
                <option value="CF-PC">Carbon Fiber PC</option>
                <option value="GF-Nylon">Glass Fiber Nylon</option>
                <option value="GF-PP">Glass Fiber PP</option>
              </optgroup>
              <optgroup label="Specialty">
                <option value="Wood">Wood Fill</option>
                <option value="Metal">Metal Fill</option>
                <option value="Marble">Marble Fill</option>
                <option value="Glow">Glow-in-the-Dark</option>
                <option value="HTPLA">HT-PLA (Heat Treated)</option>
                <option value="PHA">PHA</option>
              </optgroup>
              <optgroup label="Resin (SLA/DLP)">
                <option value="Standard Resin">Standard Resin</option>
                <option value="Tough Resin">Tough Resin</option>
                <option value="Flexible Resin">Flexible Resin</option>
                <option value="Water-Washable Resin">Water-Washable Resin</option>
                <option value="ABS-Like Resin">ABS-Like Resin</option>
                <option value="Castable Resin">Castable Resin</option>
                <option value="Dental Resin">Dental Resin</option>
              </optgroup>
              <optgroup label="Other">
                <option value="Other">Other</option>
              </optgroup>
            </select>
          </div>

          <!-- Brand -->
          <div>
            <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Brand</label>
            <input type="text" id="ff-brand" placeholder="e.g. Bambu Lab, Prusament, Hatchbox..." class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50" list="brand-suggestions">
            <datalist id="brand-suggestions">
              <option value="Bambu Lab">
              <option value="Prusament">
              <option value="Hatchbox">
              <option value="eSUN">
              <option value="Overture">
              <option value="Polymaker">
              <option value="Inland">
              <option value="SUNLU">
              <option value="Creality">
              <option value="MatterHackers">
              <option value="3DXTech">
              <option value="ColorFabb">
              <option value="Fillamentum">
              <option value="Proto-pasta">
              <option value="FormFutura">
              <option value="Elegoo">
              <option value="Anycubic">
              <option value="Phrozen">
            </datalist>
          </div>

          <!-- Diameter -->
          <div>
            <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Diameter</label>
            <div class="flex gap-2">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="ff-diameter" value="1.75" checked class="accent-amber-500">
                <span class="text-xs font-mono text-zinc-300">1.75 mm</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="ff-diameter" value="2.85" class="accent-amber-500">
                <span class="text-xs font-mono text-zinc-300">2.85 mm</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="ff-diameter" value="0" class="accent-amber-500">
                <span class="text-xs font-mono text-zinc-300">Resin</span>
              </label>
            </div>
          </div>

          <!-- Weight -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Spool Weight (g)</label>
              <input type="number" id="ff-weight" placeholder="1000" min="0" max="50000" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50">
            </div>
            <div>
              <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Remaining (%)</label>
              <input type="number" id="ff-remaining" value="100" min="0" max="100" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50">
            </div>
          </div>

          <!-- Temps -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Nozzle Temp (°C)</label>
              <input type="number" id="ff-temp-nozzle" placeholder="210" min="0" max="500" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50">
            </div>
            <div>
              <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Bed Temp (°C)</label>
              <input type="number" id="ff-temp-bed" placeholder="60" min="0" max="200" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50">
            </div>
          </div>

          <!-- Notes -->
          <div>
            <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Notes</label>
            <textarea id="ff-notes" rows="2" placeholder="Optional notes..." class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50 resize-none"></textarea>
          </div>

          <!-- Buttons -->
          <div class="flex gap-2 pt-2">
            <button type="submit" class="flex-1 bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2 rounded-lg text-xs transition-colors">Save</button>
            <button type="button" id="btn-modal-cancel" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-mono px-4 py-2 rounded-lg text-xs transition-colors">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ===== DELETE CONFIRM MODAL ===== -->
  <div id="delete-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-zinc-900 border border-zinc-800 rounded-xl shadow-2xl w-full max-w-sm mx-4 p-5">
      <h3 class="font-mono font-bold text-sm text-zinc-100 mb-2">Delete Filament</h3>
      <p class="text-xs text-zinc-400 font-mono mb-5">Are you sure you want to remove this filament from your inventory? This cannot be undone.</p>
      <div class="flex gap-2">
        <button id="btn-confirm-delete" class="flex-1 bg-red-500 hover:bg-red-400 text-white font-mono font-bold px-4 py-2 rounded-lg text-xs transition-colors">Delete</button>
        <button id="btn-cancel-delete" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-mono px-4 py-2 rounded-lg text-xs transition-colors">Cancel</button>
      </div>
    </div>
  </div>

  <!-- ===== G-CODE EXPORT MODAL ===== -->
  <div id="gcode-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-zinc-900 border border-zinc-800 rounded-xl shadow-2xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-5">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-mono font-bold text-sm text-zinc-100">Export G-code</h3>
          <button id="btn-gcode-close" class="text-zinc-500 hover:text-zinc-300 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>

        <div class="space-y-4">
          <!-- Mode selector -->
          <div>
            <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Mode</label>
            <div class="flex gap-2">
              <button id="gc-mode-laser" class="flex-1 bg-amber-500/10 border border-amber-500/30 text-amber-400 font-mono px-3 py-2 rounded-lg text-xs transition-colors" data-mode="laser">Laser (Marlin)</button>
              <button id="gc-mode-cnc" class="flex-1 bg-zinc-800 border border-zinc-700 text-zinc-400 font-mono px-3 py-2 rounded-lg text-xs transition-colors" data-mode="cnc">CNC / Router</button>
            </div>
          </div>

          <!-- Laser settings -->
          <div id="gc-laser-settings">
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Laser power (S value, 0-255)</label>
                <input type="number" id="gc-laser-power" value="255" min="0" max="255" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-amber-500/50">
              </div>
              <div>
                <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Cut feed rate (mm/min)</label>
                <input type="number" id="gc-laser-feed" value="300" min="1" max="50000" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-amber-500/50">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Travel feed rate (mm/min)</label>
                <input type="number" id="gc-laser-travel" value="1500" min="1" max="50000" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-amber-500/50">
              </div>
              <div>
                <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Passes</label>
                <input type="number" id="gc-laser-passes" value="1" min="1" max="100" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-amber-500/50">
              </div>
            </div>
            <div>
              <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Laser mode</label>
              <div class="flex gap-2">
                <label class="flex items-center gap-1.5 text-xs font-mono text-zinc-400 cursor-pointer">
                  <input type="radio" name="gc-laser-mode" value="M4" checked class="accent-amber-500"> <span>M4 Dynamic (power scales with speed)</span>
                </label>
              </div>
              <div class="flex gap-2 mt-1">
                <label class="flex items-center gap-1.5 text-xs font-mono text-zinc-400 cursor-pointer">
                  <input type="radio" name="gc-laser-mode" value="M3" class="accent-amber-500"> <span>M3 Constant (fixed power)</span>
                </label>
              </div>
            </div>
          </div>

          <!-- CNC settings (hidden by default) -->
          <div id="gc-cnc-settings" class="hidden">
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Feed Rate XY (mm/min)</label>
                <input type="number" id="gc-feed-xy" value="800" min="1" max="50000" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-amber-500/50">
              </div>
              <div>
                <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Feed Rate Z (mm/min)</label>
                <input type="number" id="gc-feed-z" value="300" min="1" max="10000" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-amber-500/50">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Safe Z height (mm)</label>
                <input type="number" id="gc-safe-z" value="5" min="0" step="0.5" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-amber-500/50">
              </div>
              <div>
                <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Cut depth per pass (mm)</label>
                <input type="number" id="gc-pass-depth" value="1" min="0.1" step="0.1" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-amber-500/50">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Total depth (mm)</label>
                <input type="number" id="gc-total-depth" value="-1" max="0" step="0.5" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-amber-500/50">
              </div>
              <div>
                <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Spindle speed (RPM)</label>
                <input type="number" id="gc-spindle" value="12000" min="0" max="60000" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-amber-500/50">
              </div>
            </div>
          </div>

          <!-- Info note -->
          <div id="gc-info-note" class="bg-zinc-800/50 rounded-lg p-3 text-[11px] font-mono text-zinc-500">
            Marlin laser mode: uses M4/M3 inline laser control with S parameter. Laser turns on during G1 cuts and off during G0 travel moves. Enable <span class="text-amber-400">LASER_FEATURE</span> in Marlin firmware.
          </div>

          <!-- Buttons -->
          <div class="flex gap-2">
            <button id="btn-gcode-export" class="flex-1 bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2 rounded-lg text-xs transition-colors">Export .gcode</button>
            <button id="btn-gcode-cancel" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-mono px-4 py-2 rounded-lg text-xs transition-colors">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toasts" class="fixed top-14 right-4 z-50 space-y-2 pointer-events-none"></div>

  <!-- ===== THREE.JS APP ===== -->
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { STLLoader }     from 'three/addons/loaders/STLLoader.js';
    import { ThreeMFLoader } from 'three/addons/loaders/3MFLoader.js';

    /* ── state ── */
    let scene, camera, renderer, controls;
    let gridHelper, axesHelper;
    let currentModel = null;
    let modelMeshes  = [];
    let defaultMat;
    let frameCount = 0, lastFps = 0, fpsTime = 0;
    let currentFile = null;          // keep ref for cloud save
    let currentFileBuffer = null;    // raw ArrayBuffer for cloud save
    let fbServices = null;           // { db, storage } when Firebase is ready

    /* ── DOM refs ── */
    const $  = id => document.getElementById(id);
    const viewport      = $('viewport');
    const emptyState     = $('empty-state');
    const dragOverlay    = $('drag-overlay');
    const loadingOverlay = $('loading-overlay');
    const fpsOverlay     = $('fps-overlay');
    const controlsHint   = $('controls-hint');
    const modelInfo      = $('model-info');
    const fileBadge      = $('file-badge');
    const panel          = $('panel');
    const toastsEl       = $('toasts');

    const fileInput  = $('file-input');
    const chkGrid    = $('chk-grid');
    const chkAxes    = $('chk-axes');
    const chkWire    = $('chk-wire');
    const chkRotate  = $('chk-rotate');
    const chkFlat    = $('chk-flat');
    const sldRough   = $('sld-rough');
    const sldMetal   = $('sld-metal');

    /* ── helpers ── */
    function toast(msg, type = 'info', ms = 3000) {
      const c = { info: 'border-amber-500/50', error: 'border-red-500/50', success: 'border-green-500/50' };
      const el = document.createElement('div');
      el.className = `toast-enter ${c[type]} border bg-zinc-900 rounded-lg px-4 py-2 text-xs font-mono text-zinc-300 shadow-lg max-w-xs`;
      el.textContent = msg;
      toastsEl.appendChild(el);
      setTimeout(() => { el.style.transition = 'opacity .3s'; el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, ms);
    }

    function fmtSize(b) {
      if (b < 1024) return b + ' B';
      if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
      return (b / 1048576).toFixed(1) + ' MB';
    }

    function showLoading(v) {
      loadingOverlay.classList.toggle('hidden', !v);
      loadingOverlay.classList.toggle('flex', v);
    }

    /* ── scene setup ── */
    function initScene() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x09090b);

      camera = new THREE.PerspectiveCamera(45, viewport.clientWidth / viewport.clientHeight, 0.01, 10000);
      camera.position.set(5, 4, 5);

      renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
      renderer.setSize(viewport.clientWidth, viewport.clientHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.0;
      viewport.insertBefore(renderer.domElement, viewport.firstChild);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;
      controls.minDistance = 0.01;
      controls.maxDistance = 5000;

      // lights
      scene.add(new THREE.AmbientLight(0xffffff, 0.5));
      const d1 = new THREE.DirectionalLight(0xffffff, 0.9);
      d1.position.set(5, 8, 5);
      d1.castShadow = true;
      d1.shadow.mapSize.set(2048, 2048);
      scene.add(d1);
      const d2 = new THREE.DirectionalLight(0xffffff, 0.35);
      d2.position.set(-4, 3, -6);
      scene.add(d2);
      scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 0.25));

      // grid
      gridHelper = new THREE.GridHelper(100, 100, 0x3f3f46, 0x222228);
      scene.add(gridHelper);

      // axes
      axesHelper = new THREE.AxesHelper(3);
      scene.add(axesHelper);

      // default material
      defaultMat = new THREE.MeshStandardMaterial({
        color: 0xa0a0a8,
        roughness: 0.5,
        metalness: 0.15,
        flatShading: false,
        side: THREE.DoubleSide
      });
    }

    /* ── file handling ── */
    function handleFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      if (!['stl', '3mf'].includes(ext)) { toast('Unsupported format — use .stl or .3mf', 'error'); return; }
      currentFile = file;
      showLoading(true);
      const reader = new FileReader();
      reader.onload = e => {
        currentFileBuffer = e.target.result;
        try {
          if (ext === 'stl') loadSTL(e.target.result, file);
          else load3MF(e.target.result, file);
        } catch (err) {
          console.error(err);
          toast('Parse error: ' + err.message, 'error', 5000);
          showLoading(false);
        }
      };
      reader.onerror = () => { toast('Failed to read file', 'error'); showLoading(false); };
      reader.readAsArrayBuffer(file);
    }

    function loadSTL(buf, file) {
      const geom = new STLLoader().parse(buf);
      if (!geom.attributes.normal) geom.computeVertexNormals();

      clearModel();
      const mesh = new THREE.Mesh(geom, defaultMat.clone());
      mesh.castShadow = true;
      mesh.receiveShadow = true;

      const group = new THREE.Group();
      group.add(mesh);
      currentModel = group;
      modelMeshes = [mesh];
      scene.add(currentModel);

      fitToView();
      updateInfoSTL(file, geom);
      onModelLoaded(file);
    }

    function load3MF(buf, file) {
      const loader = new ThreeMFLoader();
      let object;
      try { object = loader.parse(buf); }
      catch (err) {
        console.error('3MF parse error:', err);
        toast('Could not parse 3MF — ' + err.message, 'error', 5000);
        showLoading(false);
        return;
      }

      clearModel();
      currentModel = object;
      modelMeshes = [];
      let totalVerts = 0, totalTris = 0;

      object.traverse(child => {
        if (!child.isMesh) return;
        modelMeshes.push(child);
        child.castShadow = true;
        child.receiveShadow = true;

        // apply default material if the mesh has none or plain white
        const mat = child.material;
        const isPlain = mat && !Array.isArray(mat) && mat.isMeshPhongMaterial && mat.color.getHex() === 0xffffff;
        if (!mat || isPlain) child.material = defaultMat.clone();
        if (Array.isArray(mat)) mat.forEach(m => { m.side = THREE.DoubleSide; });
        else if (child.material) child.material.side = THREE.DoubleSide;

        const g = child.geometry;
        if (g) {
          if (!g.attributes.normal) g.computeVertexNormals();
          if (g.attributes.position) totalVerts += g.attributes.position.count;
          totalTris += g.index ? g.index.count / 3 : (g.attributes.position?.count || 0) / 3;
        }
      });

      scene.add(currentModel);
      fitToView();
      updateInfo3MF(file, totalVerts, totalTris, modelMeshes.length);
      onModelLoaded(file);
    }

    function onModelLoaded(file) {
      showLoading(false);
      emptyState.classList.add('hidden');
      controlsHint.classList.remove('hidden');
      fileBadge.textContent = file.name;
      fileBadge.classList.remove('hidden');
      // Show save button if Firebase is available
      if (fbServices) {
        $('btn-save-cloud').classList.remove('hidden');
        $('btn-save-cloud').dataset.enabled = '1';
      }
      // sync material UI state
      applyCurrentMaterialSettings();
      toast('Loaded ' + file.name, 'success');
    }

    function clearModel() {
      if (!currentModel) return;
      scene.remove(currentModel);
      currentModel.traverse(c => {
        if (c.geometry) c.geometry.dispose();
        if (c.material) {
          (Array.isArray(c.material) ? c.material : [c.material]).forEach(m => m.dispose());
        }
      });
      currentModel = null;
      modelMeshes = [];
    }

    /* ── model processing ── */
    function fitToView() {
      if (!currentModel) return;
      const box = new THREE.Box3().setFromObject(currentModel);
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z) || 1;

      // center & sit on grid
      currentModel.position.sub(center);
      currentModel.position.y += size.y / 2;

      const fov = camera.fov * Math.PI / 180;
      const dist = maxDim / (2 * Math.tan(fov / 2)) * 2.0;

      camera.position.set(dist * 0.7, dist * 0.5, dist * 0.7);
      controls.target.set(0, size.y * 0.3, 0);
      camera.near = dist * 0.0005;
      camera.far  = dist * 100;
      camera.updateProjectionMatrix();
      controls.update();

      // rebuild grid
      const gs = Math.max(maxDim * 4, 10);
      scene.remove(gridHelper);
      gridHelper = new THREE.GridHelper(gs, Math.min(Math.round(gs), 200), 0x3f3f46, 0x222228);
      gridHelper.visible = chkGrid.checked;
      scene.add(gridHelper);

      scene.remove(axesHelper);
      axesHelper = new THREE.AxesHelper(maxDim * 0.4);
      axesHelper.visible = chkAxes.checked;
      scene.add(axesHelper);
    }

    /* ── info panels ── */
    function infoRow(label, value) {
      return `<div class="flex justify-between gap-2"><span class="text-zinc-500 shrink-0">${label}</span><span class="text-zinc-300 text-right truncate">${value}</span></div>`;
    }

    function updateInfoSTL(file, geom) {
      const box = new THREE.Box3().setFromObject(currentModel);
      const s = box.getSize(new THREE.Vector3());
      const verts = geom.attributes.position.count;
      const tris = geom.index ? geom.index.count / 3 : verts / 3;
      const vol = calcVolume(geom);

      modelInfo.innerHTML = `<div class="space-y-1.5">
        ${infoRow('File', file.name)}
        ${infoRow('Size', fmtSize(file.size))}
        ${infoRow('Format', '<span class="text-xs px-1.5 py-0.5 bg-amber-500/10 text-amber-400 rounded">STL</span>')}
        <hr class="border-zinc-800 !my-2">
        ${infoRow('Dimensions', `${s.x.toFixed(2)} × ${s.y.toFixed(2)} × ${s.z.toFixed(2)}`)}
        ${infoRow('Vertices', verts.toLocaleString())}
        ${infoRow('Triangles', Math.round(tris).toLocaleString())}
        ${vol !== null ? infoRow('Volume', vol.toFixed(1) + ' u³') : ''}
      </div>`;
    }

    function updateInfo3MF(file, verts, tris, parts) {
      const box = new THREE.Box3().setFromObject(currentModel);
      const s = box.getSize(new THREE.Vector3());
      modelInfo.innerHTML = `<div class="space-y-1.5">
        ${infoRow('File', file.name)}
        ${infoRow('Size', fmtSize(file.size))}
        ${infoRow('Format', '<span class="text-xs px-1.5 py-0.5 bg-amber-500/10 text-amber-400 rounded">3MF</span>')}
        ${infoRow('Parts', parts.toString())}
        <hr class="border-zinc-800 !my-2">
        ${infoRow('Dimensions', `${s.x.toFixed(2)} × ${s.y.toFixed(2)} × ${s.z.toFixed(2)}`)}
        ${infoRow('Vertices', verts.toLocaleString())}
        ${infoRow('Triangles', Math.round(tris).toLocaleString())}
      </div>`;
    }

    function calcVolume(geom) {
      try {
        const pos = geom.attributes.position;
        const idx = geom.index;
        let vol = 0;
        const a = new THREE.Vector3(), b = new THREE.Vector3(), c = new THREE.Vector3(), cross = new THREE.Vector3();
        const count = idx ? idx.count : pos.count;
        for (let i = 0; i < count; i += 3) {
          const i0 = idx ? idx.getX(i) : i, i1 = idx ? idx.getX(i+1) : i+1, i2 = idx ? idx.getX(i+2) : i+2;
          a.fromBufferAttribute(pos, i0);
          b.fromBufferAttribute(pos, i1);
          c.fromBufferAttribute(pos, i2);
          cross.crossVectors(b, c);
          vol += a.dot(cross) / 6;
        }
        return Math.abs(vol);
      } catch { return null; }
    }

    /* ── material controls ── */
    function forEachMat(fn) {
      modelMeshes.forEach(m => {
        (Array.isArray(m.material) ? m.material : [m.material]).forEach(fn);
      });
    }

    function applyCurrentMaterialSettings() {
      forEachMat(m => {
        m.wireframe = chkWire.checked;
        m.flatShading = chkFlat.checked;
        m.needsUpdate = true;
      });
    }

    /* ── event wiring ── */
    // file open
    $('btn-open').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => { if (fileInput.files[0]) { handleFile(fileInput.files[0]); fileInput.value = ''; } });

    // drag & drop
    let dragN = 0;
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', e => e.preventDefault());
    viewport.addEventListener('dragenter', e => { e.preventDefault(); dragN++; dragOverlay.classList.remove('hidden'); dragOverlay.classList.add('flex'); });
    viewport.addEventListener('dragover',  e => e.preventDefault());
    viewport.addEventListener('dragleave', e => { e.preventDefault(); if (--dragN <= 0) { dragN = 0; dragOverlay.classList.add('hidden'); dragOverlay.classList.remove('flex'); } });
    viewport.addEventListener('drop', e => {
      e.preventDefault(); dragN = 0;
      dragOverlay.classList.add('hidden'); dragOverlay.classList.remove('flex');
      if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });

    // toggles
    chkGrid.addEventListener('change',   () => { gridHelper.visible = chkGrid.checked; });
    chkAxes.addEventListener('change',   () => { axesHelper.visible = chkAxes.checked; });
    chkWire.addEventListener('change',   () => forEachMat(m => { m.wireframe = chkWire.checked; }));
    chkRotate.addEventListener('change', () => { controls.autoRotate = chkRotate.checked; controls.autoRotateSpeed = 2; });
    chkFlat.addEventListener('change',   () => forEachMat(m => { m.flatShading = chkFlat.checked; m.needsUpdate = true; }));

    // color swatches
    document.querySelectorAll('.clr-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.clr-btn').forEach(b => b.classList.replace('border-amber-500', 'border-zinc-700'));
        btn.classList.replace('border-zinc-700', 'border-amber-500');
        const col = new THREE.Color(btn.dataset.color);
        forEachMat(m => { m.color.copy(col); });
      });
    });
    // select first swatch
    document.querySelector('.clr-btn')?.classList.replace('border-zinc-700', 'border-amber-500');

    // sliders
    sldRough.addEventListener('input', () => { const v = sldRough.value / 100; $('val-rough').textContent = v.toFixed(2); forEachMat(m => { if (m.roughness !== undefined) m.roughness = v; }); });
    sldMetal.addEventListener('input', () => { const v = sldMetal.value / 100; $('val-metal').textContent = v.toFixed(2); forEachMat(m => { if (m.metalness !== undefined) m.metalness = v; }); });

    // buttons
    $('btn-reset').addEventListener('click', () => { camera.position.set(5, 4, 5); controls.target.set(0, 0, 0); controls.update(); if (currentModel) fitToView(); });
    $('btn-fit').addEventListener('click', fitToView);

    $('btn-screenshot').addEventListener('click', () => {
      renderer.render(scene, camera);
      const a = document.createElement('a');
      a.href = renderer.domElement.toDataURL('image/png');
      a.download = `model-${Date.now()}.png`;
      a.click();
      toast('Screenshot saved', 'success');
    });

    $('btn-panel').addEventListener('click', togglePanel);
    function togglePanel() {
      const hidden = panel.style.display === 'none';
      panel.style.display = hidden ? '' : 'none';
      onResize();
    }

    // keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
      const k = e.key.toLowerCase();
      // Tab switching: 1 = 3D Viewer, 2 = 2D DXF, 3 = Filaments
      if (k === '1') { if (window._filamentSwitchTab) window._filamentSwitchTab('viewer'); return; }
      if (k === '2') { if (window._filamentSwitchTab) window._filamentSwitchTab('dxf'); return; }
      if (k === '3') { if (window._filamentSwitchTab) window._filamentSwitchTab('filaments'); return; }
      // 3D Viewer-only shortcuts
      if (!view3DActive()) return;
      if (k === 'r') { $('btn-reset').click(); }
      else if (k === 'f') { fitToView(); }
      else if (k === 'w') { chkWire.checked = !chkWire.checked; chkWire.dispatchEvent(new Event('change')); }
      else if (k === 'g') { chkGrid.checked = !chkGrid.checked; chkGrid.dispatchEvent(new Event('change')); }
      else if (k === 'a') { chkAxes.checked = !chkAxes.checked; chkAxes.dispatchEvent(new Event('change')); }
      else if (k === ' ') { e.preventDefault(); chkRotate.checked = !chkRotate.checked; chkRotate.dispatchEvent(new Event('change')); }
      else if (k === 's' && !e.ctrlKey && !e.metaKey) { $('btn-screenshot').click(); }
      else if (k === 'p') { togglePanel(); }
    });

    function view3DActive() {
      return !document.getElementById('view-viewer')?.classList.contains('hidden');
    }

    // resize
    function onResize() {
      const w = viewport.clientWidth, h = viewport.clientHeight;
      if (w === 0 || h === 0) return;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    }
    window.addEventListener('resize', onResize);
    new ResizeObserver(onResize).observe(viewport);

    // PWA install
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault(); deferredPrompt = e;
      $('btn-install').classList.remove('hidden');
    });
    $('btn-install').addEventListener('click', () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(r => {
        if (r.outcome === 'accepted') toast('App installed!', 'success');
        deferredPrompt = null;
        $('btn-install').classList.add('hidden');
      });
    });

    /* ── Cloud model storage ── */
    function getModelsCollection(dbRef) {
      const user = window._ssoUser;
      if (user) {
        return dbRef.collection('users').doc(user.uid).collection('models');
      }
      return dbRef.collection('models');
    }

    let modelsUnsubscribe = null;

    async function initModelStorage() {
      try {
        if (modelsUnsubscribe) { modelsUnsubscribe(); modelsUnsubscribe = null; }
        const fb = await window._firebaseReady;
        if (!fb || !fb.ok) {
          renderSavedModels([]);
          return;
        }
        fbServices = fb;
        // Show save button if a model is already loaded
        if (currentModel) $('btn-save-cloud').classList.remove('hidden');
        // Listen for model list changes in real-time
        const col = getModelsCollection(fbServices.db);
        modelsUnsubscribe = col.orderBy('uploadedAt', 'desc').onSnapshot(
          snap => {
            const models = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderSavedModels(models);
          },
          err => {
            console.error('Models sync error:', err);
            renderSavedModels([]);
          }
        );
      } catch(e) {
        console.error('Model storage init failed:', e);
        renderSavedModels([]);
      }
    }

    // Re-init model storage when SSO user changes
    window.addEventListener('sso-user-changed', () => initModelStorage());

    // Save current model to Firebase Storage + metadata to Firestore
    async function saveModelToCloud() {
      if (!fbServices || !currentFile || !currentFileBuffer) {
        toast('No model to save', 'error');
        return;
      }
      const btn = $('btn-save-cloud');
      btn.disabled = true;
      btn.textContent = 'Saving...';
      try {
        const id = crypto.randomUUID();
        const ext = currentFile.name.split('.').pop().toLowerCase();
        const safeName = currentFile.name.replace(/[^a-zA-Z0-9._-]/g, '_');
        const user = window._ssoUser;
        const pathPrefix = user ? `users/${user.uid}/models` : 'models';
        const path = `${pathPrefix}/${id}/${safeName}`;

        // Upload binary to Storage
        const ref = fbServices.storage.ref(path);
        await ref.put(new Blob([currentFileBuffer]), { contentType: 'application/octet-stream' });
        const downloadURL = await ref.getDownloadURL();

        // Save metadata to Firestore (per-user collection when SSO is active)
        const col = getModelsCollection(fbServices.db);
        await col.doc(id).set({
          name: currentFile.name,
          size: currentFile.size,
          format: ext,
          storagePath: path,
          downloadURL: downloadURL,
          uploadedAt: Date.now()
        });

        toast('Model saved to cloud', 'success');
      } catch (err) {
        console.error('Save to cloud failed:', err);
        toast('Save failed: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> Save';
      }
    }

    // Load a model from cloud
    async function loadModelFromCloud(model) {
      showLoading(true);
      try {
        const resp = await fetch(model.downloadURL);
        if (!resp.ok) throw new Error('Download failed');
        const buffer = await resp.arrayBuffer();
        const file = new File([buffer], model.name, { type: 'application/octet-stream' });
        currentFile = file;
        currentFileBuffer = buffer;
        if (model.format === 'stl') loadSTL(buffer, file);
        else load3MF(buffer, file);
      } catch (err) {
        console.error('Cloud load failed:', err);
        toast('Load failed: ' + err.message, 'error');
        showLoading(false);
      }
    }

    // Delete a model from cloud
    async function deleteModelFromCloud(id) {
      if (!fbServices) return;
      try {
        const col = getModelsCollection(fbServices.db);
        const doc = await col.doc(id).get();
        if (doc.exists) {
          const data = doc.data();
          try { await fbServices.storage.ref(data.storagePath).delete(); } catch {}
          await col.doc(id).delete();
        }
        toast('Model deleted', 'success');
      } catch (err) {
        console.error('Delete failed:', err);
        toast('Delete failed: ' + err.message, 'error');
      }
    }

    function fmtDate(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }

    function renderSavedModels(models) {
      const el = $('saved-models-list');
      if (!models.length) {
        el.innerHTML = '<p class="text-zinc-600 italic">No saved models</p>';
        return;
      }
      el.innerHTML = models.map(m => {
        const fmtBadge = m.format === 'stl'
          ? '<span class="text-[9px] px-1 py-0.5 bg-amber-500/10 text-amber-400 rounded uppercase">stl</span>'
          : '<span class="text-[9px] px-1 py-0.5 bg-amber-500/10 text-amber-400 rounded uppercase">3mf</span>';
        return `<div class="flex items-center gap-2 group">
          <button class="cloud-load-btn flex-1 min-w-0 flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg px-2 py-1.5 transition-colors text-left" data-id="${m.id}">
            <svg class="w-3 h-3 text-zinc-500 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
            <span class="truncate text-zinc-300 text-[11px]">${m.name}</span>
            ${fmtBadge}
          </button>
          <button class="cloud-del-btn opacity-0 group-hover:opacity-100 text-zinc-600 hover:text-red-400 transition-all p-0.5 flex-shrink-0" data-id="${m.id}" title="Delete">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
          </button>
        </div>`;
      }).join('');

      // Wire buttons
      el.querySelectorAll('.cloud-load-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const m = models.find(x => x.id === btn.dataset.id);
          if (m) loadModelFromCloud(m);
        });
      });
      el.querySelectorAll('.cloud-del-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          if (confirm('Delete this model from the cloud?')) deleteModelFromCloud(btn.dataset.id);
        });
      });
    }

    // Wire save button
    $('btn-save-cloud').addEventListener('click', saveModelToCloud);

    /* ── animation loop ── */
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
      frameCount++;
      const now = performance.now();
      if (now - fpsTime >= 1000) {
        lastFps = Math.round(frameCount * 1000 / (now - fpsTime));
        fpsOverlay.textContent = lastFps + ' FPS';
        frameCount = 0;
        fpsTime = now;
      }
    }

    /* ── init ── */
    initScene();
    animate();
    initModelStorage();
    if (window.innerWidth < 768) panel.style.display = 'none';

    // handle PWA file handler launch
    if ('launchQueue' in window) {
      window.launchQueue.setConsumer(async launchParams => {
        if (launchParams.files?.length) {
          const fh = launchParams.files[0];
          const file = await fh.getFile();
          handleFile(file);
        }
      });
    }
  </script>

  <!-- ===== FILAMENT INVENTORY APP ===== -->
  <script>
  (function() {
    'use strict';

    const $ = id => document.getElementById(id);

    /* ── Material metadata ── */
    const MATERIAL_META = {
      'PLA':       { css: 'mat-pla',      tempNozzle: 210, tempBed: 60 },
      'PLA+':      { css: 'mat-pla-plus', tempNozzle: 215, tempBed: 60 },
      'PLA Silk':  { css: 'mat-silk',     tempNozzle: 215, tempBed: 60 },
      'ABS':       { css: 'mat-abs',      tempNozzle: 240, tempBed: 100 },
      'PETG':      { css: 'mat-petg',     tempNozzle: 230, tempBed: 80 },
      'TPU':       { css: 'mat-tpu',      tempNozzle: 220, tempBed: 50 },
      'Nylon':     { css: 'mat-nylon',    tempNozzle: 260, tempBed: 80 },
      'ASA':       { css: 'mat-asa',      tempNozzle: 250, tempBed: 100 },
      'PC':        { css: 'mat-pc',       tempNozzle: 270, tempBed: 110 },
      'HIPS':      { css: 'mat-hips',     tempNozzle: 230, tempBed: 100 },
      'PVA':       { css: 'mat-pva',      tempNozzle: 190, tempBed: 45 },
      'PP':        { css: 'mat-pp',       tempNozzle: 230, tempBed: 85 },
      'PEI':       { css: 'mat-other',    tempNozzle: 370, tempBed: 160 },
      'PEEK':      { css: 'mat-other',    tempNozzle: 400, tempBed: 160 },
      'PEKK':      { css: 'mat-other',    tempNozzle: 360, tempBed: 150 },
      'CF-PLA':    { css: 'mat-cf',       tempNozzle: 220, tempBed: 60 },
      'CF-PETG':   { css: 'mat-cf',       tempNozzle: 240, tempBed: 80 },
      'CF-Nylon':  { css: 'mat-cf',       tempNozzle: 270, tempBed: 80 },
      'CF-ABS':    { css: 'mat-cf',       tempNozzle: 250, tempBed: 100 },
      'CF-PC':     { css: 'mat-cf',       tempNozzle: 280, tempBed: 110 },
      'GF-Nylon':  { css: 'mat-cf',       tempNozzle: 265, tempBed: 80 },
      'GF-PP':     { css: 'mat-cf',       tempNozzle: 240, tempBed: 85 },
      'Wood':      { css: 'mat-wood',     tempNozzle: 200, tempBed: 60 },
      'Metal':     { css: 'mat-metal',    tempNozzle: 210, tempBed: 60 },
      'Marble':    { css: 'mat-other',    tempNozzle: 210, tempBed: 60 },
      'Glow':      { css: 'mat-other',    tempNozzle: 210, tempBed: 60 },
      'HTPLA':     { css: 'mat-pla',      tempNozzle: 215, tempBed: 60 },
      'PHA':       { css: 'mat-pla',      tempNozzle: 200, tempBed: 55 },
      'Standard Resin':       { css: 'mat-other', tempNozzle: 0, tempBed: 0 },
      'Tough Resin':          { css: 'mat-other', tempNozzle: 0, tempBed: 0 },
      'Flexible Resin':       { css: 'mat-tpu',   tempNozzle: 0, tempBed: 0 },
      'Water-Washable Resin': { css: 'mat-pva',   tempNozzle: 0, tempBed: 0 },
      'ABS-Like Resin':       { css: 'mat-abs',   tempNozzle: 0, tempBed: 0 },
      'Castable Resin':       { css: 'mat-other', tempNozzle: 0, tempBed: 0 },
      'Dental Resin':         { css: 'mat-other', tempNozzle: 0, tempBed: 0 },
      'Other':     { css: 'mat-other',    tempNozzle: 200, tempBed: 60 },
    };

    function matCSS(mat) { return (MATERIAL_META[mat] || MATERIAL_META['Other']).css; }

    /* ── State ── */
    const STORAGE_KEY = 'filament-inventory';
    let filaments = [];
    let activeFilter = 'all';
    let searchQuery = '';
    let deleteTarget = null;
    let db = null;
    let useFirebase = false;
    let firestoreUnsubscribe = null;
    let ssoUser = window._ssoUser || null;

    /* ── SSO helpers ── */
    function filamentsCollection() {
      if (!db) return null;
      if (ssoUser) {
        return db.collection('users').doc(ssoUser.uid).collection('filaments');
      }
      return db.collection('filaments');
    }

    function updateSsoUserUI(user) {
      const el = $('sso-user-info');
      const avatar = $('sso-user-avatar');
      const name = $('sso-user-name');
      if (user) {
        avatar.src = user.photoURL || '';
        avatar.style.display = user.photoURL ? '' : 'none';
        name.textContent = user.displayName || user.email || 'User';
        el.classList.remove('hidden');
        el.classList.add('flex');
      } else {
        el.classList.add('hidden');
        el.classList.remove('flex');
      }
    }

    // Listen for SSO user changes from parent portfolio
    window.addEventListener('sso-user-changed', async (e) => {
      ssoUser = e.detail;
      updateSsoUserUI(ssoUser);

      // Auto-connect Firestore when SSO arrives
      if (firestoreUnsubscribe) { firestoreUnsubscribe(); firestoreUnsubscribe = null; }
      try {
        const fb = await window._firebaseReady;
        if (fb && fb.ok) {
          initFromSharedFirebase(fb);
          await migrateLocalToFirestore();
          startRealtimeSync();
        } else {
          updateSyncStatus('local');
        }
      } catch {
        updateSyncStatus('local');
      }
    });

    /* ── localStorage helpers ── */
    function loadFromLocalStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        filaments = raw ? JSON.parse(raw) : [];
      } catch { filaments = []; }
    }

    function saveToLocalStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(filaments));
    }

    /* ── Toast helper ── */
    function toast(msg, type = 'info') {
      const c = { info: 'border-amber-500/50', error: 'border-red-500/50', success: 'border-green-500/50' };
      const toastsEl = $('toasts');
      const el = document.createElement('div');
      el.className = `toast-enter ${c[type] || c.info} border bg-zinc-900 rounded-lg px-4 py-2 text-xs font-mono text-zinc-300 shadow-lg max-w-xs`;
      el.textContent = msg;
      toastsEl.appendChild(el);
      setTimeout(() => { el.style.transition = 'opacity .3s'; el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
    }

    /* ──────────────────────────────────────
       Firebase / Firestore integration
       Uses the shared init from window._firebaseReady
       ────────────────────────────────────── */

    function initFromSharedFirebase(fb) {
      db = fb.db;
      useFirebase = true;
    }

    function startRealtimeSync() {
      if (!db) return;
      if (firestoreUnsubscribe) firestoreUnsubscribe();

      const col = filamentsCollection();
      if (!col) return;

      firestoreUnsubscribe = col.onSnapshot(
        snapshot => {
          filaments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          filaments.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
          // Cache locally for offline access
          saveToLocalStorage();
          updateSyncStatus('connected');
          renderInventory();
        },
        err => {
          console.error('Firestore sync error:', err);
          updateSyncStatus('error');
        }
      );
    }

    async function migrateLocalToFirestore() {
      // If there's local data that isn't in Firestore yet, upload it
      const localData = [];
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) localData.push(...JSON.parse(raw));
      } catch {}
      const col = filamentsCollection();
      if (!localData.length || !col) return;

      const existing = await col.get();
      const existingIds = new Set(existing.docs.map(d => d.id));
      const batch = db.batch();
      let migrated = 0;

      for (const f of localData) {
        if (!existingIds.has(f.id)) {
          const { id, ...data } = f;
          batch.set(col.doc(id), data);
          migrated++;
        }
      }

      if (migrated > 0) {
        await batch.commit();
        toast(`Migrated ${migrated} filament(s) to cloud`, 'success');
      }
    }

    async function saveFilament(entry) {
      const col = filamentsCollection();
      if (useFirebase && col) {
        const { id, ...data } = entry;
        await col.doc(id).set(data);
        // onSnapshot will update local state automatically
      } else {
        const idx = filaments.findIndex(f => f.id === entry.id);
        if (idx >= 0) {
          entry.createdAt = filaments[idx].createdAt;
          filaments[idx] = entry;
        } else {
          filaments.unshift(entry);
        }
        saveToLocalStorage();
        renderInventory();
      }
    }

    async function deleteFilament(id) {
      const col = filamentsCollection();
      if (useFirebase && col) {
        await col.doc(id).delete();
        // onSnapshot will update local state automatically
      } else {
        filaments = filaments.filter(f => f.id !== id);
        saveToLocalStorage();
        renderInventory();
      }
    }

    /* ── Sync status indicator ── */
    function updateSyncStatus(state) {
      const el = $('sync-status');
      const label = ssoUser ? 'SSO Synced' : 'Synced';

      if (state === 'connected') {
        el.innerHTML = `<span class="inline-block w-1.5 h-1.5 rounded-full bg-green-500"></span> <span class="text-green-400">${label}</span>`;
        el.className = 'flex items-center gap-1 text-[10px] font-mono px-1.5 py-0.5 rounded bg-green-500/10';
      } else if (state === 'error') {
        el.innerHTML = '<span class="inline-block w-1.5 h-1.5 rounded-full bg-red-500"></span> <span class="text-red-400">Offline</span>';
        el.className = 'flex items-center gap-1 text-[10px] font-mono px-1.5 py-0.5 rounded bg-red-500/10';
      } else {
        // local-only
        el.innerHTML = '<span class="inline-block w-1.5 h-1.5 rounded-full bg-zinc-500"></span> <span class="text-zinc-500">Local</span>';
        el.className = 'flex items-center gap-1 text-[10px] font-mono px-1.5 py-0.5 rounded bg-zinc-500/10';
      }
    }

    /* ── Tab switching ── */
    const tabViewer    = $('tab-viewer');
    const tabDxf       = $('tab-dxf');
    const tabFilaments = $('tab-filaments');
    const viewViewer   = $('view-viewer');
    const viewDxf      = $('view-dxf');
    const viewFilamentsEl = $('view-filaments');
    const btnOpen      = $('btn-open');
    const btnOpenDxf   = $('btn-open-dxf');
    const btnScreenshot = $('btn-screenshot');
    const btnDxfScreenshot = $('btn-dxf-screenshot');
    const btnDxfGcode  = $('btn-dxf-gcode');
    const btnPanel     = $('btn-panel');
    const btnSaveCloud = $('btn-save-cloud');
    const allTabs = [tabViewer, tabDxf, tabFilaments];

    function deactivateAllTabs() {
      allTabs.forEach(t => { t.classList.remove('active', 'text-amber-400'); t.classList.add('text-zinc-500'); });
      viewViewer.classList.add('hidden'); viewViewer.classList.remove('flex');
      viewDxf.classList.add('hidden'); viewDxf.classList.remove('flex');
      viewFilamentsEl.classList.add('hidden');
      btnOpen.classList.add('hidden');
      btnOpenDxf.classList.add('hidden');
      btnScreenshot.classList.add('hidden');
      btnDxfScreenshot.classList.add('hidden');
      btnDxfGcode.classList.add('hidden');
      btnPanel.classList.add('hidden');
      btnSaveCloud.classList.add('hidden');
    }

    function switchTab(tab) {
      deactivateAllTabs();
      if (tab === 'viewer') {
        tabViewer.classList.add('active', 'text-amber-400');
        tabViewer.classList.remove('text-zinc-500');
        viewViewer.classList.remove('hidden');
        viewViewer.classList.add('flex');
        btnOpen.classList.remove('hidden');
        btnScreenshot.classList.remove('hidden');
        btnPanel.classList.remove('hidden');
        if (btnSaveCloud.dataset.enabled === '1') btnSaveCloud.classList.remove('hidden');
        window.dispatchEvent(new Event('resize'));
      } else if (tab === 'dxf') {
        tabDxf.classList.add('active', 'text-amber-400');
        tabDxf.classList.remove('text-zinc-500');
        viewDxf.classList.remove('hidden');
        viewDxf.classList.add('flex');
        btnOpenDxf.classList.remove('hidden');
        btnDxfScreenshot.classList.remove('hidden');
        btnDxfGcode.classList.remove('hidden');
        window.dispatchEvent(new CustomEvent('dxf-tab-activated'));
      } else {
        tabFilaments.classList.add('active', 'text-amber-400');
        tabFilaments.classList.remove('text-zinc-500');
        viewFilamentsEl.classList.remove('hidden');
        renderInventory();
      }
    }

    tabViewer.addEventListener('click', () => switchTab('viewer'));
    tabDxf.addEventListener('click', () => switchTab('dxf'));
    tabFilaments.addEventListener('click', () => switchTab('filaments'));

    /* ── Rendering ── */
    function getFiltered() {
      let list = filaments;
      if (activeFilter !== 'all') {
        list = list.filter(f => f.material === activeFilter);
      }
      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        list = list.filter(f =>
          (f.colorName || '').toLowerCase().includes(q) ||
          f.material.toLowerCase().includes(q) ||
          (f.brand || '').toLowerCase().includes(q) ||
          f.color.toLowerCase().includes(q) ||
          (f.notes || '').toLowerCase().includes(q)
        );
      }
      return list;
    }

    function renderInventory() {
      renderStats();
      renderColorPalette();
      renderMaterialBreakdown();
      renderFilterButtons();
      renderGrid();
    }

    function renderStats() {
      $('stat-total').textContent = filaments.length;
      const mats = new Set(filaments.map(f => f.material));
      $('stat-materials').textContent = mats.size;
      const totalG = filaments.reduce((s, f) => s + (f.weight || 0) * (f.remaining || 100) / 100, 0);
      $('stat-weight').textContent = totalG >= 1000 ? (totalG / 1000).toFixed(1) + ' kg' : Math.round(totalG) + ' g';
      const colors = new Set(filaments.map(f => f.color));
      $('stat-colors').textContent = colors.size;
    }

    function renderColorPalette() {
      const el = $('color-palette');
      if (!filaments.length) {
        el.innerHTML = '<p class="text-xs text-zinc-600 font-mono italic">No filaments yet</p>';
        return;
      }
      const colorMap = {};
      filaments.forEach(f => {
        if (!colorMap[f.color]) colorMap[f.color] = { color: f.color, name: f.colorName, count: 0 };
        colorMap[f.color].count++;
      });
      const colors = Object.values(colorMap).sort((a, b) => hue(a.color) - hue(b.color));
      el.innerHTML = colors.map(c =>
        `<div class="group relative">
          <div class="w-8 h-8 rounded-lg border-2 border-zinc-700 cursor-default transition-transform hover:scale-110" style="background:${c.color}" title="${c.name || c.color} (${c.count})"></div>
          <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-[10px] font-mono text-zinc-300 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
            ${c.name || c.color} <span class="text-zinc-500">&times;${c.count}</span>
          </div>
        </div>`
      ).join('');
    }

    function hue(hex) {
      const r = parseInt(hex.slice(1,3),16)/255, g = parseInt(hex.slice(3,5),16)/255, b = parseInt(hex.slice(5,7),16)/255;
      const max = Math.max(r,g,b), min = Math.min(r,g,b), d = max - min;
      if (d === 0) return 0;
      let h;
      if (max === r) h = ((g - b) / d) % 6;
      else if (max === g) h = (b - r) / d + 2;
      else h = (r - g) / d + 4;
      return ((h * 60) + 360) % 360;
    }

    function renderMaterialBreakdown() {
      const el = $('material-breakdown');
      if (!filaments.length) {
        el.innerHTML = '<p class="text-xs text-zinc-600 font-mono italic">No filaments yet</p>';
        return;
      }
      const counts = {};
      filaments.forEach(f => { counts[f.material] = (counts[f.material] || 0) + 1; });
      const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
      const max = sorted[0][1];
      el.innerHTML = sorted.map(([mat, count]) => {
        const pct = Math.round(count / filaments.length * 100);
        const css = matCSS(mat);
        return `<div class="flex items-center gap-3">
          <span class="text-[11px] font-mono w-20 text-zinc-400 shrink-0">${mat}</span>
          <div class="flex-1 bg-zinc-800 rounded-full h-2 overflow-hidden">
            <div class="weight-bar h-full rounded-full ${css}" style="width:${(count/max)*100}%; opacity:0.7"></div>
          </div>
          <span class="text-[10px] font-mono text-zinc-500 w-14 text-right">${count} &middot; ${pct}%</span>
        </div>`;
      }).join('');
    }

    function renderFilterButtons() {
      const mats = [...new Set(filaments.map(f => f.material))].sort();
      const container = $('filter-buttons');
      container.innerHTML = mats.map(m => {
        const isActive = activeFilter === m;
        const css = matCSS(m);
        return `<button data-filter="${m}" class="filter-btn ${isActive ? css : 'bg-zinc-800 text-zinc-400 border-zinc-700'} text-[11px] font-mono px-3 py-1.5 rounded-lg border transition-colors hover:border-zinc-600">${m}</button>`;
      }).join('');

      const allBtn = document.querySelector('[data-filter="all"]');
      if (activeFilter === 'all') {
        allBtn.className = 'filter-btn active bg-amber-500/10 text-amber-400 text-[11px] font-mono px-3 py-1.5 rounded-lg border border-amber-500/20 transition-colors';
      } else {
        allBtn.className = 'filter-btn bg-zinc-800 text-zinc-400 text-[11px] font-mono px-3 py-1.5 rounded-lg border border-zinc-700 transition-colors hover:border-zinc-600';
      }

      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          activeFilter = btn.dataset.filter;
          renderFilterButtons();
          renderGrid();
        });
      });
    }

    function remainingColor(pct) {
      if (pct > 50) return 'text-green-400';
      if (pct > 20) return 'text-amber-400';
      return 'text-red-400';
    }

    function remainingBarColor(pct) {
      if (pct > 50) return 'bg-green-500';
      if (pct > 20) return 'bg-amber-500';
      return 'bg-red-500';
    }

    function amazonSearchUrl(f) {
      // Build a search query: "<brand> <material> filament <diameter>mm <colorName>"
      const parts = [];
      if (f.brand) parts.push(f.brand);
      parts.push(f.material);
      if (f.material.includes('Resin')) parts.push('resin');
      else parts.push('filament');
      if (f.diameter && !f.material.includes('Resin')) parts.push(f.diameter + 'mm');
      if (f.colorName) parts.push(f.colorName);
      else if (f.color) parts.push(f.color);
      const q = encodeURIComponent(parts.join(' '));
      return `https://www.amazon.nl/s?k=${q}`;
    }

    function renderGrid() {
      const grid = $('filament-grid');
      const empty = $('filament-empty');
      const filtered = getFiltered();

      if (!filtered.length) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      grid.innerHTML = filtered.map(f => {
        const css = matCSS(f.material);
        const rem = f.remaining || 100;
        const weightG = (f.weight || 0) * rem / 100;
        const isResin = f.material.includes('Resin');
        return `<div class="spool-card bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden" data-id="${f.id}">
          <div class="h-2 w-full" style="background:${f.color}"></div>
          <div class="p-4">
            <div class="flex items-start gap-3 mb-3">
              <div class="spool-ring w-14 h-14 flex-shrink-0 border-4" style="background:${f.color}; border-color:${f.color}"></div>
              <div class="flex-1 min-w-0">
                <h4 class="font-mono font-bold text-sm text-zinc-100 truncate">${f.colorName || f.color}</h4>
                <div class="flex items-center gap-2 mt-1">
                  <span class="${css} text-[10px] font-mono px-1.5 py-0.5 rounded">${f.material}</span>
                  ${f.brand ? `<span class="text-[10px] font-mono text-zinc-500 truncate">${f.brand}</span>` : ''}
                </div>
              </div>
            </div>
            <div class="space-y-1.5 text-[11px] font-mono mb-3">
              ${!isResin && f.diameter ? `<div class="flex justify-between"><span class="text-zinc-500">Diameter</span><span class="text-zinc-400">${f.diameter} mm</span></div>` : ''}
              ${f.weight ? `<div class="flex justify-between"><span class="text-zinc-500">${isResin ? 'Volume' : 'Weight'}</span><span class="text-zinc-400">${f.weight}${isResin ? ' ml' : ' g'}</span></div>` : ''}
              ${f.tempNozzle && !isResin ? `<div class="flex justify-between"><span class="text-zinc-500">Nozzle</span><span class="text-zinc-400">${f.tempNozzle}&deg;C</span></div>` : ''}
              ${f.tempBed && !isResin ? `<div class="flex justify-between"><span class="text-zinc-500">Bed</span><span class="text-zinc-400">${f.tempBed}&deg;C</span></div>` : ''}
            </div>
            <div class="mb-3">
              <div class="flex justify-between mb-1">
                <span class="text-[10px] font-mono text-zinc-500">Remaining</span>
                <span class="text-[10px] font-mono ${remainingColor(rem)}">${rem}%${f.weight ? ' &middot; ' + Math.round(weightG) + (isResin ? ' ml' : ' g') : ''}</span>
              </div>
              <div class="w-full bg-zinc-800 rounded-full h-1.5">
                <div class="weight-bar h-full rounded-full ${remainingBarColor(rem)}" style="width:${rem}%"></div>
              </div>
            </div>
            ${f.notes ? `<p class="text-[10px] font-mono text-zinc-600 italic truncate mb-3" title="${f.notes}">${f.notes}</p>` : ''}
            ${rem <= 25 ? `<a href="${amazonSearchUrl(f)}" target="_blank" rel="noopener" class="flex items-center justify-center gap-1.5 w-full bg-amber-500 hover:bg-amber-400 text-zinc-900 text-[11px] font-mono font-bold px-2 py-1.5 rounded-lg transition-colors mb-2">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>
              Order on Amazon.nl
            </a>` : ''}
            <div class="flex gap-2">
              <button class="btn-edit-filament flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 text-[11px] font-mono px-2 py-1.5 rounded-lg transition-colors flex items-center justify-center gap-1" data-id="${f.id}">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Edit
              </button>
              <a href="${amazonSearchUrl(f)}" target="_blank" rel="noopener" class="btn-order-filament flex-1 bg-zinc-800 hover:bg-amber-500/20 text-zinc-400 hover:text-amber-400 text-[11px] font-mono px-2 py-1.5 rounded-lg transition-colors flex items-center justify-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>
                Order
              </a>
              <button class="btn-del-filament flex-1 bg-zinc-800 hover:bg-red-500/20 text-zinc-400 hover:text-red-400 text-[11px] font-mono px-2 py-1.5 rounded-lg transition-colors flex items-center justify-center gap-1" data-id="${f.id}">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                Delete
              </button>
            </div>
          </div>
        </div>`;
      }).join('');

      grid.querySelectorAll('.btn-edit-filament').forEach(btn => {
        btn.addEventListener('click', () => openEditModal(btn.dataset.id));
      });
      grid.querySelectorAll('.btn-del-filament').forEach(btn => {
        btn.addEventListener('click', () => openDeleteModal(btn.dataset.id));
      });
    }

    /* ── Filament form modal ── */
    const modal = $('filament-modal');
    const form = $('filament-form');
    const colorInput = $('ff-color');
    const colorPreview = $('ff-color-preview');

    colorInput.addEventListener('input', () => {
      colorPreview.style.background = colorInput.value;
    });

    function openAddModal() {
      $('modal-title').textContent = 'Add Filament';
      $('ff-id').value = '';
      form.reset();
      colorPreview.style.background = '#a0a0a8';
      colorInput.value = '#a0a0a8';
      $('ff-remaining').value = '100';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      $('ff-color-name').focus();
    }

    function openEditModal(id) {
      const f = filaments.find(x => x.id === id);
      if (!f) return;
      $('modal-title').textContent = 'Edit Filament';
      $('ff-id').value = f.id;
      colorInput.value = f.color;
      colorPreview.style.background = f.color;
      $('ff-color-name').value = f.colorName || '';
      $('ff-material').value = f.material;
      $('ff-brand').value = f.brand || '';
      const diamRadios = document.querySelectorAll('[name="ff-diameter"]');
      diamRadios.forEach(r => { r.checked = r.value === String(f.diameter || 1.75); });
      $('ff-weight').value = f.weight || '';
      $('ff-remaining').value = f.remaining ?? 100;
      $('ff-temp-nozzle').value = f.tempNozzle || '';
      $('ff-temp-bed').value = f.tempBed || '';
      $('ff-notes').value = f.notes || '';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    $('btn-add-filament').addEventListener('click', openAddModal);
    $('btn-modal-close').addEventListener('click', closeModal);
    $('btn-modal-cancel').addEventListener('click', closeModal);
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

    // Auto-fill temps when material changes
    $('ff-material').addEventListener('change', () => {
      const mat = $('ff-material').value;
      const meta = MATERIAL_META[mat];
      if (meta && !$('ff-temp-nozzle').value) $('ff-temp-nozzle').value = meta.tempNozzle || '';
      if (meta && !$('ff-temp-bed').value) $('ff-temp-bed').value = meta.tempBed || '';
      if (mat.includes('Resin')) {
        document.querySelectorAll('[name="ff-diameter"]').forEach(r => { r.checked = r.value === '0'; });
      }
    });

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const id = $('ff-id').value || crypto.randomUUID();
      const diameterRadio = document.querySelector('[name="ff-diameter"]:checked');
      const isEdit = !!$('ff-id').value;
      const entry = {
        id,
        color: colorInput.value,
        colorName: $('ff-color-name').value.trim(),
        material: $('ff-material').value,
        brand: $('ff-brand').value.trim(),
        diameter: parseFloat(diameterRadio?.value || '1.75'),
        weight: parseInt($('ff-weight').value) || 0,
        remaining: Math.min(100, Math.max(0, parseInt($('ff-remaining').value) || 100)),
        tempNozzle: parseInt($('ff-temp-nozzle').value) || 0,
        tempBed: parseInt($('ff-temp-bed').value) || 0,
        notes: $('ff-notes').value.trim(),
        updatedAt: Date.now(),
        createdAt: isEdit ? (filaments.find(f => f.id === id)?.createdAt || Date.now()) : Date.now(),
      };

      closeModal();

      try {
        await saveFilament(entry);
        toast(isEdit ? 'Filament updated' : 'Filament added', 'success');
      } catch (err) {
        console.error('Save error:', err);
        toast('Save failed: ' + err.message, 'error');
      }
    });

    /* ── Delete ── */
    const delModal = $('delete-modal');

    function openDeleteModal(id) {
      deleteTarget = id;
      delModal.classList.remove('hidden');
      delModal.classList.add('flex');
    }

    function closeDeleteModal() {
      delModal.classList.add('hidden');
      delModal.classList.remove('flex');
      deleteTarget = null;
    }

    $('btn-confirm-delete').addEventListener('click', async () => {
      if (deleteTarget) {
        try {
          await deleteFilament(deleteTarget);
          toast('Filament removed', 'success');
        } catch (err) {
          console.error('Delete error:', err);
          toast('Delete failed: ' + err.message, 'error');
        }
      }
      closeDeleteModal();
    });
    $('btn-cancel-delete').addEventListener('click', closeDeleteModal);
    delModal.addEventListener('click', e => { if (e.target === delModal) closeDeleteModal(); });

    /* ── Search ── */
    $('filament-search').addEventListener('input', e => {
      searchQuery = e.target.value;
      renderGrid();
    });

    /* ── Init ── */
    // Load cached local data first (instant render)
    loadFromLocalStorage();
    updateSyncStatus('local');

    // Show SSO user info if already available (e.g. parent sent auth before this script ran)
    if (window._ssoUser) {
      ssoUser = window._ssoUser;
      updateSsoUserUI(ssoUser);
    }

    // Connect to Firebase via shared init
    if (window._firebaseReady) {
      window._firebaseReady.then(fb => {
        if (fb.ok) {
          initFromSharedFirebase(fb);
          startRealtimeSync();
        } else {
          updateSyncStatus('local');
        }
      });
    }

    // Expose switchTab for keyboard shortcut
    window._filamentSwitchTab = switchTab;
  })();
  </script>

  <!-- ===== 2D DXF VIEWER ===== -->
  <script>
  (function() {
    const $ = id => document.getElementById(id);
    const canvas = $('dxf-canvas');
    const ctx = canvas.getContext('2d');
    const viewport = $('dxf-viewport');
    const emptyState = $('dxf-empty-state');
    const dragOverlay = $('dxf-drag-overlay');
    const loadingEl = $('dxf-loading');
    const infoEl = $('dxf-info');
    const hintEl = $('dxf-controls-hint');
    const zoomEl = $('dxf-zoom');
    const fileInput = $('dxf-file-input');

    let entities = [];
    let layers = {};
    let bounds = null;
    let showGrid = true;

    // Camera: pan + zoom
    let cam = { x: 0, y: 0, zoom: 1 };
    let dxfLoaded = false;

    /* ── DXF color table (AutoCAD ACI → hex) ── */
    const ACI = [
      '#000000','#FF0000','#FFFF00','#00FF00','#00FFFF','#0000FF','#FF00FF','#FFFFFF',
      '#808080','#C0C0C0','#FF0000','#FF7F7F','#A50000','#A55252','#7F0000','#7F3F3F',
      '#4C0000','#4C2626','#260000','#261313','#FF3F00','#FF9F7F','#A52900','#A56752',
      '#7F1F00','#7F4F3F','#4C1300','#4C2F26','#260900','#261713','#FF7F00','#FFBF7F',
      '#A55200','#A57C52','#7F3F00','#7F5F3F','#4C2600','#4C3926','#261300','#261C13',
      '#FFBF00','#FFDF7F','#A57C00','#A59152','#7F5F00','#7F6F3F','#4C3900','#4C4226',
      '#261C00','#262113','#FFFF00','#FFFF7F','#A5A500','#A5A552','#7F7F00','#7F7F3F',
      '#4C4C00','#4C4C26','#262600','#262613','#BFFF00','#DFFF7F','#7CA500','#91A552',
      '#5F7F00','#6F7F3F','#394C00','#424C26','#1C2600','#212613','#7FFF00','#BFFF7F',
      '#52A500','#7CA552','#3F7F00','#5F7F3F','#264C00','#394C26','#132600','#1C2613',
      '#3FFF00','#9FFF7F','#29A500','#67A552','#1F7F00','#4F7F3F','#134C00','#2F4C26',
      '#092600','#172613','#00FF00','#7FFF7F','#00A500','#52A552','#007F00','#3F7F3F',
      '#004C00','#264C26','#002600','#132613','#00FF3F','#7FFF9F','#00A529','#52A567',
      '#007F1F','#3F7F4F','#004C13','#264C2F','#002609','#132617','#00FF7F','#7FFFBF',
      '#00A552','#52A57C','#007F3F','#3F7F5F','#004C26','#264C39','#002613','#13261C',
      '#00FFBF','#7FFFDF','#00A57C','#52A591','#007F5F','#3F7F6F','#004C39','#264C42',
      '#00261C','#132621','#00FFFF','#7FFFFF','#00A5A5','#52A5A5','#007F7F','#3F7F7F',
      '#004C4C','#264C4C','#002626','#132626','#00BFFF','#7FDFFF','#007CA5','#5291A5',
      '#005F7F','#3F6F7F','#00394C','#26424C','#001C26','#132126','#007FFF','#7FBFFF',
      '#0052A5','#527CA5','#003F7F','#3F5F7F','#00264C','#26394C','#001326','#131C26',
      '#003FFF','#7F9FFF','#0029A5','#5267A5','#001F7F','#3F4F7F','#00134C','#262F4C',
      '#000926','#131726','#0000FF','#7F7FFF','#0000A5','#5252A5','#00007F','#3F3F7F',
      '#00004C','#26264C','#000026','#131326','#3F00FF','#9F7FFF','#2900A5','#6752A5',
      '#1F007F','#4F3F7F','#13004C','#2F264C','#090026','#171326','#7F00FF','#BF7FFF',
      '#5200A5','#7C52A5','#3F007F','#5F3F7F','#26004C','#39264C','#130026','#1C1326',
      '#BF00FF','#DF7FFF','#7C00A5','#9152A5','#5F007F','#6F3F7F','#39004C','#42264C',
      '#1C0026','#211326','#FF00FF','#FF7FFF','#A500A5','#A552A5','#7F007F','#7F3F7F',
      '#4C004C','#4C264C','#260026','#261326','#FF00BF','#FF7FDF','#A5007C','#A55291',
      '#7F005F','#7F3F6F','#4C0039','#4C2642','#26001C','#261321','#FF007F','#FF7FBF',
      '#A50052','#A5527C','#7F003F','#7F3F5F','#4C0026','#4C2639','#260013','#26131C',
      '#FF003F','#FF7F9F','#A50029','#A55267','#7F001F','#7F3F4F','#4C0013','#4C262F',
      '#260009','#261317','#333333','#505050','#696969','#828282','#BEBEBE','#FFFFFF'
    ];

    function aciColor(n) {
      if (n === 0 || n === 256) return null; // BYLAYER / BYBLOCK
      return ACI[Math.abs(n)] || '#FFFFFF';
    }

    /* ── Minimal DXF parser ── */
    function parseDXF(text) {
      const lines = text.split(/\r?\n/);
      const pairs = [];
      for (let i = 0; i + 1 < lines.length; i += 2) {
        pairs.push({ code: parseInt(lines[i].trim(), 10), value: lines[i + 1].trim() });
      }

      const result = { entities: [], layers: {}, blocks: {} };
      let i = 0;

      // Find TABLES section for layers
      while (i < pairs.length) {
        if (pairs[i].code === 2 && pairs[i].value === 'LAYER') {
          i++;
          while (i < pairs.length && !(pairs[i].code === 0 && pairs[i].value === 'ENDTAB')) {
            if (pairs[i].code === 0 && pairs[i].value === 'LAYER') {
              const layer = { name: '0', color: 7 };
              i++;
              while (i < pairs.length && pairs[i].code !== 0) {
                if (pairs[i].code === 2) layer.name = pairs[i].value;
                if (pairs[i].code === 62) layer.color = parseInt(pairs[i].value, 10);
                i++;
              }
              result.layers[layer.name] = layer;
            } else {
              i++;
            }
          }
        }
        i++;
      }

      // Helper: parse a single entity (stops at next code 0, returns index)
      function parseEntity(start) {
        const type = pairs[start].value;
        const ent = { type, layer: '0', color: null, props: {} };
        let j = start + 1;
        while (j < pairs.length && pairs[j].code !== 0) {
          const c = pairs[j].code, v = pairs[j].value;
          if (c === 8) ent.layer = v;
          else if (c === 62) ent.color = parseInt(v, 10);
          else {
            if (!ent.props[c]) ent.props[c] = [];
            ent.props[c].push(v);
          }
          j++;
        }
        return { ent, next: j };
      }

      // Parse a list of entities from start until ENDSEC/ENDBLK/end-of-file
      function parseEntityList(start, endMarkers) {
        const ents = [];
        let j = start;
        while (j < pairs.length) {
          if (pairs[j].code === 0 && endMarkers.includes(pairs[j].value)) break;
          if (pairs[j].code !== 0) { j++; continue; }

          const type = pairs[j].value;

          // Old-style POLYLINE: collect VERTEX entities until SEQEND
          if (type === 'POLYLINE') {
            const { ent: polyEnt, next } = parseEntity(j);
            const vertices = [];
            j = next;
            while (j < pairs.length && !(pairs[j].code === 0 && pairs[j].value === 'SEQEND')) {
              if (pairs[j].code === 0 && pairs[j].value === 'VERTEX') {
                const { ent: vEnt, next: vNext } = parseEntity(j);
                vertices.push(vEnt);
                j = vNext;
              } else {
                j++;
              }
            }
            // Skip past SEQEND
            if (j < pairs.length && pairs[j].code === 0 && pairs[j].value === 'SEQEND') {
              j++;
              while (j < pairs.length && pairs[j].code !== 0) j++;
            }
            // Convert vertices into polyline props
            polyEnt.props[10] = vertices.map(v => (v.props[10] || ['0'])[0]);
            polyEnt.props[20] = vertices.map(v => (v.props[20] || ['0'])[0]);
            polyEnt.props[42] = vertices.map(v => (v.props[42] || ['0'])[0]);
            ents.push(polyEnt);
            continue;
          }

          const { ent, next } = parseEntity(j);
          ents.push(ent);
          j = next;
        }
        return { ents, endIdx: j };
      }

      // Parse BLOCKS section
      i = 0;
      while (i < pairs.length) {
        if (pairs[i].code === 2 && pairs[i].value === 'BLOCKS') { i++; break; }
        if (pairs[i].code === 0 && pairs[i].value === 'SECTION') {
          i++;
          if (i < pairs.length && pairs[i].code === 2 && pairs[i].value === 'BLOCKS') { i++; break; }
        }
        i++;
      }
      // Now parse individual BLOCK definitions
      while (i < pairs.length) {
        if (pairs[i].code === 0 && pairs[i].value === 'ENDSEC') break;
        if (pairs[i].code === 0 && pairs[i].value === 'BLOCK') {
          let blockName = '';
          let baseX = 0, baseY = 0;
          let j = i + 1;
          while (j < pairs.length && pairs[j].code !== 0) {
            if (pairs[j].code === 2) blockName = pairs[j].value;
            if (pairs[j].code === 10) baseX = parseFloat(pairs[j].value);
            if (pairs[j].code === 20) baseY = parseFloat(pairs[j].value);
            j++;
          }
          const { ents, endIdx } = parseEntityList(j, ['ENDBLK']);
          result.blocks[blockName] = { baseX, baseY, entities: ents };
          i = endIdx;
          // Skip past ENDBLK
          if (i < pairs.length && pairs[i].code === 0 && pairs[i].value === 'ENDBLK') {
            i++;
            while (i < pairs.length && pairs[i].code !== 0) i++;
          }
        } else {
          i++;
        }
      }

      // Parse ENTITIES section
      i = 0;
      while (i < pairs.length) {
        if (pairs[i].code === 2 && pairs[i].value === 'ENTITIES') { i++; break; }
        i++;
      }
      const { ents } = parseEntityList(i, ['ENDSEC']);
      result.entities = ents;

      return result;
    }

    function prop(ent, code, idx) {
      const arr = ent.props[code];
      return arr ? parseFloat(arr[idx || 0]) : 0;
    }

    function propStr(ent, code, idx) {
      const arr = ent.props[code];
      return arr ? arr[idx || 0] : '';
    }

    /* ── Convert parsed entities to drawable primitives ── */
    function buildDrawables(parsed) {
      const drawables = [];

      function getColor(ent) {
        if (ent.color && ent.color > 0 && ent.color < 256) return aciColor(ent.color);
        const layer = parsed.layers[ent.layer];
        if (layer) return aciColor(Math.abs(layer.color)) || '#FFFFFF';
        return '#FFFFFF';
      }

      // Transform a drawable for INSERT block expansion
      function transformDrawable(d, ix, iy, sx, sy, cosR, sinR, bx, by) {
        function tx(x, y) {
          const lx = (x - bx) * sx, ly = (y - by) * sy;
          return { x: ix + lx * cosR - ly * sinR, y: iy + lx * sinR + ly * cosR };
        }
        switch (d.type) {
          case 'line': { const a = tx(d.x1,d.y1), b = tx(d.x2,d.y2); return { ...d, x1:a.x, y1:a.y, x2:b.x, y2:b.y }; }
          case 'circle': { const c = tx(d.cx,d.cy); return { ...d, cx:c.x, cy:c.y, r: d.r * Math.abs(sx) }; }
          case 'arc': { const c = tx(d.cx,d.cy); return { ...d, cx:c.x, cy:c.y, r: d.r * Math.abs(sx), sa: d.sa + Math.atan2(sinR,cosR), ea: d.ea + Math.atan2(sinR,cosR) }; }
          case 'polyline': { const pts = d.pts.map(p => { const t = tx(p.x,p.y); return { x:t.x, y:t.y, bulge: p.bulge }; }); return { ...d, pts }; }
          case 'point': { const p = tx(d.x,d.y); return { ...d, x:p.x, y:p.y }; }
          case 'text': { const p = tx(d.x,d.y); return { ...d, x:p.x, y:p.y, height: d.height * Math.abs(sy) }; }
          case 'ellipse': { const c = tx(d.cx,d.cy); return { ...d, cx:c.x, cy:c.y, mx: d.mx*sx*cosR - d.my*sy*sinR, my: d.mx*sx*sinR + d.my*sy*cosR }; }
          default: return d;
        }
      }

      for (const ent of parsed.entities) {
        const color = getColor(ent);
        switch (ent.type) {
          case 'LINE':
            drawables.push({ type: 'line', x1: prop(ent,10), y1: prop(ent,20), x2: prop(ent,11), y2: prop(ent,21), color });
            break;

          case 'CIRCLE':
            drawables.push({ type: 'circle', cx: prop(ent,10), cy: prop(ent,20), r: prop(ent,40), color });
            break;

          case 'ARC': {
            const cx = prop(ent,10), cy = prop(ent,20), r = prop(ent,40);
            const sa = prop(ent,50) * Math.PI / 180;
            const ea = prop(ent,51) * Math.PI / 180;
            drawables.push({ type: 'arc', cx, cy, r, sa, ea, color });
            break;
          }

          case 'LWPOLYLINE':
          case 'POLYLINE': {
            const xs = ent.props[10] || [];
            const ys = ent.props[20] || [];
            const bulges = ent.props[42] || [];
            const closed = (parseInt(ent.props[70]?.[0] || '0', 10) & 1) === 1;
            const pts = xs.map((x, j) => ({ x: parseFloat(x), y: parseFloat(ys[j] || 0), bulge: parseFloat(bulges[j] || 0) }));
            if (pts.length >= 2) {
              drawables.push({ type: 'polyline', pts, closed, color });
            }
            break;
          }

          case 'SPLINE': {
            const closed = (parseInt(ent.props[70]?.[0] || '0', 10) & 1) === 1;
            const degree = parseInt(ent.props[71]?.[0] || '3', 10);
            const ctrlXs = ent.props[10] || [];
            const ctrlYs = ent.props[20] || [];
            const knots = (ent.props[40] || []).map(Number);
            const fitXs = ent.props[11] || [];
            const fitYs = ent.props[21] || [];

            // If we have fit points, use them directly (they lie on the curve)
            if (fitXs.length >= 2) {
              const pts = fitXs.map((x, j) => ({ x: parseFloat(x), y: parseFloat(fitYs[j] || 0), bulge: 0 }));
              drawables.push({ type: 'polyline', pts, closed, color });
            } else if (ctrlXs.length >= 2 && knots.length >= ctrlXs.length + degree + 1) {
              // B-spline evaluation using De Boor's algorithm
              const n = ctrlXs.length;
              const cp = ctrlXs.map((x, j) => [parseFloat(x), parseFloat(ctrlYs[j] || 0)]);
              const segments = Math.max(n * 8, 64);
              const tMin = knots[degree];
              const tMax = knots[n];
              const pts = [];

              for (let si = 0; si <= segments; si++) {
                let t = tMin + (tMax - tMin) * si / segments;
                if (si === segments) t = tMax - 1e-10;
                // Find knot span
                let k = degree;
                while (k < n - 1 && knots[k + 1] <= t) k++;
                // De Boor
                const d = [];
                for (let j = 0; j <= degree; j++) {
                  const idx = Math.min(Math.max(k - degree + j, 0), n - 1);
                  d[j] = [cp[idx][0], cp[idx][1]];
                }
                for (let r = 1; r <= degree; r++) {
                  for (let j = degree; j >= r; j--) {
                    const ki = k - degree + j;
                    const denom = knots[ki + degree - r + 1] - knots[ki];
                    const alpha = denom > 1e-10 ? (t - knots[ki]) / denom : 0;
                    d[j][0] = (1 - alpha) * d[j - 1][0] + alpha * d[j][0];
                    d[j][1] = (1 - alpha) * d[j - 1][1] + alpha * d[j][1];
                  }
                }
                pts.push({ x: d[degree][0], y: d[degree][1], bulge: 0 });
              }
              if (pts.length >= 2) {
                drawables.push({ type: 'polyline', pts, closed, color });
              }
            } else if (ctrlXs.length >= 2) {
              // Fallback: connect control points
              const pts = ctrlXs.map((x, j) => ({ x: parseFloat(x), y: parseFloat(ctrlYs[j] || 0), bulge: 0 }));
              drawables.push({ type: 'polyline', pts, closed, color });
            }
            break;
          }

          case 'ELLIPSE': {
            const cx = prop(ent,10), cy = prop(ent,20);
            const mx = prop(ent,11), my = prop(ent,21); // major axis endpoint relative to center
            const ratio = prop(ent,40) || 1;
            const sa = prop(ent,41) || 0;
            const ea = prop(ent,42) || Math.PI * 2;
            drawables.push({ type: 'ellipse', cx, cy, mx, my, ratio, sa, ea, color });
            break;
          }

          case 'POINT':
            drawables.push({ type: 'point', x: prop(ent,10), y: prop(ent,20), color });
            break;

          case 'TEXT':
          case 'MTEXT': {
            const x = prop(ent,10), y = prop(ent,20);
            let text = propStr(ent,1,0) || '';
            // Strip MTEXT formatting codes
            text = text.replace(/\\[A-Za-z][^;]*;/g, '').replace(/\{|\}/g, '').replace(/\\P/g, '\n');
            const height = prop(ent,40) || 2.5;
            drawables.push({ type: 'text', x, y, text, height, color });
            break;
          }

          case 'INSERT': {
            const blockName = propStr(ent, 2, 0);
            const block = parsed.blocks[blockName];
            if (block) {
              const ix = prop(ent, 10), iy = prop(ent, 20);
              const sx = prop(ent, 41) || 1, sy = prop(ent, 42) || 1;
              const rot = (prop(ent, 50) || 0) * Math.PI / 180;
              const cosR = Math.cos(rot), sinR = Math.sin(rot);
              // Recursively build drawables from block entities
              const blockDrawables = buildDrawables({ entities: block.entities, layers: parsed.layers, blocks: parsed.blocks });
              // Transform each drawable
              for (const bd of blockDrawables) {
                const td = transformDrawable(bd, ix, iy, sx, sy, cosR, sinR, block.baseX, block.baseY);
                if (td) drawables.push(td);
              }
            }
            break;
          }

          case 'DIMENSION':
            // Simplified: draw a line between definition points if available
            if (ent.props[13] && ent.props[14]) {
              drawables.push({ type: 'line', x1: prop(ent,13), y1: prop(ent,23), x2: prop(ent,14), y2: prop(ent,24), color });
            }
            break;

          case 'VERTEX': {
            // VERTEX entities within old-style POLYLINE
            break;
          }

          case 'SEQEND':
            break;

          default:
            break;
        }
      }

      return drawables;
    }

    /* ── Compute bounding box ── */
    function computeBounds(drawables) {
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      function expand(x, y) {
        if (x < minX) minX = x;
        if (x > maxX) maxX = x;
        if (y < minY) minY = y;
        if (y > maxY) maxY = y;
      }
      for (const d of drawables) {
        switch (d.type) {
          case 'line': expand(d.x1, d.y1); expand(d.x2, d.y2); break;
          case 'circle': expand(d.cx - d.r, d.cy - d.r); expand(d.cx + d.r, d.cy + d.r); break;
          case 'arc': expand(d.cx - d.r, d.cy - d.r); expand(d.cx + d.r, d.cy + d.r); break;
          case 'ellipse': {
            const a = Math.sqrt(d.mx * d.mx + d.my * d.my);
            expand(d.cx - a, d.cy - a); expand(d.cx + a, d.cy + a); break;
          }
          case 'polyline': d.pts.forEach(p => expand(p.x, p.y)); break;
          case 'point': expand(d.x, d.y); break;
          case 'text': expand(d.x, d.y); break;
        }
      }
      if (minX === Infinity) return { minX: -10, minY: -10, maxX: 10, maxY: 10 };
      return { minX, minY, maxX, maxY };
    }

    /* ── Fit view ── */
    function fitView() {
      if (!bounds) return;
      const w = canvas.width, h = canvas.height;
      const dw = bounds.maxX - bounds.minX || 1;
      const dh = bounds.maxY - bounds.minY || 1;
      const padding = 0.9;
      cam.zoom = Math.min(w / dw, h / dh) * padding;
      cam.x = (bounds.minX + bounds.maxX) / 2;
      cam.y = (bounds.minY + bounds.maxY) / 2;
      render();
    }

    function resetView() {
      cam = { x: 0, y: 0, zoom: 1 };
      if (bounds) fitView();
      else render();
    }

    /* ── World ↔ Screen transforms ── */
    function worldToScreen(wx, wy) {
      const cx = canvas.width / 2, cy = canvas.height / 2;
      return { x: cx + (wx - cam.x) * cam.zoom, y: cy - (wy - cam.y) * cam.zoom };
    }

    /* ── Draw grid ── */
    function drawGrid() {
      if (!showGrid) return;
      const w = canvas.width, h = canvas.height;

      // Calculate grid spacing that looks reasonable at current zoom
      let gridSize = 1;
      const pixelSpacing = gridSize * cam.zoom;
      if (pixelSpacing < 10) gridSize = Math.pow(10, Math.ceil(Math.log10(10 / cam.zoom)));
      else if (pixelSpacing > 200) gridSize = Math.pow(10, Math.floor(Math.log10(200 / cam.zoom)));

      // Visible world range
      const left = cam.x - w / (2 * cam.zoom);
      const right = cam.x + w / (2 * cam.zoom);
      const bottom = cam.y - h / (2 * cam.zoom);
      const top = cam.y + h / (2 * cam.zoom);

      ctx.strokeStyle = '#27272a';
      ctx.lineWidth = 0.5;
      ctx.beginPath();

      const startX = Math.floor(left / gridSize) * gridSize;
      const startY = Math.floor(bottom / gridSize) * gridSize;

      for (let x = startX; x <= right; x += gridSize) {
        const s = worldToScreen(x, 0);
        ctx.moveTo(s.x, 0); ctx.lineTo(s.x, h);
      }
      for (let y = startY; y <= top; y += gridSize) {
        const s = worldToScreen(0, y);
        ctx.moveTo(0, s.y); ctx.lineTo(w, s.y);
      }
      ctx.stroke();

      // Draw origin axes
      ctx.lineWidth = 1;
      const o = worldToScreen(0, 0);
      ctx.strokeStyle = '#3f3f4680';
      ctx.beginPath(); ctx.moveTo(o.x, 0); ctx.lineTo(o.x, h); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0, o.y); ctx.lineTo(w, o.y); ctx.stroke();
    }

    /* ── Render drawables ── */
    function render() {
      const dpr = window.devicePixelRatio || 1;
      const w = viewport.clientWidth, h = viewport.clientHeight;
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      // Clear
      ctx.fillStyle = '#09090b';
      ctx.fillRect(0, 0, w, h);

      drawGrid();

      if (!entities.length) return;

      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      for (const d of entities) {
        ctx.strokeStyle = d.color || '#FFFFFF';
        ctx.fillStyle = d.color || '#FFFFFF';
        ctx.lineWidth = Math.max(1, 1 / cam.zoom * 0.5) * cam.zoom < 2 ? 1 : 1.5;

        switch (d.type) {
          case 'line': {
            const a = worldToScreen(d.x1, d.y1), b = worldToScreen(d.x2, d.y2);
            ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
            break;
          }
          case 'circle': {
            const c = worldToScreen(d.cx, d.cy);
            ctx.beginPath(); ctx.arc(c.x, c.y, d.r * cam.zoom, 0, Math.PI * 2); ctx.stroke();
            break;
          }
          case 'arc': {
            const c = worldToScreen(d.cx, d.cy);
            // DXF arcs go counter-clockwise; canvas arcs go clockwise by default
            ctx.beginPath(); ctx.arc(c.x, c.y, d.r * cam.zoom, -d.ea, -d.sa); ctx.stroke();
            break;
          }
          case 'ellipse': {
            const c = worldToScreen(d.cx, d.cy);
            const a = Math.sqrt(d.mx * d.mx + d.my * d.my) * cam.zoom;
            const b = a * d.ratio;
            const rot = Math.atan2(d.my, d.mx);
            ctx.beginPath(); ctx.ellipse(c.x, c.y, a, b, -rot, -d.ea, -d.sa, true); ctx.stroke();
            break;
          }
          case 'polyline': {
            if (d.pts.length < 2) break;
            ctx.beginPath();
            const first = worldToScreen(d.pts[0].x, d.pts[0].y);
            ctx.moveTo(first.x, first.y);
            for (let j = 1; j < d.pts.length; j++) {
              const p = worldToScreen(d.pts[j].x, d.pts[j].y);
              const prevBulge = d.pts[j - 1].bulge;
              if (prevBulge && Math.abs(prevBulge) > 1e-6) {
                // Bulge arc
                const prev = d.pts[j - 1];
                const cur = d.pts[j];
                const dx = cur.x - prev.x, dy = cur.y - prev.y;
                const chord = Math.sqrt(dx * dx + dy * dy);
                const sagitta = Math.abs(prevBulge) * chord / 2;
                const r = (chord * chord / 4 + sagitta * sagitta) / (2 * sagitta);
                const sp = worldToScreen(prev.x, prev.y);
                const ep = worldToScreen(cur.x, cur.y);
                const midX = (sp.x + ep.x) / 2, midY = (sp.y + ep.y) / 2;
                const screenDx = ep.x - sp.x, screenDy = ep.y - sp.y;
                const screenChord = Math.sqrt(screenDx * screenDx + screenDy * screenDy);
                if (screenChord > 0.5) {
                  const screenR = r * cam.zoom;
                  const h = Math.sqrt(Math.max(0, screenR * screenR - screenChord * screenChord / 4));
                  const sign = prevBulge > 0 ? 1 : -1;
                  const cx = midX + sign * h * (-screenDy / screenChord);
                  const cy = midY + sign * h * (screenDx / screenChord);
                  const startAngle = Math.atan2(sp.y - cy, sp.x - cx);
                  const endAngle = Math.atan2(ep.y - cy, ep.x - cx);
                  ctx.arc(cx, cy, Math.abs(screenR), startAngle, endAngle, prevBulge < 0);
                } else {
                  ctx.lineTo(ep.x, ep.y);
                }
              } else {
                ctx.lineTo(p.x, p.y);
              }
            }
            if (d.closed) ctx.closePath();
            ctx.stroke();
            break;
          }
          case 'point': {
            const p = worldToScreen(d.x, d.y);
            ctx.fillRect(p.x - 1.5, p.y - 1.5, 3, 3);
            break;
          }
          case 'text': {
            const p = worldToScreen(d.x, d.y);
            const fontSize = Math.max(8, d.height * cam.zoom * 0.8);
            if (fontSize < 4) break; // Too small to render
            ctx.font = `${Math.min(fontSize, 48)}px "JetBrains Mono", monospace`;
            ctx.fillText(d.text, p.x, p.y);
            break;
          }
        }
      }

      // Update zoom display
      zoomEl.textContent = Math.round(cam.zoom * 100) + '%';
    }

    /* ── Load DXF file ── */
    function loadDXF(text, fileName) {
      loadingEl.classList.remove('hidden'); loadingEl.classList.add('flex');
      requestAnimationFrame(() => {
        try {
          const parsed = parseDXF(text);
          entities = buildDrawables(parsed);
          layers = parsed.layers;
          bounds = computeBounds(entities);
          dxfLoaded = true;

          emptyState.classList.add('hidden');
          hintEl.classList.remove('hidden');
          infoEl.classList.remove('hidden');

          $('dxf-entity-count').textContent = entities.length;
          $('dxf-layer-count').textContent = Object.keys(layers).length || '1';
          const bw = (bounds.maxX - bounds.minX).toFixed(1);
          const bh = (bounds.maxY - bounds.minY).toFixed(1);
          $('dxf-bounds').textContent = `${bw} × ${bh}`;

          // Update file badge
          const badge = $('file-badge');
          badge.textContent = fileName;
          badge.classList.remove('hidden');

          fitView();
          toastDxf('Loaded ' + fileName, 'success');
        } catch (err) {
          console.error('DXF parse error:', err);
          toastDxf('Failed to parse DXF: ' + err.message, 'error');
        } finally {
          loadingEl.classList.add('hidden'); loadingEl.classList.remove('flex');
        }
      });
    }

    function toastDxf(msg, type) {
      const c = { info: 'border-amber-500/50', error: 'border-red-500/50', success: 'border-green-500/50' };
      const el = document.createElement('div');
      el.className = `toast-enter ${c[type] || c.info} border bg-zinc-900 rounded-lg px-4 py-2 text-xs font-mono text-zinc-300 shadow-lg max-w-xs`;
      el.textContent = msg;
      $('toasts').appendChild(el);
      setTimeout(() => { el.style.transition = 'opacity .3s'; el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
    }

    /* ── File input ── */
    $('btn-open-dxf').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => loadDXF(reader.result, file.name);
      reader.readAsText(file);
      fileInput.value = '';
    });

    /* ── Drag & drop ── */
    viewport.addEventListener('dragenter', e => {
      e.preventDefault();
      if (!$('view-dxf').classList.contains('hidden')) {
        dragOverlay.classList.remove('hidden'); dragOverlay.classList.add('flex');
      }
    });
    viewport.addEventListener('dragover', e => e.preventDefault());
    viewport.addEventListener('dragleave', e => {
      if (e.relatedTarget && viewport.contains(e.relatedTarget)) return;
      dragOverlay.classList.add('hidden'); dragOverlay.classList.remove('flex');
    });
    viewport.addEventListener('drop', e => {
      e.preventDefault();
      dragOverlay.classList.add('hidden'); dragOverlay.classList.remove('flex');
      if ($('view-dxf').classList.contains('hidden')) return;
      const file = e.dataTransfer.files[0];
      if (file && file.name.toLowerCase().endsWith('.dxf')) {
        const reader = new FileReader();
        reader.onload = () => loadDXF(reader.result, file.name);
        reader.readAsText(file);
      }
    });

    /* ── Pan & Zoom ── */
    let isPanning = false, panStart = { x: 0, y: 0 };

    canvas.addEventListener('wheel', e => {
      if ($('view-dxf').classList.contains('hidden')) return;
      e.preventDefault();
      const factor = e.deltaY > 0 ? 0.9 : 1.1;
      // Zoom toward mouse position
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left, my = e.clientY - rect.top;
      const cx = canvas.width / (2 * (window.devicePixelRatio || 1));
      const cy = canvas.height / (2 * (window.devicePixelRatio || 1));
      const wx = cam.x + (mx - cx) / cam.zoom;
      const wy = cam.y - (my - cy) / cam.zoom;

      cam.zoom *= factor;
      cam.zoom = Math.max(0.001, Math.min(cam.zoom, 1e6));

      cam.x = wx - (mx - cx) / cam.zoom;
      cam.y = wy + (my - cy) / cam.zoom;

      render();
    }, { passive: false });

    canvas.addEventListener('mousedown', e => {
      if ($('view-dxf').classList.contains('hidden')) return;
      isPanning = true;
      panStart = { x: e.clientX, y: e.clientY };
      canvas.style.cursor = 'grabbing';
    });
    window.addEventListener('mousemove', e => {
      if (!isPanning) return;
      const dx = e.clientX - panStart.x;
      const dy = e.clientY - panStart.y;
      cam.x -= dx / cam.zoom;
      cam.y += dy / cam.zoom;
      panStart = { x: e.clientX, y: e.clientY };
      render();
    });
    window.addEventListener('mouseup', () => {
      isPanning = false;
      canvas.style.cursor = '';
    });

    // Touch support
    let lastTouchDist = 0;
    canvas.addEventListener('touchstart', e => {
      if ($('view-dxf').classList.contains('hidden')) return;
      if (e.touches.length === 1) {
        isPanning = true;
        panStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      } else if (e.touches.length === 2) {
        lastTouchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
      }
    }, { passive: true });
    canvas.addEventListener('touchmove', e => {
      if ($('view-dxf').classList.contains('hidden')) return;
      e.preventDefault();
      if (e.touches.length === 1 && isPanning) {
        const dx = e.touches[0].clientX - panStart.x;
        const dy = e.touches[0].clientY - panStart.y;
        cam.x -= dx / cam.zoom;
        cam.y += dy / cam.zoom;
        panStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        render();
      } else if (e.touches.length === 2) {
        const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        if (lastTouchDist > 0) {
          cam.zoom *= dist / lastTouchDist;
          cam.zoom = Math.max(0.001, Math.min(cam.zoom, 1e6));
          render();
        }
        lastTouchDist = dist;
      }
    }, { passive: false });
    canvas.addEventListener('touchend', () => { isPanning = false; lastTouchDist = 0; });

    /* ── Buttons ── */
    $('btn-dxf-fit').addEventListener('click', fitView);
    $('btn-dxf-reset').addEventListener('click', resetView);
    $('btn-dxf-grid').addEventListener('click', () => { showGrid = !showGrid; render(); });

    $('btn-dxf-screenshot').addEventListener('click', () => {
      if (!dxfLoaded) return;
      const link = document.createElement('a');
      link.download = 'dxf-screenshot.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    /* ── G-code export ── */
    const gcModal = $('gcode-modal');
    let gcMode = 'laser'; // 'laser' or 'cnc'

    function openGcodeModal() {
      if (!dxfLoaded) { toastDxf('Load a DXF file first', 'error'); return; }
      gcModal.classList.remove('hidden');
      gcModal.classList.add('flex');
    }
    function closeGcodeModal() {
      gcModal.classList.add('hidden');
      gcModal.classList.remove('flex');
    }

    $('btn-dxf-gcode').addEventListener('click', openGcodeModal);
    $('btn-gcode-close').addEventListener('click', closeGcodeModal);
    $('btn-gcode-cancel').addEventListener('click', closeGcodeModal);
    gcModal.addEventListener('click', e => { if (e.target === gcModal) closeGcodeModal(); });

    // Mode toggle
    $('gc-mode-laser').addEventListener('click', () => {
      gcMode = 'laser';
      $('gc-mode-laser').className = 'flex-1 bg-amber-500/10 border border-amber-500/30 text-amber-400 font-mono px-3 py-2 rounded-lg text-xs transition-colors';
      $('gc-mode-cnc').className = 'flex-1 bg-zinc-800 border border-zinc-700 text-zinc-400 font-mono px-3 py-2 rounded-lg text-xs transition-colors';
      $('gc-laser-settings').classList.remove('hidden');
      $('gc-cnc-settings').classList.add('hidden');
      $('gc-info-note').innerHTML = 'Marlin laser mode: uses M4/M3 inline laser control with S parameter. Laser turns on during G1 cuts and off during G0 travel moves. Enable <span class="text-amber-400">LASER_FEATURE</span> in Marlin firmware.';
    });
    $('gc-mode-cnc').addEventListener('click', () => {
      gcMode = 'cnc';
      $('gc-mode-cnc').className = 'flex-1 bg-amber-500/10 border border-amber-500/30 text-amber-400 font-mono px-3 py-2 rounded-lg text-xs transition-colors';
      $('gc-mode-laser').className = 'flex-1 bg-zinc-800 border border-zinc-700 text-zinc-400 font-mono px-3 py-2 rounded-lg text-xs transition-colors';
      $('gc-cnc-settings').classList.remove('hidden');
      $('gc-laser-settings').classList.add('hidden');
      $('gc-info-note').textContent = 'CNC mode: uses spindle M3/M5, plunge Z for cutting, and safe Z for travel. Multi-pass supported with total depth and depth per pass.';
    });

    // Flatten drawables into toolpath segments (arrays of {x,y} points)
    function flattenToToolpaths() {
      const paths = [];
      for (const d of entities) {
        switch (d.type) {
          case 'line':
            paths.push([{ x: d.x1, y: d.y1 }, { x: d.x2, y: d.y2 }]);
            break;
          case 'circle': {
            const pts = [];
            const steps = Math.max(36, Math.ceil(d.r * 4));
            for (let i = 0; i <= steps; i++) {
              const a = (i / steps) * Math.PI * 2;
              pts.push({ x: d.cx + d.r * Math.cos(a), y: d.cy + d.r * Math.sin(a) });
            }
            paths.push(pts);
            break;
          }
          case 'arc': {
            const pts = [];
            let sa = d.sa, ea = d.ea;
            if (ea <= sa) ea += Math.PI * 2;
            const steps = Math.max(16, Math.ceil((ea - sa) / (Math.PI / 36)));
            for (let i = 0; i <= steps; i++) {
              const a = sa + (ea - sa) * i / steps;
              pts.push({ x: d.cx + d.r * Math.cos(a), y: d.cy + d.r * Math.sin(a) });
            }
            paths.push(pts);
            break;
          }
          case 'ellipse': {
            const pts = [];
            const a = Math.sqrt(d.mx * d.mx + d.my * d.my);
            const b = a * (d.ratio || 1);
            const rot = Math.atan2(d.my, d.mx);
            let sa = d.sa || 0, ea = d.ea || Math.PI * 2;
            if (ea <= sa) ea += Math.PI * 2;
            const steps = Math.max(36, Math.ceil((ea - sa) / (Math.PI / 36)));
            for (let i = 0; i <= steps; i++) {
              const t = sa + (ea - sa) * i / steps;
              const lx = a * Math.cos(t), ly = b * Math.sin(t);
              pts.push({ x: d.cx + lx * Math.cos(rot) - ly * Math.sin(rot), y: d.cy + lx * Math.sin(rot) + ly * Math.cos(rot) });
            }
            paths.push(pts);
            break;
          }
          case 'polyline': {
            if (d.pts.length < 2) break;
            const pts = [];
            for (let j = 0; j < d.pts.length; j++) {
              const cur = d.pts[j];
              if (j > 0 && d.pts[j - 1].bulge && Math.abs(d.pts[j - 1].bulge) > 1e-6) {
                // Interpolate bulge arc
                const prev = d.pts[j - 1];
                const dx = cur.x - prev.x, dy = cur.y - prev.y;
                const chord = Math.sqrt(dx * dx + dy * dy);
                if (chord < 1e-10) { pts.push({ x: cur.x, y: cur.y }); continue; }
                const s = Math.abs(prev.bulge) * chord / 2;
                const r = (chord * chord / 4 + s * s) / (2 * s);
                const midX = (prev.x + cur.x) / 2, midY = (prev.y + cur.y) / 2;
                const h = Math.sqrt(Math.max(0, r * r - chord * chord / 4));
                const sign = prev.bulge > 0 ? 1 : -1;
                const nx = -dy / chord, ny = dx / chord;
                const cx = midX + sign * h * nx, cy = midY + sign * h * ny;
                const sa = Math.atan2(prev.y - cy, prev.x - cx);
                const ea = Math.atan2(cur.y - cy, cur.x - cx);
                let sweep = ea - sa;
                if (prev.bulge > 0 && sweep < 0) sweep += Math.PI * 2;
                if (prev.bulge < 0 && sweep > 0) sweep -= Math.PI * 2;
                const arcSteps = Math.max(8, Math.ceil(Math.abs(sweep) / (Math.PI / 18)));
                for (let k = 1; k <= arcSteps; k++) {
                  const a = sa + sweep * k / arcSteps;
                  pts.push({ x: cx + Math.abs(r) * Math.cos(a), y: cy + Math.abs(r) * Math.sin(a) });
                }
              } else {
                pts.push({ x: cur.x, y: cur.y });
              }
            }
            if (d.closed && pts.length > 1) {
              pts.push({ x: pts[0].x, y: pts[0].y });
            }
            if (pts.length >= 2) paths.push(pts);
            break;
          }
        }
      }
      return paths;
    }

    function f(v) { return v.toFixed(3); }

    function generateLaserGcode() {
      const power = parseInt($('gc-laser-power').value) || 255;
      const cutFeed = parseInt($('gc-laser-feed').value) || 300;
      const travelFeed = parseInt($('gc-laser-travel').value) || 1500;
      const passes = parseInt($('gc-laser-passes').value) || 1;
      const laserCmd = document.querySelector('input[name="gc-laser-mode"]:checked')?.value || 'M4';

      const paths = flattenToToolpaths();
      if (!paths.length) return null;

      const lines = [];
      lines.push('; Generated by Model Studio — DXF to G-code (Marlin Laser)');
      lines.push('; Date: ' + new Date().toISOString());
      lines.push('; Entities: ' + entities.length + ', Paths: ' + paths.length);
      lines.push('; Laser power: S' + power + ', Cut feed: F' + cutFeed + ', Travel: F' + travelFeed);
      lines.push('');
      lines.push('G21 ; mm units');
      lines.push('G90 ; absolute positioning');
      lines.push(`${laserCmd} S0 ; enable laser mode (${laserCmd === 'M4' ? 'dynamic' : 'constant'}), power off`);
      lines.push('G0 F' + travelFeed);
      lines.push('G28 ; home all axes');
      lines.push('');

      for (let pass = 0; pass < passes; pass++) {
        if (passes > 1) lines.push(`; --- Pass ${pass + 1} of ${passes} ---`);

        for (const path of paths) {
          // Travel to start
          lines.push(`G0 X${f(path[0].x)} Y${f(path[0].y)} S0`);
          // Cut path with laser on
          for (let i = 1; i < path.length; i++) {
            lines.push(`G1 X${f(path[i].x)} Y${f(path[i].y)} S${power} F${cutFeed}`);
          }
          // Laser off after path
          lines.push('G0 S0');
        }

        if (passes > 1) lines.push('');
      }

      lines.push('');
      lines.push('G0 X0 Y0 S0 ; return to origin');
      lines.push('M5 ; laser off');
      lines.push('M84 ; disable steppers');
      return lines.join('\n');
    }

    function generateCncGcode() {
      const feedXY = parseInt($('gc-feed-xy').value) || 800;
      const feedZ = parseInt($('gc-feed-z').value) || 300;
      const safeZ = parseFloat($('gc-safe-z').value) || 5;
      const totalDepth = parseFloat($('gc-total-depth').value) || -1;
      const passDepth = parseFloat($('gc-pass-depth').value) || 1;
      const spindle = parseInt($('gc-spindle').value) || 12000;

      const paths = flattenToToolpaths();
      if (!paths.length) return null;

      const numPasses = Math.max(1, Math.ceil(Math.abs(totalDepth) / passDepth));

      const lines = [];
      lines.push('; Generated by Model Studio — DXF to G-code (CNC)');
      lines.push('; Date: ' + new Date().toISOString());
      lines.push('; Entities: ' + entities.length + ', Paths: ' + paths.length);
      lines.push('');
      lines.push('G21 ; mm units');
      lines.push('G90 ; absolute positioning');
      lines.push('M3 S' + spindle + ' ; spindle on');
      lines.push('G4 P2 ; dwell 2s for spindle');
      lines.push(`G0 Z${f(safeZ)} ; raise to safe Z`);
      lines.push('');

      for (let pass = 0; pass < numPasses; pass++) {
        const cutZ = -Math.min((pass + 1) * passDepth, Math.abs(totalDepth));
        lines.push(`; --- Pass ${pass + 1} of ${numPasses}, Z=${f(cutZ)} ---`);

        for (const path of paths) {
          lines.push(`G0 Z${f(safeZ)} F${feedZ}`);
          lines.push(`G0 X${f(path[0].x)} Y${f(path[0].y)} F${feedXY}`);
          lines.push(`G1 Z${f(cutZ)} F${feedZ}`);
          for (let i = 1; i < path.length; i++) {
            lines.push(`G1 X${f(path[i].x)} Y${f(path[i].y)} F${feedXY}`);
          }
        }

        lines.push('');
      }

      lines.push(`G0 Z${f(safeZ)} F${feedZ} ; retract`);
      lines.push('G0 X0 Y0 ; return to origin');
      lines.push('M5 ; spindle off');
      return lines.join('\n');
    }

    $('btn-gcode-export').addEventListener('click', () => {
      const gcode = gcMode === 'laser' ? generateLaserGcode() : generateCncGcode();
      if (!gcode) { toastDxf('No geometry to export', 'error'); return; }

      const blob = new Blob([gcode], { type: 'text/plain' });
      const link = document.createElement('a');
      link.download = 'output.gcode';
      link.href = URL.createObjectURL(blob);
      link.click();
      URL.revokeObjectURL(link.href);
      closeGcodeModal();
      toastDxf('G-code exported', 'success');
    });

    /* ── Keyboard shortcuts (when DXF tab is active) ── */
    document.addEventListener('keydown', e => {
      if ($('view-dxf').classList.contains('hidden')) return;
      if (['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
      const k = e.key.toLowerCase();
      if (k === 'f') fitView();
      else if (k === 'r') resetView();
      else if (k === 'g') { showGrid = !showGrid; render(); }
      else if (k === 's' && !e.ctrlKey && !e.metaKey) $('btn-dxf-screenshot').click();
    });

    /* ── Resize ── */
    function onResize() {
      if ($('view-dxf').classList.contains('hidden')) return;
      render();
    }
    window.addEventListener('resize', onResize);
    new ResizeObserver(onResize).observe(viewport);
    window.addEventListener('dxf-tab-activated', () => { requestAnimationFrame(render); });

    // Initial render
    render();
  })();
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
