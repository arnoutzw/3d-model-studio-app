<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>3D Model Viewer</title>
  <meta name="description" content="View and inspect STL and 3MF 3D printing files in the browser">
  <meta name="theme-color" content="#09090b">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <link rel="apple-touch-icon" href="icon.svg">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          }
        }
      }
    }
  </script>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/"
    }
  }
  </script>

  <style>
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #18181b; }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }
    canvas { display: block; outline: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .anim-spin { animation: spin 1s linear infinite; }
    @keyframes toast-in {
      from { transform: translateX(120%); opacity: 0; }
      to   { transform: translateX(0); opacity: 1; }
    }
    .toast-enter { animation: toast-in 0.3s ease-out forwards; }
    @keyframes pulse-border {
      0%, 100% { border-color: rgba(245,158,11,0.3); }
      50%      { border-color: rgba(245,158,11,0.7); }
    }
    .drag-pulse { animation: pulse-border 1s ease-in-out infinite; }
    /* Toggle switch styles */
    .toggle-track { transition: background-color 0.2s; }
    .toggle-dot   { transition: left 0.2s; }
    input:checked ~ .toggle-track { background-color: #f59e0b; }
    input:checked ~ .toggle-dot   { left: 14px; }
    /* Tab styles */
    .tab-btn { position: relative; }
    .tab-btn.active::after { content: ''; position: absolute; bottom: -2.5px; left: 0; right: 0; height: 2px; background: #f59e0b; border-radius: 1px; }
    /* Spool card */
    .spool-card { transition: transform 0.15s, box-shadow 0.15s; }
    .spool-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    /* Spool ring visualization */
    .spool-ring { border-radius: 50%; position: relative; }
    .spool-ring::after { content: ''; position: absolute; top: 30%; left: 30%; width: 40%; height: 40%; border-radius: 50%; background: #18181b; }
    /* Material badge colors */
    .mat-pla  { background: rgba(34,197,94,0.12); color: #4ade80; }
    .mat-abs  { background: rgba(239,68,68,0.12); color: #f87171; }
    .mat-petg { background: rgba(59,130,246,0.12); color: #60a5fa; }
    .mat-tpu  { background: rgba(168,85,247,0.12); color: #c084fc; }
    .mat-nylon { background: rgba(251,191,36,0.12); color: #fbbf24; }
    .mat-asa  { background: rgba(251,146,60,0.12); color: #fb923c; }
    .mat-pc   { background: rgba(45,212,191,0.12); color: #2dd4bf; }
    .mat-hips { background: rgba(156,163,175,0.12); color: #9ca3af; }
    .mat-pva  { background: rgba(129,140,248,0.12); color: #818cf8; }
    .mat-pp   { background: rgba(253,224,71,0.12); color: #fde047; }
    .mat-cf   { background: rgba(161,161,170,0.12); color: #a1a1aa; }
    .mat-wood { background: rgba(180,83,9,0.12); color: #d97706; }
    .mat-metal { background: rgba(148,163,184,0.12); color: #94a3b8; }
    .mat-pla-plus { background: rgba(16,185,129,0.12); color: #34d399; }
    .mat-silk { background: rgba(244,114,182,0.12); color: #f472b6; }
    .mat-other { background: rgba(113,113,122,0.12); color: #71717a; }
    /* Modal */
    .modal-backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    /* Weight bar */
    .weight-bar { transition: width 0.4s ease-out; }
  </style>
</head>

<body class="bg-zinc-950 text-zinc-100 font-sans overflow-hidden select-none">

  <!-- ===== HEADER ===== -->
  <header class="sticky top-0 z-40 bg-zinc-900/80 backdrop-blur-sm border-b border-zinc-800">
    <div class="px-4 py-2.5 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3 min-w-0">
        <div class="flex gap-1.5 flex-shrink-0">
          <div class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
          <div class="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
          <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
        </div>
        <h1 class="font-mono font-bold text-amber-500 text-sm truncate">3D Model Viewer</h1>
        <span id="file-badge" class="hidden text-xs px-2 py-0.5 bg-amber-500/10 text-amber-400 rounded font-mono truncate max-w-[200px]"></span>
      </div>
      <!-- Tab navigation -->
      <div class="flex items-center gap-1 bg-zinc-800/50 rounded-lg p-0.5">
        <button id="tab-viewer" class="tab-btn active font-mono text-xs px-3 py-1.5 rounded-md transition-colors text-amber-400">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
            Viewer
          </span>
        </button>
        <button id="tab-filaments" class="tab-btn font-mono text-xs px-3 py-1.5 rounded-md transition-colors text-zinc-500 hover:text-zinc-300">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="12" y1="2" x2="12" y2="8"/><line x1="12" y1="16" x2="12" y2="22"/></svg>
            Filaments
          </span>
        </button>
      </div>

      <div class="flex items-center gap-1.5 flex-shrink-0">
        <button id="btn-open" class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-3 py-1.5 rounded-lg text-xs transition-colors flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Open
        </button>
        <input type="file" id="file-input" class="hidden" accept=".stl,.3mf">
        <button id="btn-screenshot" class="text-zinc-400 hover:text-amber-400 hover:bg-zinc-800 p-1.5 rounded-lg transition-colors" title="Screenshot (S)">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </button>
        <button id="btn-panel" class="text-zinc-400 hover:text-amber-400 hover:bg-zinc-800 p-1.5 rounded-lg transition-colors" title="Toggle panel (P)">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
        </button>
        <button id="btn-install" class="hidden bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors">Install</button>
      </div>
    </div>
  </header>

  <!-- ===== MAIN: VIEWER TAB ===== -->
  <main id="view-viewer" class="flex" style="height:calc(100vh - 45px)">

    <!-- Viewport -->
    <div id="viewport" class="flex-1 relative bg-zinc-950 overflow-hidden">

      <!-- Empty state -->
      <div id="empty-state" class="absolute inset-0 flex items-center justify-center pointer-events-none z-[5]">
        <div class="text-center p-8">
          <svg class="w-16 h-16 mx-auto text-zinc-700 mb-4" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/>
          </svg>
          <p class="font-mono text-zinc-500 text-sm mb-1">Drop STL or 3MF file here</p>
          <p class="text-xs text-zinc-600">or click <span class="text-amber-500/70 font-mono">Open</span> to browse</p>
        </div>
      </div>

      <!-- Drag overlay -->
      <div id="drag-overlay" class="absolute inset-4 hidden items-center justify-center bg-zinc-950/90 backdrop-blur-sm border-2 border-dashed border-amber-500/50 rounded-xl z-20 drag-pulse">
        <div class="text-center">
          <svg class="w-10 h-10 mx-auto text-amber-500 mb-2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          <p class="font-mono text-amber-400 text-sm">Drop to load model</p>
        </div>
      </div>

      <!-- Loading overlay -->
      <div id="loading-overlay" class="absolute inset-0 hidden items-center justify-center bg-zinc-950/80 backdrop-blur-sm z-20">
        <div class="text-center">
          <svg class="w-8 h-8 mx-auto text-amber-500 anim-spin mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 2v4m0 12v4m-7.07-3.93l2.83-2.83m8.48-8.48l2.83-2.83M2 12h4m12 0h4m-3.93 7.07l-2.83-2.83M6.34 6.34L3.51 3.51"/>
          </svg>
          <p class="font-mono text-zinc-400 text-xs">Loading model…</p>
        </div>
      </div>

      <!-- FPS overlay -->
      <div id="fps-overlay" class="absolute bottom-2 left-3 text-[10px] font-mono text-zinc-700"></div>

      <!-- Controls hint -->
      <div id="controls-hint" class="absolute bottom-2 right-3 text-[10px] font-mono text-zinc-700 hidden">
        LMB Rotate · RMB Pan · Scroll Zoom
      </div>
    </div>

    <!-- ===== SIDE PANEL ===== -->
    <aside id="panel" class="w-[268px] border-l border-zinc-800 bg-zinc-900 overflow-y-auto flex-shrink-0">
      <div class="p-4 space-y-4">

        <!-- Model Info -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2.5">Model Info</h3>
          <div id="model-info" class="space-y-1.5 text-xs font-mono">
            <p class="text-zinc-600 italic">No model loaded</p>
          </div>
        </section>

        <hr class="border-zinc-800">

        <!-- View Controls -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2.5">View</h3>
          <div class="space-y-2">
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Grid</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-grid" class="sr-only" checked>
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Axes</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-axes" class="sr-only" checked>
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Wireframe</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-wire" class="sr-only">
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Auto-rotate</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-rotate" class="sr-only">
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="text-xs text-zinc-300">Flat shading</span>
              <div class="relative w-8 h-[18px]">
                <input type="checkbox" id="chk-flat" class="sr-only">
                <div class="toggle-track w-8 h-[18px] rounded-full bg-zinc-700 absolute inset-0"></div>
                <div class="toggle-dot w-3.5 h-3.5 rounded-full bg-white absolute top-[2px] left-[2px]"></div>
              </div>
            </label>
          </div>
        </section>

        <hr class="border-zinc-800">

        <!-- Material -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2.5">Material</h3>
          <div class="space-y-3">
            <div>
              <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Color</label>
              <div class="flex gap-1.5 flex-wrap">
                <button data-color="#a0a0a8" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#a0a0a8" title="Gray"></button>
                <button data-color="#f59e0b" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#f59e0b" title="Amber"></button>
                <button data-color="#3b82f6" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#3b82f6" title="Blue"></button>
                <button data-color="#22c55e" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#22c55e" title="Green"></button>
                <button data-color="#ef4444" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#ef4444" title="Red"></button>
                <button data-color="#ffffff" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#ffffff" title="White"></button>
                <button data-color="#1a1a2e" class="clr-btn w-6 h-6 rounded border-2 border-zinc-700 hover:border-amber-500 transition-colors" style="background:#1a1a2e" title="Dark"></button>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-1"><label class="text-[10px] text-zinc-500 font-mono">Roughness</label><span id="val-rough" class="text-[10px] text-zinc-600 font-mono">0.50</span></div>
              <input type="range" id="sld-rough" min="0" max="100" value="50" class="w-full h-1 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-amber-500">
            </div>
            <div>
              <div class="flex justify-between mb-1"><label class="text-[10px] text-zinc-500 font-mono">Metalness</label><span id="val-metal" class="text-[10px] text-zinc-600 font-mono">0.15</span></div>
              <input type="range" id="sld-metal" min="0" max="100" value="15" class="w-full h-1 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-amber-500">
            </div>
          </div>
        </section>

        <hr class="border-zinc-800">

        <!-- Actions -->
        <section class="space-y-1.5">
          <button id="btn-reset" class="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-xs font-mono px-3 py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
            Reset View
          </button>
          <button id="btn-fit" class="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-xs font-mono px-3 py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
            Fit to View
          </button>
        </section>

        <hr class="border-zinc-800">

        <!-- Shortcuts -->
        <section>
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-2">Shortcuts</h3>
          <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-0.5 text-[11px] font-mono">
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">1</kbd><span class="text-zinc-500">Viewer tab</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">2</kbd><span class="text-zinc-500">Filaments tab</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">R</kbd><span class="text-zinc-500">Reset view</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">F</kbd><span class="text-zinc-500">Fit to view</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">W</kbd><span class="text-zinc-500">Wireframe</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">G</kbd><span class="text-zinc-500">Grid</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">A</kbd><span class="text-zinc-500">Axes</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">⎵</kbd><span class="text-zinc-500">Auto-rotate</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">S</kbd><span class="text-zinc-500">Screenshot</span>
            <kbd class="text-zinc-600 bg-zinc-800 px-1 rounded text-center">P</kbd><span class="text-zinc-500">Panel</span>
          </div>
        </section>

      </div>
    </aside>
  </main>

  <!-- ===== MAIN: FILAMENT INVENTORY TAB ===== -->
  <div id="view-filaments" class="hidden" style="height:calc(100vh - 45px)">
    <div class="h-full overflow-y-auto">
      <div class="max-w-6xl mx-auto p-6">

        <!-- Header row -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
          <div>
            <h2 class="font-mono font-bold text-lg text-zinc-100">Filament Inventory</h2>
            <p class="text-xs text-zinc-500 font-mono mt-0.5">Track your 3D printing filament stock</p>
          </div>
          <button id="btn-add-filament" class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2 rounded-lg text-xs transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Filament
          </button>
        </div>

        <!-- Stats bar -->
        <div id="filament-stats" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
          <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-3">
            <p class="text-[10px] font-mono text-zinc-500 uppercase tracking-wider">Total Spools</p>
            <p id="stat-total" class="text-xl font-mono font-bold text-zinc-100 mt-1">0</p>
          </div>
          <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-3">
            <p class="text-[10px] font-mono text-zinc-500 uppercase tracking-wider">Materials</p>
            <p id="stat-materials" class="text-xl font-mono font-bold text-zinc-100 mt-1">0</p>
          </div>
          <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-3">
            <p class="text-[10px] font-mono text-zinc-500 uppercase tracking-wider">Total Weight</p>
            <p id="stat-weight" class="text-xl font-mono font-bold text-zinc-100 mt-1">0 kg</p>
          </div>
          <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-3">
            <p class="text-[10px] font-mono text-zinc-500 uppercase tracking-wider">Colors</p>
            <p id="stat-colors" class="text-xl font-mono font-bold text-zinc-100 mt-1">0</p>
          </div>
        </div>

        <!-- Color palette overview -->
        <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-4 mb-6">
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-3">Color Palette</h3>
          <div id="color-palette" class="flex flex-wrap gap-1.5 min-h-[32px]">
            <p class="text-xs text-zinc-600 font-mono italic">No filaments yet</p>
          </div>
        </div>

        <!-- Material breakdown -->
        <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-4 mb-6">
          <h3 class="font-mono font-bold text-[11px] text-zinc-500 uppercase tracking-wider mb-3">Material Breakdown</h3>
          <div id="material-breakdown" class="space-y-2">
            <p class="text-xs text-zinc-600 font-mono italic">No filaments yet</p>
          </div>
        </div>

        <!-- Filter & search bar -->
        <div class="flex flex-col sm:flex-row gap-3 mb-4">
          <div class="relative flex-1">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-zinc-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input id="filament-search" type="text" placeholder="Search filaments..." class="w-full bg-zinc-900 border border-zinc-800 rounded-lg pl-9 pr-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50">
          </div>
          <div class="flex gap-2 flex-wrap">
            <button data-filter="all" class="filter-btn active bg-amber-500/10 text-amber-400 text-[11px] font-mono px-3 py-1.5 rounded-lg border border-amber-500/20 transition-colors">All</button>
            <div id="filter-buttons" class="flex gap-2 flex-wrap"></div>
          </div>
        </div>

        <!-- Filament grid -->
        <div id="filament-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
          <!-- Cards rendered by JS -->
        </div>

        <!-- Empty state for filaments -->
        <div id="filament-empty" class="text-center py-16">
          <svg class="w-16 h-16 mx-auto text-zinc-700 mb-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="12" y1="2" x2="12" y2="8"/><line x1="12" y1="16" x2="12" y2="22"/></svg>
          <p class="font-mono text-zinc-500 text-sm mb-1">No filaments in inventory</p>
          <p class="text-xs text-zinc-600">Click <span class="text-amber-500/70 font-mono">Add Filament</span> to get started</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ADD/EDIT FILAMENT MODAL ===== -->
  <div id="filament-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-zinc-900 border border-zinc-800 rounded-xl shadow-2xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-5">
        <div class="flex items-center justify-between mb-5">
          <h3 id="modal-title" class="font-mono font-bold text-sm text-zinc-100">Add Filament</h3>
          <button id="btn-modal-close" class="text-zinc-500 hover:text-zinc-300 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <form id="filament-form" class="space-y-4">
          <input type="hidden" id="ff-id">

          <!-- Color preview + picker -->
          <div>
            <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Color</label>
            <div class="flex items-center gap-3">
              <div id="ff-color-preview" class="w-12 h-12 rounded-lg border-2 border-zinc-700 spool-ring" style="background:#a0a0a8"></div>
              <div class="flex-1 space-y-2">
                <input type="color" id="ff-color" value="#a0a0a8" class="w-full h-8 bg-zinc-800 border border-zinc-700 rounded cursor-pointer">
                <input type="text" id="ff-color-name" placeholder="Color name (e.g. Galaxy Blue)" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-1.5 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50">
              </div>
            </div>
          </div>

          <!-- Material type -->
          <div>
            <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Material</label>
            <select id="ff-material" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 focus:outline-none focus:border-amber-500/50 appearance-none cursor-pointer">
              <optgroup label="Standard">
                <option value="PLA">PLA</option>
                <option value="PLA+">PLA+</option>
                <option value="PLA Silk">PLA Silk</option>
                <option value="ABS">ABS</option>
                <option value="PETG">PETG</option>
                <option value="TPU">TPU (Flexible)</option>
              </optgroup>
              <optgroup label="Engineering">
                <option value="Nylon">Nylon (PA)</option>
                <option value="ASA">ASA</option>
                <option value="PC">Polycarbonate (PC)</option>
                <option value="HIPS">HIPS</option>
                <option value="PVA">PVA (Soluble)</option>
                <option value="PP">Polypropylene (PP)</option>
                <option value="PEI">PEI (ULTEM)</option>
                <option value="PEEK">PEEK</option>
                <option value="PEKK">PEKK</option>
              </optgroup>
              <optgroup label="Composite">
                <option value="CF-PLA">Carbon Fiber PLA</option>
                <option value="CF-PETG">Carbon Fiber PETG</option>
                <option value="CF-Nylon">Carbon Fiber Nylon</option>
                <option value="CF-ABS">Carbon Fiber ABS</option>
                <option value="CF-PC">Carbon Fiber PC</option>
                <option value="GF-Nylon">Glass Fiber Nylon</option>
                <option value="GF-PP">Glass Fiber PP</option>
              </optgroup>
              <optgroup label="Specialty">
                <option value="Wood">Wood Fill</option>
                <option value="Metal">Metal Fill</option>
                <option value="Marble">Marble Fill</option>
                <option value="Glow">Glow-in-the-Dark</option>
                <option value="HTPLA">HT-PLA (Heat Treated)</option>
                <option value="PHA">PHA</option>
              </optgroup>
              <optgroup label="Resin (SLA/DLP)">
                <option value="Standard Resin">Standard Resin</option>
                <option value="Tough Resin">Tough Resin</option>
                <option value="Flexible Resin">Flexible Resin</option>
                <option value="Water-Washable Resin">Water-Washable Resin</option>
                <option value="ABS-Like Resin">ABS-Like Resin</option>
                <option value="Castable Resin">Castable Resin</option>
                <option value="Dental Resin">Dental Resin</option>
              </optgroup>
              <optgroup label="Other">
                <option value="Other">Other</option>
              </optgroup>
            </select>
          </div>

          <!-- Brand -->
          <div>
            <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Brand</label>
            <input type="text" id="ff-brand" placeholder="e.g. Bambu Lab, Prusament, Hatchbox..." class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50" list="brand-suggestions">
            <datalist id="brand-suggestions">
              <option value="Bambu Lab">
              <option value="Prusament">
              <option value="Hatchbox">
              <option value="eSUN">
              <option value="Overture">
              <option value="Polymaker">
              <option value="Inland">
              <option value="SUNLU">
              <option value="Creality">
              <option value="MatterHackers">
              <option value="3DXTech">
              <option value="ColorFabb">
              <option value="Fillamentum">
              <option value="Proto-pasta">
              <option value="FormFutura">
              <option value="Elegoo">
              <option value="Anycubic">
              <option value="Phrozen">
            </datalist>
          </div>

          <!-- Diameter -->
          <div>
            <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Diameter</label>
            <div class="flex gap-2">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="ff-diameter" value="1.75" checked class="accent-amber-500">
                <span class="text-xs font-mono text-zinc-300">1.75 mm</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="ff-diameter" value="2.85" class="accent-amber-500">
                <span class="text-xs font-mono text-zinc-300">2.85 mm</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="ff-diameter" value="0" class="accent-amber-500">
                <span class="text-xs font-mono text-zinc-300">Resin</span>
              </label>
            </div>
          </div>

          <!-- Weight -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Spool Weight (g)</label>
              <input type="number" id="ff-weight" placeholder="1000" min="0" max="50000" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50">
            </div>
            <div>
              <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Remaining (%)</label>
              <input type="number" id="ff-remaining" value="100" min="0" max="100" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50">
            </div>
          </div>

          <!-- Temps -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Nozzle Temp (°C)</label>
              <input type="number" id="ff-temp-nozzle" placeholder="210" min="0" max="500" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50">
            </div>
            <div>
              <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Bed Temp (°C)</label>
              <input type="number" id="ff-temp-bed" placeholder="60" min="0" max="200" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50">
            </div>
          </div>

          <!-- Notes -->
          <div>
            <label class="text-[10px] text-zinc-500 font-mono block mb-1.5">Notes</label>
            <textarea id="ff-notes" rows="2" placeholder="Optional notes..." class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-xs font-mono text-zinc-300 placeholder-zinc-600 focus:outline-none focus:border-amber-500/50 resize-none"></textarea>
          </div>

          <!-- Buttons -->
          <div class="flex gap-2 pt-2">
            <button type="submit" class="flex-1 bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2 rounded-lg text-xs transition-colors">Save</button>
            <button type="button" id="btn-modal-cancel" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-mono px-4 py-2 rounded-lg text-xs transition-colors">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ===== DELETE CONFIRM MODAL ===== -->
  <div id="delete-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="bg-zinc-900 border border-zinc-800 rounded-xl shadow-2xl w-full max-w-sm mx-4 p-5">
      <h3 class="font-mono font-bold text-sm text-zinc-100 mb-2">Delete Filament</h3>
      <p class="text-xs text-zinc-400 font-mono mb-5">Are you sure you want to remove this filament from your inventory? This cannot be undone.</p>
      <div class="flex gap-2">
        <button id="btn-confirm-delete" class="flex-1 bg-red-500 hover:bg-red-400 text-white font-mono font-bold px-4 py-2 rounded-lg text-xs transition-colors">Delete</button>
        <button id="btn-cancel-delete" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-mono px-4 py-2 rounded-lg text-xs transition-colors">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toasts" class="fixed top-14 right-4 z-50 space-y-2 pointer-events-none"></div>

  <!-- ===== THREE.JS APP ===== -->
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { STLLoader }     from 'three/addons/loaders/STLLoader.js';
    import { ThreeMFLoader } from 'three/addons/loaders/3MFLoader.js';

    /* ── state ── */
    let scene, camera, renderer, controls;
    let gridHelper, axesHelper;
    let currentModel = null;
    let modelMeshes  = [];
    let defaultMat;
    let frameCount = 0, lastFps = 0, fpsTime = 0;

    /* ── DOM refs ── */
    const $  = id => document.getElementById(id);
    const viewport      = $('viewport');
    const emptyState     = $('empty-state');
    const dragOverlay    = $('drag-overlay');
    const loadingOverlay = $('loading-overlay');
    const fpsOverlay     = $('fps-overlay');
    const controlsHint   = $('controls-hint');
    const modelInfo      = $('model-info');
    const fileBadge      = $('file-badge');
    const panel          = $('panel');
    const toastsEl       = $('toasts');

    const fileInput  = $('file-input');
    const chkGrid    = $('chk-grid');
    const chkAxes    = $('chk-axes');
    const chkWire    = $('chk-wire');
    const chkRotate  = $('chk-rotate');
    const chkFlat    = $('chk-flat');
    const sldRough   = $('sld-rough');
    const sldMetal   = $('sld-metal');

    /* ── helpers ── */
    function toast(msg, type = 'info', ms = 3000) {
      const c = { info: 'border-amber-500/50', error: 'border-red-500/50', success: 'border-green-500/50' };
      const el = document.createElement('div');
      el.className = `toast-enter ${c[type]} border bg-zinc-900 rounded-lg px-4 py-2 text-xs font-mono text-zinc-300 shadow-lg max-w-xs`;
      el.textContent = msg;
      toastsEl.appendChild(el);
      setTimeout(() => { el.style.transition = 'opacity .3s'; el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, ms);
    }

    function fmtSize(b) {
      if (b < 1024) return b + ' B';
      if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
      return (b / 1048576).toFixed(1) + ' MB';
    }

    function showLoading(v) {
      loadingOverlay.classList.toggle('hidden', !v);
      loadingOverlay.classList.toggle('flex', v);
    }

    /* ── scene setup ── */
    function initScene() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x09090b);

      camera = new THREE.PerspectiveCamera(45, viewport.clientWidth / viewport.clientHeight, 0.01, 10000);
      camera.position.set(5, 4, 5);

      renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
      renderer.setSize(viewport.clientWidth, viewport.clientHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.0;
      viewport.insertBefore(renderer.domElement, viewport.firstChild);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.08;
      controls.minDistance = 0.01;
      controls.maxDistance = 5000;

      // lights
      scene.add(new THREE.AmbientLight(0xffffff, 0.5));
      const d1 = new THREE.DirectionalLight(0xffffff, 0.9);
      d1.position.set(5, 8, 5);
      d1.castShadow = true;
      d1.shadow.mapSize.set(2048, 2048);
      scene.add(d1);
      const d2 = new THREE.DirectionalLight(0xffffff, 0.35);
      d2.position.set(-4, 3, -6);
      scene.add(d2);
      scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 0.25));

      // grid
      gridHelper = new THREE.GridHelper(100, 100, 0x3f3f46, 0x222228);
      scene.add(gridHelper);

      // axes
      axesHelper = new THREE.AxesHelper(3);
      scene.add(axesHelper);

      // default material
      defaultMat = new THREE.MeshStandardMaterial({
        color: 0xa0a0a8,
        roughness: 0.5,
        metalness: 0.15,
        flatShading: false,
        side: THREE.DoubleSide
      });
    }

    /* ── file handling ── */
    function handleFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      if (!['stl', '3mf'].includes(ext)) { toast('Unsupported format — use .stl or .3mf', 'error'); return; }
      showLoading(true);
      const reader = new FileReader();
      reader.onload = e => {
        try {
          if (ext === 'stl') loadSTL(e.target.result, file);
          else load3MF(e.target.result, file);
        } catch (err) {
          console.error(err);
          toast('Parse error: ' + err.message, 'error', 5000);
          showLoading(false);
        }
      };
      reader.onerror = () => { toast('Failed to read file', 'error'); showLoading(false); };
      reader.readAsArrayBuffer(file);
    }

    function loadSTL(buf, file) {
      const geom = new STLLoader().parse(buf);
      if (!geom.attributes.normal) geom.computeVertexNormals();

      clearModel();
      const mesh = new THREE.Mesh(geom, defaultMat.clone());
      mesh.castShadow = true;
      mesh.receiveShadow = true;

      const group = new THREE.Group();
      group.add(mesh);
      currentModel = group;
      modelMeshes = [mesh];
      scene.add(currentModel);

      fitToView();
      updateInfoSTL(file, geom);
      onModelLoaded(file);
    }

    function load3MF(buf, file) {
      const loader = new ThreeMFLoader();
      let object;
      try { object = loader.parse(buf); }
      catch (err) {
        console.error('3MF parse error:', err);
        toast('Could not parse 3MF — ' + err.message, 'error', 5000);
        showLoading(false);
        return;
      }

      clearModel();
      currentModel = object;
      modelMeshes = [];
      let totalVerts = 0, totalTris = 0;

      object.traverse(child => {
        if (!child.isMesh) return;
        modelMeshes.push(child);
        child.castShadow = true;
        child.receiveShadow = true;

        // apply default material if the mesh has none or plain white
        const mat = child.material;
        const isPlain = mat && !Array.isArray(mat) && mat.isMeshPhongMaterial && mat.color.getHex() === 0xffffff;
        if (!mat || isPlain) child.material = defaultMat.clone();
        if (Array.isArray(mat)) mat.forEach(m => { m.side = THREE.DoubleSide; });
        else if (child.material) child.material.side = THREE.DoubleSide;

        const g = child.geometry;
        if (g) {
          if (!g.attributes.normal) g.computeVertexNormals();
          if (g.attributes.position) totalVerts += g.attributes.position.count;
          totalTris += g.index ? g.index.count / 3 : (g.attributes.position?.count || 0) / 3;
        }
      });

      scene.add(currentModel);
      fitToView();
      updateInfo3MF(file, totalVerts, totalTris, modelMeshes.length);
      onModelLoaded(file);
    }

    function onModelLoaded(file) {
      showLoading(false);
      emptyState.classList.add('hidden');
      controlsHint.classList.remove('hidden');
      fileBadge.textContent = file.name;
      fileBadge.classList.remove('hidden');
      // sync material UI state
      applyCurrentMaterialSettings();
      toast('Loaded ' + file.name, 'success');
    }

    function clearModel() {
      if (!currentModel) return;
      scene.remove(currentModel);
      currentModel.traverse(c => {
        if (c.geometry) c.geometry.dispose();
        if (c.material) {
          (Array.isArray(c.material) ? c.material : [c.material]).forEach(m => m.dispose());
        }
      });
      currentModel = null;
      modelMeshes = [];
    }

    /* ── model processing ── */
    function fitToView() {
      if (!currentModel) return;
      const box = new THREE.Box3().setFromObject(currentModel);
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z) || 1;

      // center & sit on grid
      currentModel.position.sub(center);
      currentModel.position.y += size.y / 2;

      const fov = camera.fov * Math.PI / 180;
      const dist = maxDim / (2 * Math.tan(fov / 2)) * 2.0;

      camera.position.set(dist * 0.7, dist * 0.5, dist * 0.7);
      controls.target.set(0, size.y * 0.3, 0);
      camera.near = dist * 0.0005;
      camera.far  = dist * 100;
      camera.updateProjectionMatrix();
      controls.update();

      // rebuild grid
      const gs = Math.max(maxDim * 4, 10);
      scene.remove(gridHelper);
      gridHelper = new THREE.GridHelper(gs, Math.min(Math.round(gs), 200), 0x3f3f46, 0x222228);
      gridHelper.visible = chkGrid.checked;
      scene.add(gridHelper);

      scene.remove(axesHelper);
      axesHelper = new THREE.AxesHelper(maxDim * 0.4);
      axesHelper.visible = chkAxes.checked;
      scene.add(axesHelper);
    }

    /* ── info panels ── */
    function infoRow(label, value) {
      return `<div class="flex justify-between gap-2"><span class="text-zinc-500 shrink-0">${label}</span><span class="text-zinc-300 text-right truncate">${value}</span></div>`;
    }

    function updateInfoSTL(file, geom) {
      const box = new THREE.Box3().setFromObject(currentModel);
      const s = box.getSize(new THREE.Vector3());
      const verts = geom.attributes.position.count;
      const tris = geom.index ? geom.index.count / 3 : verts / 3;
      const vol = calcVolume(geom);

      modelInfo.innerHTML = `<div class="space-y-1.5">
        ${infoRow('File', file.name)}
        ${infoRow('Size', fmtSize(file.size))}
        ${infoRow('Format', '<span class="text-xs px-1.5 py-0.5 bg-amber-500/10 text-amber-400 rounded">STL</span>')}
        <hr class="border-zinc-800 !my-2">
        ${infoRow('Dimensions', `${s.x.toFixed(2)} × ${s.y.toFixed(2)} × ${s.z.toFixed(2)}`)}
        ${infoRow('Vertices', verts.toLocaleString())}
        ${infoRow('Triangles', Math.round(tris).toLocaleString())}
        ${vol !== null ? infoRow('Volume', vol.toFixed(1) + ' u³') : ''}
      </div>`;
    }

    function updateInfo3MF(file, verts, tris, parts) {
      const box = new THREE.Box3().setFromObject(currentModel);
      const s = box.getSize(new THREE.Vector3());
      modelInfo.innerHTML = `<div class="space-y-1.5">
        ${infoRow('File', file.name)}
        ${infoRow('Size', fmtSize(file.size))}
        ${infoRow('Format', '<span class="text-xs px-1.5 py-0.5 bg-amber-500/10 text-amber-400 rounded">3MF</span>')}
        ${infoRow('Parts', parts.toString())}
        <hr class="border-zinc-800 !my-2">
        ${infoRow('Dimensions', `${s.x.toFixed(2)} × ${s.y.toFixed(2)} × ${s.z.toFixed(2)}`)}
        ${infoRow('Vertices', verts.toLocaleString())}
        ${infoRow('Triangles', Math.round(tris).toLocaleString())}
      </div>`;
    }

    function calcVolume(geom) {
      try {
        const pos = geom.attributes.position;
        const idx = geom.index;
        let vol = 0;
        const a = new THREE.Vector3(), b = new THREE.Vector3(), c = new THREE.Vector3(), cross = new THREE.Vector3();
        const count = idx ? idx.count : pos.count;
        for (let i = 0; i < count; i += 3) {
          const i0 = idx ? idx.getX(i) : i, i1 = idx ? idx.getX(i+1) : i+1, i2 = idx ? idx.getX(i+2) : i+2;
          a.fromBufferAttribute(pos, i0);
          b.fromBufferAttribute(pos, i1);
          c.fromBufferAttribute(pos, i2);
          cross.crossVectors(b, c);
          vol += a.dot(cross) / 6;
        }
        return Math.abs(vol);
      } catch { return null; }
    }

    /* ── material controls ── */
    function forEachMat(fn) {
      modelMeshes.forEach(m => {
        (Array.isArray(m.material) ? m.material : [m.material]).forEach(fn);
      });
    }

    function applyCurrentMaterialSettings() {
      forEachMat(m => {
        m.wireframe = chkWire.checked;
        m.flatShading = chkFlat.checked;
        m.needsUpdate = true;
      });
    }

    /* ── event wiring ── */
    // file open
    $('btn-open').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => { if (fileInput.files[0]) { handleFile(fileInput.files[0]); fileInput.value = ''; } });

    // drag & drop
    let dragN = 0;
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', e => e.preventDefault());
    viewport.addEventListener('dragenter', e => { e.preventDefault(); dragN++; dragOverlay.classList.remove('hidden'); dragOverlay.classList.add('flex'); });
    viewport.addEventListener('dragover',  e => e.preventDefault());
    viewport.addEventListener('dragleave', e => { e.preventDefault(); if (--dragN <= 0) { dragN = 0; dragOverlay.classList.add('hidden'); dragOverlay.classList.remove('flex'); } });
    viewport.addEventListener('drop', e => {
      e.preventDefault(); dragN = 0;
      dragOverlay.classList.add('hidden'); dragOverlay.classList.remove('flex');
      if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });

    // toggles
    chkGrid.addEventListener('change',   () => { gridHelper.visible = chkGrid.checked; });
    chkAxes.addEventListener('change',   () => { axesHelper.visible = chkAxes.checked; });
    chkWire.addEventListener('change',   () => forEachMat(m => { m.wireframe = chkWire.checked; }));
    chkRotate.addEventListener('change', () => { controls.autoRotate = chkRotate.checked; controls.autoRotateSpeed = 2; });
    chkFlat.addEventListener('change',   () => forEachMat(m => { m.flatShading = chkFlat.checked; m.needsUpdate = true; }));

    // color swatches
    document.querySelectorAll('.clr-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.clr-btn').forEach(b => b.classList.replace('border-amber-500', 'border-zinc-700'));
        btn.classList.replace('border-zinc-700', 'border-amber-500');
        const col = new THREE.Color(btn.dataset.color);
        forEachMat(m => { m.color.copy(col); });
      });
    });
    // select first swatch
    document.querySelector('.clr-btn')?.classList.replace('border-zinc-700', 'border-amber-500');

    // sliders
    sldRough.addEventListener('input', () => { const v = sldRough.value / 100; $('val-rough').textContent = v.toFixed(2); forEachMat(m => { if (m.roughness !== undefined) m.roughness = v; }); });
    sldMetal.addEventListener('input', () => { const v = sldMetal.value / 100; $('val-metal').textContent = v.toFixed(2); forEachMat(m => { if (m.metalness !== undefined) m.metalness = v; }); });

    // buttons
    $('btn-reset').addEventListener('click', () => { camera.position.set(5, 4, 5); controls.target.set(0, 0, 0); controls.update(); if (currentModel) fitToView(); });
    $('btn-fit').addEventListener('click', fitToView);

    $('btn-screenshot').addEventListener('click', () => {
      renderer.render(scene, camera);
      const a = document.createElement('a');
      a.href = renderer.domElement.toDataURL('image/png');
      a.download = `model-${Date.now()}.png`;
      a.click();
      toast('Screenshot saved', 'success');
    });

    $('btn-panel').addEventListener('click', togglePanel);
    function togglePanel() {
      const hidden = panel.style.display === 'none';
      panel.style.display = hidden ? '' : 'none';
      onResize();
    }

    // keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
      const k = e.key.toLowerCase();
      // Tab switching: 1 = Viewer, 2 = Filaments
      if (k === '1') { if (window._filamentSwitchTab) window._filamentSwitchTab('viewer'); return; }
      if (k === '2') { if (window._filamentSwitchTab) window._filamentSwitchTab('filaments'); return; }
      // Viewer-only shortcuts
      if (viewFilamentsVisible()) return;
      if (k === 'r') { $('btn-reset').click(); }
      else if (k === 'f') { fitToView(); }
      else if (k === 'w') { chkWire.checked = !chkWire.checked; chkWire.dispatchEvent(new Event('change')); }
      else if (k === 'g') { chkGrid.checked = !chkGrid.checked; chkGrid.dispatchEvent(new Event('change')); }
      else if (k === 'a') { chkAxes.checked = !chkAxes.checked; chkAxes.dispatchEvent(new Event('change')); }
      else if (k === ' ') { e.preventDefault(); chkRotate.checked = !chkRotate.checked; chkRotate.dispatchEvent(new Event('change')); }
      else if (k === 's' && !e.ctrlKey && !e.metaKey) { $('btn-screenshot').click(); }
      else if (k === 'p') { togglePanel(); }
    });

    function viewFilamentsVisible() {
      return !document.getElementById('view-filaments')?.classList.contains('hidden');
    }

    // resize
    function onResize() {
      const w = viewport.clientWidth, h = viewport.clientHeight;
      if (w === 0 || h === 0) return;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    }
    window.addEventListener('resize', onResize);
    new ResizeObserver(onResize).observe(viewport);

    // PWA install
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault(); deferredPrompt = e;
      $('btn-install').classList.remove('hidden');
    });
    $('btn-install').addEventListener('click', () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(r => {
        if (r.outcome === 'accepted') toast('App installed!', 'success');
        deferredPrompt = null;
        $('btn-install').classList.add('hidden');
      });
    });

    /* ── animation loop ── */
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
      frameCount++;
      const now = performance.now();
      if (now - fpsTime >= 1000) {
        lastFps = Math.round(frameCount * 1000 / (now - fpsTime));
        fpsOverlay.textContent = lastFps + ' FPS';
        frameCount = 0;
        fpsTime = now;
      }
    }

    /* ── init ── */
    initScene();
    animate();
    if (window.innerWidth < 768) panel.style.display = 'none';

    // handle PWA file handler launch
    if ('launchQueue' in window) {
      window.launchQueue.setConsumer(async launchParams => {
        if (launchParams.files?.length) {
          const fh = launchParams.files[0];
          const file = await fh.getFile();
          handleFile(file);
        }
      });
    }
  </script>

  <!-- ===== FILAMENT INVENTORY APP ===== -->
  <script>
  (function() {
    'use strict';

    const $ = id => document.getElementById(id);

    /* ── Material metadata ── */
    const MATERIAL_META = {
      'PLA':       { css: 'mat-pla',      tempNozzle: 210, tempBed: 60 },
      'PLA+':      { css: 'mat-pla-plus', tempNozzle: 215, tempBed: 60 },
      'PLA Silk':  { css: 'mat-silk',     tempNozzle: 215, tempBed: 60 },
      'ABS':       { css: 'mat-abs',      tempNozzle: 240, tempBed: 100 },
      'PETG':      { css: 'mat-petg',     tempNozzle: 230, tempBed: 80 },
      'TPU':       { css: 'mat-tpu',      tempNozzle: 220, tempBed: 50 },
      'Nylon':     { css: 'mat-nylon',    tempNozzle: 260, tempBed: 80 },
      'ASA':       { css: 'mat-asa',      tempNozzle: 250, tempBed: 100 },
      'PC':        { css: 'mat-pc',       tempNozzle: 270, tempBed: 110 },
      'HIPS':      { css: 'mat-hips',     tempNozzle: 230, tempBed: 100 },
      'PVA':       { css: 'mat-pva',      tempNozzle: 190, tempBed: 45 },
      'PP':        { css: 'mat-pp',       tempNozzle: 230, tempBed: 85 },
      'PEI':       { css: 'mat-other',    tempNozzle: 370, tempBed: 160 },
      'PEEK':      { css: 'mat-other',    tempNozzle: 400, tempBed: 160 },
      'PEKK':      { css: 'mat-other',    tempNozzle: 360, tempBed: 150 },
      'CF-PLA':    { css: 'mat-cf',       tempNozzle: 220, tempBed: 60 },
      'CF-PETG':   { css: 'mat-cf',       tempNozzle: 240, tempBed: 80 },
      'CF-Nylon':  { css: 'mat-cf',       tempNozzle: 270, tempBed: 80 },
      'CF-ABS':    { css: 'mat-cf',       tempNozzle: 250, tempBed: 100 },
      'CF-PC':     { css: 'mat-cf',       tempNozzle: 280, tempBed: 110 },
      'GF-Nylon':  { css: 'mat-cf',       tempNozzle: 265, tempBed: 80 },
      'GF-PP':     { css: 'mat-cf',       tempNozzle: 240, tempBed: 85 },
      'Wood':      { css: 'mat-wood',     tempNozzle: 200, tempBed: 60 },
      'Metal':     { css: 'mat-metal',    tempNozzle: 210, tempBed: 60 },
      'Marble':    { css: 'mat-other',    tempNozzle: 210, tempBed: 60 },
      'Glow':      { css: 'mat-other',    tempNozzle: 210, tempBed: 60 },
      'HTPLA':     { css: 'mat-pla',      tempNozzle: 215, tempBed: 60 },
      'PHA':       { css: 'mat-pla',      tempNozzle: 200, tempBed: 55 },
      'Standard Resin':       { css: 'mat-other', tempNozzle: 0, tempBed: 0 },
      'Tough Resin':          { css: 'mat-other', tempNozzle: 0, tempBed: 0 },
      'Flexible Resin':       { css: 'mat-tpu',   tempNozzle: 0, tempBed: 0 },
      'Water-Washable Resin': { css: 'mat-pva',   tempNozzle: 0, tempBed: 0 },
      'ABS-Like Resin':       { css: 'mat-abs',   tempNozzle: 0, tempBed: 0 },
      'Castable Resin':       { css: 'mat-other', tempNozzle: 0, tempBed: 0 },
      'Dental Resin':         { css: 'mat-other', tempNozzle: 0, tempBed: 0 },
      'Other':     { css: 'mat-other',    tempNozzle: 200, tempBed: 60 },
    };

    function matCSS(mat) { return (MATERIAL_META[mat] || MATERIAL_META['Other']).css; }

    /* ── State ── */
    const STORAGE_KEY = 'filament-inventory';
    let filaments = [];
    let activeFilter = 'all';
    let searchQuery = '';
    let deleteTarget = null;

    function loadFilaments() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        filaments = raw ? JSON.parse(raw) : [];
      } catch { filaments = []; }
    }

    function saveFilaments() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(filaments));
    }

    /* ── Tab switching ── */
    const tabViewer    = $('tab-viewer');
    const tabFilaments = $('tab-filaments');
    const viewViewer   = $('view-viewer');
    const viewFilamentsEl = $('view-filaments');
    const btnOpen      = $('btn-open');
    const btnScreenshot = $('btn-screenshot');
    const btnPanel     = $('btn-panel');

    function switchTab(tab) {
      if (tab === 'viewer') {
        tabViewer.classList.add('active', 'text-amber-400');
        tabViewer.classList.remove('text-zinc-500');
        tabFilaments.classList.remove('active', 'text-amber-400');
        tabFilaments.classList.add('text-zinc-500');
        viewViewer.classList.remove('hidden');
        viewViewer.classList.add('flex');
        viewFilamentsEl.classList.add('hidden');
        btnOpen.classList.remove('hidden');
        btnScreenshot.classList.remove('hidden');
        btnPanel.classList.remove('hidden');
        window.dispatchEvent(new Event('resize'));
      } else {
        tabFilaments.classList.add('active', 'text-amber-400');
        tabFilaments.classList.remove('text-zinc-500');
        tabViewer.classList.remove('active', 'text-amber-400');
        tabViewer.classList.add('text-zinc-500');
        viewViewer.classList.add('hidden');
        viewViewer.classList.remove('flex');
        viewFilamentsEl.classList.remove('hidden');
        btnOpen.classList.add('hidden');
        btnScreenshot.classList.add('hidden');
        btnPanel.classList.add('hidden');
        renderInventory();
      }
    }

    tabViewer.addEventListener('click', () => switchTab('viewer'));
    tabFilaments.addEventListener('click', () => switchTab('filaments'));

    /* ── Rendering ── */
    function getFiltered() {
      let list = filaments;
      if (activeFilter !== 'all') {
        list = list.filter(f => f.material === activeFilter);
      }
      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        list = list.filter(f =>
          (f.colorName || '').toLowerCase().includes(q) ||
          f.material.toLowerCase().includes(q) ||
          (f.brand || '').toLowerCase().includes(q) ||
          f.color.toLowerCase().includes(q) ||
          (f.notes || '').toLowerCase().includes(q)
        );
      }
      return list;
    }

    function renderInventory() {
      renderStats();
      renderColorPalette();
      renderMaterialBreakdown();
      renderFilterButtons();
      renderGrid();
    }

    function renderStats() {
      $('stat-total').textContent = filaments.length;
      const mats = new Set(filaments.map(f => f.material));
      $('stat-materials').textContent = mats.size;
      const totalG = filaments.reduce((s, f) => s + (f.weight || 0) * (f.remaining || 100) / 100, 0);
      $('stat-weight').textContent = totalG >= 1000 ? (totalG / 1000).toFixed(1) + ' kg' : Math.round(totalG) + ' g';
      const colors = new Set(filaments.map(f => f.color));
      $('stat-colors').textContent = colors.size;
    }

    function renderColorPalette() {
      const el = $('color-palette');
      if (!filaments.length) {
        el.innerHTML = '<p class="text-xs text-zinc-600 font-mono italic">No filaments yet</p>';
        return;
      }
      // Group by color, sort by hue
      const colorMap = {};
      filaments.forEach(f => {
        if (!colorMap[f.color]) colorMap[f.color] = { color: f.color, name: f.colorName, count: 0 };
        colorMap[f.color].count++;
      });
      const colors = Object.values(colorMap).sort((a, b) => hue(a.color) - hue(b.color));
      el.innerHTML = colors.map(c =>
        `<div class="group relative">
          <div class="w-8 h-8 rounded-lg border-2 border-zinc-700 cursor-default transition-transform hover:scale-110" style="background:${c.color}" title="${c.name || c.color} (${c.count})"></div>
          <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-[10px] font-mono text-zinc-300 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
            ${c.name || c.color} <span class="text-zinc-500">×${c.count}</span>
          </div>
        </div>`
      ).join('');
    }

    function hue(hex) {
      const r = parseInt(hex.slice(1,3),16)/255, g = parseInt(hex.slice(3,5),16)/255, b = parseInt(hex.slice(5,7),16)/255;
      const max = Math.max(r,g,b), min = Math.min(r,g,b), d = max - min;
      if (d === 0) return 0;
      let h;
      if (max === r) h = ((g - b) / d) % 6;
      else if (max === g) h = (b - r) / d + 2;
      else h = (r - g) / d + 4;
      return ((h * 60) + 360) % 360;
    }

    function renderMaterialBreakdown() {
      const el = $('material-breakdown');
      if (!filaments.length) {
        el.innerHTML = '<p class="text-xs text-zinc-600 font-mono italic">No filaments yet</p>';
        return;
      }
      const counts = {};
      filaments.forEach(f => { counts[f.material] = (counts[f.material] || 0) + 1; });
      const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
      const max = sorted[0][1];
      el.innerHTML = sorted.map(([mat, count]) => {
        const pct = Math.round(count / filaments.length * 100);
        const css = matCSS(mat);
        return `<div class="flex items-center gap-3">
          <span class="text-[11px] font-mono w-20 text-zinc-400 shrink-0">${mat}</span>
          <div class="flex-1 bg-zinc-800 rounded-full h-2 overflow-hidden">
            <div class="weight-bar h-full rounded-full ${css}" style="width:${(count/max)*100}%; opacity:0.7"></div>
          </div>
          <span class="text-[10px] font-mono text-zinc-500 w-14 text-right">${count} · ${pct}%</span>
        </div>`;
      }).join('');
    }

    function renderFilterButtons() {
      const mats = [...new Set(filaments.map(f => f.material))].sort();
      const container = $('filter-buttons');
      container.innerHTML = mats.map(m => {
        const isActive = activeFilter === m;
        const css = matCSS(m);
        return `<button data-filter="${m}" class="filter-btn ${isActive ? css : 'bg-zinc-800 text-zinc-400 border-zinc-700'} text-[11px] font-mono px-3 py-1.5 rounded-lg border transition-colors hover:border-zinc-600">${m}</button>`;
      }).join('');

      // Update "All" button
      const allBtn = document.querySelector('[data-filter="all"]');
      if (activeFilter === 'all') {
        allBtn.className = 'filter-btn active bg-amber-500/10 text-amber-400 text-[11px] font-mono px-3 py-1.5 rounded-lg border border-amber-500/20 transition-colors';
      } else {
        allBtn.className = 'filter-btn bg-zinc-800 text-zinc-400 text-[11px] font-mono px-3 py-1.5 rounded-lg border border-zinc-700 transition-colors hover:border-zinc-600';
      }

      // Wire filter clicks
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          activeFilter = btn.dataset.filter;
          renderFilterButtons();
          renderGrid();
        });
      });
    }

    function remainingColor(pct) {
      if (pct > 50) return 'text-green-400';
      if (pct > 20) return 'text-amber-400';
      return 'text-red-400';
    }

    function remainingBarColor(pct) {
      if (pct > 50) return 'bg-green-500';
      if (pct > 20) return 'bg-amber-500';
      return 'bg-red-500';
    }

    function renderGrid() {
      const grid = $('filament-grid');
      const empty = $('filament-empty');
      const filtered = getFiltered();

      if (!filtered.length) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      grid.innerHTML = filtered.map(f => {
        const css = matCSS(f.material);
        const rem = f.remaining || 100;
        const weightG = (f.weight || 0) * rem / 100;
        const isResin = f.material.includes('Resin');
        return `<div class="spool-card bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden" data-id="${f.id}">
          <!-- Color band -->
          <div class="h-2 w-full" style="background:${f.color}"></div>
          <div class="p-4">
            <div class="flex items-start gap-3 mb-3">
              <!-- Spool visualization -->
              <div class="spool-ring w-14 h-14 flex-shrink-0 border-4" style="background:${f.color}; border-color:${f.color}"></div>
              <div class="flex-1 min-w-0">
                <h4 class="font-mono font-bold text-sm text-zinc-100 truncate">${f.colorName || f.color}</h4>
                <div class="flex items-center gap-2 mt-1">
                  <span class="${css} text-[10px] font-mono px-1.5 py-0.5 rounded">${f.material}</span>
                  ${f.brand ? `<span class="text-[10px] font-mono text-zinc-500 truncate">${f.brand}</span>` : ''}
                </div>
              </div>
            </div>

            <!-- Details -->
            <div class="space-y-1.5 text-[11px] font-mono mb-3">
              ${!isResin && f.diameter ? `<div class="flex justify-between"><span class="text-zinc-500">Diameter</span><span class="text-zinc-400">${f.diameter} mm</span></div>` : ''}
              ${f.weight ? `<div class="flex justify-between"><span class="text-zinc-500">${isResin ? 'Volume' : 'Weight'}</span><span class="text-zinc-400">${f.weight}${isResin ? ' ml' : ' g'}</span></div>` : ''}
              ${f.tempNozzle && !isResin ? `<div class="flex justify-between"><span class="text-zinc-500">Nozzle</span><span class="text-zinc-400">${f.tempNozzle}°C</span></div>` : ''}
              ${f.tempBed && !isResin ? `<div class="flex justify-between"><span class="text-zinc-500">Bed</span><span class="text-zinc-400">${f.tempBed}°C</span></div>` : ''}
            </div>

            <!-- Remaining bar -->
            <div class="mb-3">
              <div class="flex justify-between mb-1">
                <span class="text-[10px] font-mono text-zinc-500">Remaining</span>
                <span class="text-[10px] font-mono ${remainingColor(rem)}">${rem}%${f.weight ? ' · ' + Math.round(weightG) + (isResin ? ' ml' : ' g') : ''}</span>
              </div>
              <div class="w-full bg-zinc-800 rounded-full h-1.5">
                <div class="weight-bar h-full rounded-full ${remainingBarColor(rem)}" style="width:${rem}%"></div>
              </div>
            </div>

            ${f.notes ? `<p class="text-[10px] font-mono text-zinc-600 italic truncate mb-3" title="${f.notes}">${f.notes}</p>` : ''}

            <!-- Actions -->
            <div class="flex gap-2">
              <button class="btn-edit-filament flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 text-[11px] font-mono px-2 py-1.5 rounded-lg transition-colors flex items-center justify-center gap-1" data-id="${f.id}">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Edit
              </button>
              <button class="btn-del-filament flex-1 bg-zinc-800 hover:bg-red-500/20 text-zinc-400 hover:text-red-400 text-[11px] font-mono px-2 py-1.5 rounded-lg transition-colors flex items-center justify-center gap-1" data-id="${f.id}">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                Delete
              </button>
            </div>
          </div>
        </div>`;
      }).join('');

      // Wire card actions
      grid.querySelectorAll('.btn-edit-filament').forEach(btn => {
        btn.addEventListener('click', () => openEditModal(btn.dataset.id));
      });
      grid.querySelectorAll('.btn-del-filament').forEach(btn => {
        btn.addEventListener('click', () => openDeleteModal(btn.dataset.id));
      });
    }

    /* ── Modal ── */
    const modal = $('filament-modal');
    const form = $('filament-form');
    const colorInput = $('ff-color');
    const colorPreview = $('ff-color-preview');

    colorInput.addEventListener('input', () => {
      colorPreview.style.background = colorInput.value;
    });

    function openAddModal() {
      $('modal-title').textContent = 'Add Filament';
      $('ff-id').value = '';
      form.reset();
      colorPreview.style.background = '#a0a0a8';
      colorInput.value = '#a0a0a8';
      $('ff-remaining').value = '100';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      $('ff-color-name').focus();
    }

    function openEditModal(id) {
      const f = filaments.find(x => x.id === id);
      if (!f) return;
      $('modal-title').textContent = 'Edit Filament';
      $('ff-id').value = f.id;
      colorInput.value = f.color;
      colorPreview.style.background = f.color;
      $('ff-color-name').value = f.colorName || '';
      $('ff-material').value = f.material;
      $('ff-brand').value = f.brand || '';
      const diamRadios = document.querySelectorAll('[name="ff-diameter"]');
      diamRadios.forEach(r => { r.checked = r.value === String(f.diameter || 1.75); });
      $('ff-weight').value = f.weight || '';
      $('ff-remaining').value = f.remaining ?? 100;
      $('ff-temp-nozzle').value = f.tempNozzle || '';
      $('ff-temp-bed').value = f.tempBed || '';
      $('ff-notes').value = f.notes || '';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    $('btn-add-filament').addEventListener('click', openAddModal);
    $('btn-modal-close').addEventListener('click', closeModal);
    $('btn-modal-cancel').addEventListener('click', closeModal);

    // Close modal on backdrop click
    modal.addEventListener('click', e => {
      if (e.target === modal) closeModal();
    });

    // Auto-fill temps when material changes
    $('ff-material').addEventListener('change', () => {
      const mat = $('ff-material').value;
      const meta = MATERIAL_META[mat];
      if (meta && !$('ff-temp-nozzle').value) $('ff-temp-nozzle').value = meta.tempNozzle || '';
      if (meta && !$('ff-temp-bed').value) $('ff-temp-bed').value = meta.tempBed || '';
      // Switch diameter to resin if needed
      if (mat.includes('Resin')) {
        document.querySelectorAll('[name="ff-diameter"]').forEach(r => { r.checked = r.value === '0'; });
      }
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      const id = $('ff-id').value || crypto.randomUUID();
      const diameterRadio = document.querySelector('[name="ff-diameter"]:checked');
      const entry = {
        id,
        color: colorInput.value,
        colorName: $('ff-color-name').value.trim(),
        material: $('ff-material').value,
        brand: $('ff-brand').value.trim(),
        diameter: parseFloat(diameterRadio?.value || '1.75'),
        weight: parseInt($('ff-weight').value) || 0,
        remaining: Math.min(100, Math.max(0, parseInt($('ff-remaining').value) || 100)),
        tempNozzle: parseInt($('ff-temp-nozzle').value) || 0,
        tempBed: parseInt($('ff-temp-bed').value) || 0,
        notes: $('ff-notes').value.trim(),
        updatedAt: Date.now(),
      };

      const existing = filaments.findIndex(f => f.id === id);
      if (existing >= 0) {
        entry.createdAt = filaments[existing].createdAt;
        filaments[existing] = entry;
      } else {
        entry.createdAt = Date.now();
        filaments.unshift(entry);
      }

      saveFilaments();
      closeModal();
      renderInventory();

      // Toast from the outer scope
      const toastsEl = $('toasts');
      const el = document.createElement('div');
      el.className = 'toast-enter border-green-500/50 border bg-zinc-900 rounded-lg px-4 py-2 text-xs font-mono text-zinc-300 shadow-lg max-w-xs';
      el.textContent = existing >= 0 ? 'Filament updated' : 'Filament added';
      toastsEl.appendChild(el);
      setTimeout(() => { el.style.transition = 'opacity .3s'; el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
    });

    /* ── Delete ── */
    const delModal = $('delete-modal');

    function openDeleteModal(id) {
      deleteTarget = id;
      delModal.classList.remove('hidden');
      delModal.classList.add('flex');
    }

    function closeDeleteModal() {
      delModal.classList.add('hidden');
      delModal.classList.remove('flex');
      deleteTarget = null;
    }

    $('btn-confirm-delete').addEventListener('click', () => {
      if (deleteTarget) {
        filaments = filaments.filter(f => f.id !== deleteTarget);
        saveFilaments();
        renderInventory();

        const toastsEl = $('toasts');
        const el = document.createElement('div');
        el.className = 'toast-enter border-red-500/50 border bg-zinc-900 rounded-lg px-4 py-2 text-xs font-mono text-zinc-300 shadow-lg max-w-xs';
        el.textContent = 'Filament removed';
        toastsEl.appendChild(el);
        setTimeout(() => { el.style.transition = 'opacity .3s'; el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
      }
      closeDeleteModal();
    });
    $('btn-cancel-delete').addEventListener('click', closeDeleteModal);
    delModal.addEventListener('click', e => { if (e.target === delModal) closeDeleteModal(); });

    /* ── Search ── */
    $('filament-search').addEventListener('input', e => {
      searchQuery = e.target.value;
      renderGrid();
    });

    /* ── Init ── */
    loadFilaments();

    // Expose switchTab for keyboard shortcut
    window._filamentSwitchTab = switchTab;
  })();
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
